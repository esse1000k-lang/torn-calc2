<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#0a0a0b">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>íšŒì› ì •ë³´ | TornFi</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="manifest" href="/manifest.json">
  <script src="js/pwa-env.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/site.css">
  <style>
    .profile-page { max-width: 480px; margin: 0 auto; padding: 0 1rem 2rem; }
    .profile-hero { margin-top: 0.5rem; border-radius: 12px 12px 0 0; height: 100px; position: relative; background: linear-gradient(110deg, rgba(0, 255, 136, 0.08) 0%, rgba(0, 204, 106, 0.14) 40%, rgba(0, 255, 136, 0.1) 70%, rgba(0, 204, 106, 0.06) 100%); background-size: 200% 100%; animation: profile-hero-shine 8s ease-in-out infinite; }
    @keyframes profile-hero-shine { 0%, 100% { background-position: 100% 0; } 50% { background-position: 0% 0; } }
    .profile-avatar-area { text-align: center; margin-top: -48px; margin-bottom: 0; }
    .profile-avatar-wrap { display: inline-flex; justify-content: center; align-items: center; position: relative; z-index: 1; cursor: pointer; border-radius: 50%; width: 96px; height: 96px; }
    .profile-avatar-wrap:hover .profile-avatar-edit-badge { background: rgba(0, 255, 136, 0.2); }
    .profile-avatar-wrap:hover .profile-avatar-edit-badge svg { stroke: var(--neon); }
    .profile-avatar { width: 96px; height: 96px; border-radius: 50%; object-fit: cover; border: 3px solid var(--bg-card); background: var(--bg-dark); box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: box-shadow 0.2s ease; }
    .profile-avatar-edit-badge { position: absolute; right: 2px; bottom: 2px; width: 24px; height: 24px; border-radius: 50%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; transition: background 0.2s; pointer-events: none; }
    .profile-avatar-edit-badge svg { width: 12px; height: 12px; stroke: #fff; stroke-width: 2; fill: none; stroke-linecap: round; }
    .profile-info-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: 0 0 12px 12px; margin-top: -48px; padding: 3.25rem 1.25rem 1rem 1.25rem; margin-bottom: 1.5rem; }
    .profile-info-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 0.75rem; margin-bottom: 0.25rem; }
    .profile-info-name { font-size: 1.35rem; font-weight: 700; color: var(--text); line-height: 1.3; }
    .profile-edit-btn { flex-shrink: 0; padding: 0.4rem 0.85rem; font-size: 0.8rem; background: transparent; color: var(--text-muted); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: border-color 0.2s, color 0.2s; }
    .profile-edit-btn:hover { border-color: var(--neon); color: var(--neon); }
    .profile-handle { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.75rem; }
    .profile-bio-text { font-size: 0.9rem; line-height: 1.5; color: var(--text); margin-bottom: 1rem; white-space: pre-wrap; word-break: break-word; }
    .profile-bio-text.empty { color: var(--text-muted); }
    .profile-meta { display: flex; flex-direction: column; gap: 0.5rem; }
    .profile-meta-row { display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; line-height: 1.4; color: var(--text); }
    .profile-meta-row .icon { flex-shrink: 0; width: 1.1rem; text-align: center; }
    .profile-meta-row .value { word-break: break-all; }
    .profile-meta-row .value.wallet { font-family: ui-monospace, monospace; font-size: 0.8rem; color: var(--text-muted); }
    .profile-edit-panel { margin-top: 1.5rem; padding: 1.25rem; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 10px; display: none; }
    .profile-edit-panel.is-open { display: block; }
    .profile-edit-section { margin-bottom: 1.25rem; padding-top: 0.75rem; }
    .profile-edit-section:first-of-type { padding-top: 0; }
    .profile-edit-section:last-of-type { margin-bottom: 0; }
    .profile-edit-label { font-size: 0.8rem; color: var(--text-muted); min-width: 4.5rem; flex-shrink: 0; }
    .profile-edit-section-title { font-size: 0.75rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.5rem; letter-spacing: 0.02em; }
    .profile-edit-section-desc { font-weight: 400; font-size: 0.75rem; color: var(--text-muted); opacity: 0.9; }
    .profile-bio-input { width: 100%; height: 4.5rem; padding: 0.5rem 0.6rem; margin-bottom: 0.5rem; background: var(--bg-dark); border: 1px solid rgba(0, 255, 136, 0.35); border-radius: 6px; color: var(--text); font-family: inherit; font-size: 0.875rem; resize: none; box-sizing: border-box; scrollbar-width: thin; scrollbar-color: var(--border) transparent; }
    .profile-bio-input:focus { outline: none; border-color: var(--neon); }
    .profile-bio-input::-webkit-scrollbar { width: 8px; }
    .profile-bio-input::-webkit-scrollbar-track { background: transparent; border-radius: 4px; }
    .profile-bio-input::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    .profile-bio-input::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
    .profile-bio-actions { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.25rem; }
    .profile-edit-btn { padding: 0.45rem 0.9rem; font-size: 0.8rem; font-weight: 500; background: var(--neon); color: var(--bg-dark); border: none; border-radius: 6px; cursor: pointer; }
    .profile-edit-btn:hover { background: var(--neon-dim); color: var(--text); }
    .profile-bio-feedback { font-size: 0.8rem; min-height: 1.1em; }
    .profile-edit-close { margin-top: 1rem; padding: 0.5rem; font-size: 0.8rem; background: transparent; color: var(--text-muted); border: none; cursor: pointer; width: 100%; border-radius: 6px; }
    .profile-edit-close:hover { background: rgba(255,255,255,0.04); color: var(--text); }
    .profile-edit-input { width: 100%; padding: 0.5rem 0.6rem; margin-bottom: 0.5rem; background: var(--bg-dark); border: 1px solid rgba(0, 255, 136, 0.35); border-radius: 6px; color: var(--text); font-family: inherit; font-size: 0.875rem; box-sizing: border-box; }
    .profile-edit-input:focus { outline: none; border-color: var(--neon); }
    .profile-edit-input::placeholder { color: var(--text-muted); opacity: 0.8; }
    .profile-label { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.25rem; }
    .profile-denied { text-align: center; padding: 3rem 1rem; color: var(--text-muted); }
    .profile-denied a { color: var(--neon); }
    .profile-success { font-size: 0.8rem; color: var(--neon); margin-top: 0.5rem; }
    .profile-error { font-size: 0.8rem; color: var(--danger); margin-top: 0.5rem; }
    .profile-bio-count { color: var(--text-muted); font-size: 0.75rem; margin-left: 0.25rem; }
    .profile-crop-overlay { position: fixed; inset: 0; z-index: 1000; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; padding: 1rem; }
    .profile-crop-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; max-width: 100%; }
    .profile-crop-box h3 { font-size: 1rem; color: var(--neon); margin-bottom: 1rem; }
    .profile-crop-viewport { width: 300px; height: 300px; overflow: hidden; position: relative; margin: 0 auto 1rem; border-radius: 50%; border: 2px solid var(--border); background: var(--bg-dark); cursor: move; touch-action: none; }
    .profile-crop-viewport img { display: block; position: absolute; pointer-events: none; }
    .profile-crop-actions { display: flex; gap: 0.5rem; justify-content: flex-end; }
    .profile-crop-actions button { width: auto; padding: 0.5rem 1rem; }
    .profile-crop-actions .profile-crop-cancel { background: var(--bg-dark); color: var(--text); border: 1px solid var(--border); }
    .profile-crop-actions .profile-crop-cancel:hover { border-color: var(--text-muted); }
    .profile-nickname-row { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; margin-top: 0.5rem; }
    .profile-nickname-msgs { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 0.2rem; justify-content: center; }
    .profile-nickname-msgs .profile-bio-feedback { margin: 0; font-size: 0.8rem; }
    .profile-nickname-validation.wallet-validation--ok { color: var(--neon); }
    .profile-nickname-validation.wallet-validation--err { color: var(--danger); }
    .profile-password-row { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; margin-top: 0.5rem; }
    .profile-wallet-row { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem; }
    .profile-password-match { font-size: 0.8rem; margin: 0; }
    .profile-password-match.is-ok { color: var(--neon); }
    .profile-password-match.is-err { color: var(--danger); }
    .profile-toast-overlay { position: fixed; inset: 0; z-index: 1001; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; padding: 1rem; }
    .profile-toast-overlay.is-open { display: flex; }
    .profile-toast-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem 1.5rem; min-width: 260px; max-width: 90vw; }
    .profile-toast-text { font-size: 0.9rem; color: var(--text); margin: 0 0 1rem 0; line-height: 1.45; }
    .profile-toast-actions { display: flex; justify-content: flex-end; }
    .profile-toast-btn { padding: 0.5rem 1.25rem; border-radius: 8px; font-size: 0.9rem; font-weight: 500; cursor: pointer; border: none; background: var(--neon); color: var(--bg-dark); }
    .profile-toast-btn:hover { background: var(--neon-dim); }
  </style>
</head>
<body>
  <nav class="site-nav">
    <div class="nav-brand">
      <a href="/" class="nav-logo">TornFi</a>
    </div>
    <a href="/admin.html" class="nav-admin-center" id="navAdminCenter" aria-label="ê´€ë¦¬ì" style="display:none;">ğŸ› ï¸</a>
    <div class="nav-menu-wrap">
      <button type="button" class="nav-menu-btn" id="navMenuBtn" aria-label="ë©”ë‰´" aria-expanded="false" aria-haspopup="true">â˜°</button>
      <div class="nav-menu-dropdown" id="navMenuDropdown" role="menu"></div>
    </div>
  </nav>

  <div id="profileCropModal" class="profile-crop-overlay" style="display:none;" aria-modal="true" aria-labelledby="profileCropTitle">
    <div class="profile-crop-box">
      <h3 id="profileCropTitle">í”„ë¡œí•„ ì‚¬ì§„ ì¡°ì •</h3>
      <p class="profile-label" style="margin-bottom:0.5rem;">ì‚¬ì§„ì„ ë“œë˜ê·¸í•´ì„œ ì›í•˜ëŠ” ì˜ì—­ì„ ë§ì¶° ì£¼ì„¸ìš”.</p>
      <div id="profileCropViewport" class="profile-crop-viewport">
        <img id="profileCropImg" src="" alt="">
      </div>
      <div class="profile-crop-actions">
        <button type="button" id="profileCropCancel" class="profile-photo-btn profile-crop-cancel">ì·¨ì†Œ</button>
        <button type="button" id="profileCropApply" class="profile-photo-btn">ì ìš©</button>
      </div>
    </div>
  </div>

  <div id="profileToastModal" class="profile-toast-overlay" role="alertdialog" aria-live="polite" aria-modal="true" style="display:none;">
    <div class="profile-toast-box">
      <p id="profileToastText" class="profile-toast-text"></p>
      <div class="profile-toast-actions">
        <button type="button" id="profileToastOk" class="profile-toast-btn">í™•ì¸</button>
      </div>
    </div>
  </div>

  <div id="profileDenied" class="profile-denied" style="display:none;">
    <p>ë¡œê·¸ì¸í•œ íšŒì›ë§Œ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    <a href="/login.html">ë¡œê·¸ì¸</a> Â· <a href="/">í™ˆìœ¼ë¡œ</a>
  </div>

  <div id="profilePage" class="profile-page" style="display:none;">
    <h1 style="font-size:1.25rem; margin-bottom:1rem; padding-top:0.5rem;">íšŒì› ì •ë³´</h1>

    <div class="profile-hero" aria-hidden="true"></div>
    <div class="profile-avatar-area">
      <div class="profile-avatar-wrap" id="profileAvatarWrap" role="button" tabindex="0" title="ì‚¬ì§„ ë³€ê²½" aria-label="í”„ë¡œí•„ ì‚¬ì§„ ë³€ê²½">
        <img id="profilePhoto" class="profile-avatar" src="" alt="í”„ë¡œí•„ ì‚¬ì§„" width="96" height="96">
        <span class="profile-avatar-edit-badge" aria-hidden="true" title="í´ë¦­í•˜ë©´ ì‚¬ì§„ì„ ë°”ê¿€ ìˆ˜ ìˆìŠµë‹ˆë‹¤">
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><rect x="2" y="6" width="20" height="14" rx="2" fill="none"/><circle cx="12" cy="12" r="3.5" fill="none"/><path d="M8 6V4h8v2" fill="none" stroke-linecap="round"/></svg>
        </span>
        <input type="file" id="profilePhotoInput" accept="image/jpeg,image/png,image/gif,image/webp" aria-hidden="true" style="display:none;">
      </div>
    </div>

    <div class="profile-info-box">
      <div class="profile-info-header">
        <h2 id="infoDisplayName" class="profile-info-name">â€”</h2>
        <button type="button" id="profileEditBtn" class="profile-edit-btn" aria-expanded="false">íšŒì› ì •ë³´ ìˆ˜ì •</button>
      </div>
      <p id="infoHandle" class="profile-handle">@â€”</p>
      <p id="infoBio" class="profile-bio-text empty">ìê¸°ì†Œê°œê°€ ì—†ìŠµë‹ˆë‹¤.</p>

      <div class="profile-meta">
        <div class="profile-meta-row"><span class="icon" aria-hidden="true">â¤ï¸</span><span id="infoHearts" class="value">0</span></div>
        <div class="profile-meta-row"><span class="icon" aria-hidden="true">ğŸ”—</span><span id="infoWallet" class="value wallet">â€”</span></div>
        <div class="profile-meta-row"><span id="infoLevelIcon" class="icon" aria-hidden="true">â€”</span><span id="infoLevel" class="value">â€”</span></div>
      </div>

      <div id="profileEditPanel" class="profile-edit-panel" aria-hidden="true">
        <div class="profile-edit-section" id="profileInbox">
          <p class="profile-edit-section-title">ìê¸°ì†Œê°œ<span id="bioCount" class="profile-bio-count profile-edit-section-desc">(0/100)</span></p>
          <textarea id="inputBio" class="profile-bio-input" placeholder="í•œ ì¤„ë¡œ ë‚˜ë¥¼ ì†Œê°œí•´ ë³´ì„¸ìš”" maxlength="100" rows="2"></textarea>
          <div class="profile-bio-actions">
            <button type="button" id="bioSave" class="profile-edit-btn">ì €ì¥</button>
            <span id="bioFeedback" class="profile-bio-feedback" aria-live="polite"></span>
          </div>
        </div>
        <div class="profile-edit-section">
          <p class="profile-edit-section-title">ë‹‰ë„¤ì„ <span class="profile-edit-section-desc">(ID)</span></p>
          <p id="nicknameCooldown" class="profile-bio-feedback" style="color:var(--neon); display:none;"></p>
          <form id="formNickname">
            <input type="text" id="inputDisplayName" class="profile-edit-input" minlength="5" maxlength="12" pattern="[a-zA-Z0-9]*" placeholder="ì˜ë¬¸Â·ìˆ«ì 5~12ì" autocomplete="username">
            <div class="profile-nickname-row">
              <button type="submit" id="nicknameSubmit" class="profile-edit-btn">ì €ì¥</button>
              <div class="profile-nickname-msgs">
                <p id="nicknameValidation" class="profile-bio-feedback profile-nickname-validation" aria-live="polite" role="status"></p>
                <p id="nicknameErr" class="profile-bio-feedback profile-error" style="display:none;"></p>
              </div>
            </div>
          </form>
        </div>
        <div class="profile-edit-section">
          <p class="profile-edit-section-title">ì§€ê°‘ ì£¼ì†Œ <span class="profile-edit-section-desc">(ì„ íƒ, ì¸ì¦ ì‹œ íšŒì› ë“±ê¸‰ ë°˜ì˜)</span></p>
          <p class="profile-edit-section-desc">ì´ë”ë¦¬ì›€ ì§€ê°‘ì„ ë“±ë¡í•˜ë©´ TORN ìŠ¤í…Œì´í‚¹ ê¸°ì¤€ íšŒì› ë“±ê¸‰ì´ ì ìš©ë©ë‹ˆë‹¤. ë¹„ì›Œë‘ë©´ ë“±ê¸‰ ì—†ì´ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
          <input type="text" id="inputWallet" class="profile-edit-input" placeholder="0x..." autocomplete="off" spellcheck="false">
          <div class="profile-wallet-row">
            <button type="button" id="walletVerifyBtn" class="profile-edit-btn">ì¸ì¦í•˜ê¸°</button>
            <button type="button" id="walletClearBtn" class="profile-edit-btn" style="margin-left:0.5rem; background:transparent; color:var(--text-muted); border:1px solid var(--border);">ì§€ê°‘ ì‚­ì œ</button>
          </div>
          <p id="walletFeedback" class="profile-bio-feedback" aria-live="polite" style="margin-top:0.5rem;"></p>
        </div>
        <div class="profile-edit-section">
          <p class="profile-edit-section-title">ë¹„ë°€ë²ˆí˜¸ <span class="profile-edit-section-desc">(ì˜ë¬¸Â·ìˆ«ì ì¡°í•© 8ì ì´ìƒ)</span></p>
          <form id="formPassword">
            <input type="password" id="inputPassword" class="profile-edit-input" minlength="8" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸" autocomplete="new-password">
            <input type="password" id="inputPasswordConfirm" class="profile-edit-input" placeholder="ë‹¤ì‹œ ì…ë ¥">
            <p id="passwordErr" class="profile-bio-feedback profile-error" style="display:none;"></p>
            <div class="profile-password-row">
              <button type="submit" class="profile-edit-btn">ë³€ê²½</button>
              <p id="passwordMatchHint" class="profile-password-match" aria-live="polite" style="display:none;"></p>
            </div>
          </form>
        </div>
        <button type="button" id="profileEditClose" class="profile-edit-close">ë‹«ê¸°</button>
      </div>
    </div>

  </div>

  <script src="js/auth.js"></script>
  <script src="js/nav-logo.js"></script>
  <script>
    (function () {
      var profileDenied = document.getElementById('profileDenied');
      var profilePage = document.getElementById('profilePage');
      var infoDisplayName = document.getElementById('infoDisplayName');
      var infoHandle = document.getElementById('infoHandle');
      var infoBio = document.getElementById('infoBio');
      var infoHearts = document.getElementById('infoHearts');
      var infoWallet = document.getElementById('infoWallet');
      var infoLevel = document.getElementById('infoLevel');
      var infoLevelIcon = document.getElementById('infoLevelIcon');
      var profileEditBtn = document.getElementById('profileEditBtn');
      var LEVEL_NAMES = { 1: 'ì¡°ê°œ', 2: 'ìƒˆìš°', 3: 'ë¬¸ì–´', 4: 'ë¬¼ê°œ', 5: 'ìƒì–´', 6: 'ê³ ë˜' };
      var LEVEL_ICONS = { 1: 'ğŸš', 2: 'ğŸ¦', 3: 'ğŸ™', 4: 'ğŸ¦­', 5: 'ğŸ¦ˆ', 6: 'ğŸ‹' };
      var formNickname = document.getElementById('formNickname');
      var inputDisplayName = document.getElementById('inputDisplayName');
      var nicknameErr = document.getElementById('nicknameErr');
      var nicknameValidation = document.getElementById('nicknameValidation');
      var nicknameCooldown = document.getElementById('nicknameCooldown');
      var nicknameSubmit = document.getElementById('nicknameSubmit');
      var currentDisplayName = '';
      var formPassword = document.getElementById('formPassword');
      var inputPassword = document.getElementById('inputPassword');
      var inputPasswordConfirm = document.getElementById('inputPasswordConfirm');
      var passwordErr = document.getElementById('passwordErr');
      var passwordMatchHint = document.getElementById('passwordMatchHint');
      var profileToastModal = document.getElementById('profileToastModal');
      var profileToastText = document.getElementById('profileToastText');
      var profileToastOk = document.getElementById('profileToastOk');
      var nicknameRegex = /^[a-zA-Z0-9]{5,12}$/;
      function isNicknameValid(v) { return v && nicknameRegex.test(v) && /[a-zA-Z]/.test(v); }
      var nicknameCheckTimer = null;
      var profilePhoto = document.getElementById('profilePhoto');
      var profilePhotoInput = document.getElementById('profilePhotoInput');
      var profileAvatarWrap = document.getElementById('profileAvatarWrap');
      var inputBio = document.getElementById('inputBio');
      var bioCount = document.getElementById('bioCount');
      var bioFeedback = document.getElementById('bioFeedback');
      var bioSave = document.getElementById('bioSave');

      var placeholderAvatar = 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 80 80"><circle fill="%231a1a1e" cx="40" cy="40" r="40"/><circle fill="%236b7280" cx="40" cy="32" r="12"/><path fill="%236b7280" d="M24 72c0-12 7.2-22 16-27 8.8 5 16 15 16 27H24z"/></svg>');

      function fillInfo(user) {
        infoDisplayName.textContent = user.displayName || 'â€”';
        if (infoHandle) infoHandle.textContent = '@' + (user.displayName || 'â€”');
        var bioStr = user.bio != null ? String(user.bio) : '';
        if (infoBio) {
          infoBio.textContent = bioStr || 'ìê¸°ì†Œê°œê°€ ì—†ìŠµë‹ˆë‹¤.';
          infoBio.classList.toggle('empty', !bioStr);
        }
        if (infoHearts) infoHearts.textContent = typeof user.points === 'number' ? user.points : 0;
        infoWallet.textContent = (user.walletAddress && user.walletAddress.trim()) ? user.walletAddress : 'ì—†ìŒ';
        if (infoLevelIcon) infoLevelIcon.textContent = user.isAdmin ? 'ğŸ› ï¸' : (LEVEL_ICONS[user.level] || 'â€”');
        if (infoLevel) {
          infoLevel.textContent = user.isAdmin ? 'ê´€ë¦¬ì' : (LEVEL_NAMES[user.level] ? LEVEL_NAMES[user.level] + ' (Lv.' + user.level + ')' : 'â€”');
        }
        inputDisplayName.placeholder = user.displayName || 'ìƒˆ ë‹‰ë„¤ì„';
        currentDisplayName = (user.displayName || '').trim();
        if (profilePhoto) profilePhoto.src = (user.profileImageUrl && user.profileImageUrl.trim()) ? user.profileImageUrl : placeholderAvatar;
        if (inputBio) inputBio.value = bioStr;
        if (bioCount) bioCount.textContent = '(' + bioStr.length + '/100)';
        if (user.nextDisplayNameChangeAt && new Date(user.nextDisplayNameChangeAt).getTime() > Date.now()) {
          var d = new Date(user.nextDisplayNameChangeAt);
          nicknameCooldown.textContent = 'ë‹¤ìŒ ë³€ê²½ì¼: ' + d.toLocaleDateString('ko-KR');
          nicknameCooldown.style.display = 'block';
          nicknameSubmit.disabled = false;
        } else {
          nicknameCooldown.style.display = 'none';
        }
      }

      function init() {
        var user = window.TornFiAuth.getUser();
        if (!user) {
          profileDenied.style.display = 'block';
          profilePage.style.display = 'none';
          var nac = document.getElementById('navAdminCenter');
          var nbtn = document.getElementById('navMenuBtn');
          if (nbtn) nbtn.style.display = 'none';
          if (nac) nac.style.display = 'none';
          return;
        }
        profileDenied.style.display = 'none';
        profilePage.style.display = 'block';
        fillInfo(user);
        fetch('/api/me', { credentials: 'same-origin' })
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (data.ok && data.user) fillInfo(data.user);
          })
          .catch(function () {});
        var nac = document.getElementById('navAdminCenter');
        var nbtn = document.getElementById('navMenuBtn');
        if (nbtn) nbtn.style.display = 'none';
        if (nac) nac.style.display = user.isAdmin ? 'inline-flex' : 'none';
      }
      var navMenuBtn = document.getElementById('navMenuBtn');
      var navMenuDropdown = document.getElementById('navMenuDropdown');
      if (navMenuBtn && navMenuDropdown) {
        navMenuBtn.addEventListener('click', function (e) { e.stopPropagation(); navMenuDropdown.classList.toggle('is-open'); navMenuBtn.setAttribute('aria-expanded', navMenuDropdown.classList.contains('is-open')); });
        navMenuDropdown.addEventListener('click', function (e) { e.stopPropagation(); });
        document.addEventListener('click', function () { navMenuDropdown.classList.remove('is-open'); navMenuBtn.setAttribute('aria-expanded', 'false'); });
      }

      function checkNicknameAvailability() {
        if (!nicknameValidation) return;
        var v = (inputDisplayName.value || '').trim();
        nicknameValidation.textContent = '';
        nicknameValidation.classList.remove('wallet-validation--ok', 'wallet-validation--err');
        if (v.length === 0) return;
        if (v.length < 5) { nicknameValidation.textContent = 'ë‹‰ë„¤ì„ì€ 5~12ìì…ë‹ˆë‹¤.'; nicknameValidation.classList.add('wallet-validation--err'); return; }
        if (!nicknameRegex.test(v)) { nicknameValidation.textContent = 'ì˜ë¬¸, ìˆ«ìë§Œ 5~12ì ê°€ëŠ¥í•©ë‹ˆë‹¤.'; nicknameValidation.classList.add('wallet-validation--err'); return; }
        if (!/[a-zA-Z]/.test(v)) { nicknameValidation.textContent = 'ì˜ë¬¸, ìˆ«ìë§Œ 5~12ì ê°€ëŠ¥í•©ë‹ˆë‹¤.'; nicknameValidation.classList.add('wallet-validation--err'); return; }
        if (v.toLowerCase() === (currentDisplayName || '').toLowerCase()) { nicknameValidation.textContent = 'í˜„ì¬ ë‹‰ë„¤ì„ê³¼ ë™ì¼í•©ë‹ˆë‹¤.'; return; }
        fetch('/api/public/check-nickname?displayName=' + encodeURIComponent(v), { credentials: 'same-origin' })
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (inputDisplayName.value.trim() !== v) return;
            if (data.available) { nicknameValidation.textContent = 'ì‚¬ìš© ê°€ëŠ¥í•œ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.'; nicknameValidation.classList.add('wallet-validation--ok'); nicknameValidation.classList.remove('wallet-validation--err'); }
            else { nicknameValidation.textContent = data.message || 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.'; nicknameValidation.classList.add('wallet-validation--err'); nicknameValidation.classList.remove('wallet-validation--ok'); }
          })
          .catch(function () { if (inputDisplayName.value.trim() === v) { nicknameValidation.textContent = 'í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'; nicknameValidation.classList.add('wallet-validation--err'); } });
      }
      if (inputDisplayName) {
        inputDisplayName.addEventListener('input', function () {
          var v = this.value.replace(/[^a-zA-Z0-9]/g, '').slice(0, 12);
          if (v !== this.value) this.value = v;
          if (nicknameValidation) { nicknameValidation.textContent = ''; nicknameValidation.classList.remove('wallet-validation--ok', 'wallet-validation--err'); }
          if (nicknameCheckTimer) clearTimeout(nicknameCheckTimer);
          if (v.length >= 5) { nicknameCheckTimer = setTimeout(function () { nicknameCheckTimer = null; checkNicknameAvailability(); }, 400); }
        });
      }
      formNickname.addEventListener('submit', function (e) {
        e.preventDefault();
        nicknameErr.style.display = 'none';
        if (nicknameValidation) { nicknameValidation.textContent = ''; nicknameValidation.classList.remove('wallet-validation--ok', 'wallet-validation--err'); }
        var name = inputDisplayName.value.trim();
        if (!name) {
          nicknameErr.textContent = 'ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.';
          nicknameErr.style.display = 'block';
          return;
        }
        if (!isNicknameValid(name)) {
          nicknameErr.textContent = 'ë‹‰ë„¤ì„ì€ ì˜ë¬¸, ìˆ«ìë§Œ 5~12ìê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.';
          nicknameErr.style.display = 'block';
          return;
        }
        fetch('/api/me', {
          method: 'PATCH',
          credentials: 'same-origin',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ displayName: name }),
        })
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (data.ok) {
              nicknameErr.style.display = 'none';
              if (nicknameValidation) { nicknameValidation.textContent = ''; nicknameValidation.classList.remove('wallet-validation--ok', 'wallet-validation--err'); }
              currentDisplayName = name;
              if (profileToastText) profileToastText.textContent = 'ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.';
              if (profileToastModal) { profileToastModal.style.display = 'flex'; profileToastModal.classList.add('is-open'); }
              infoDisplayName.textContent = name;
              if (infoHandle) infoHandle.textContent = '@' + name;
              window.TornFiAuth.init().then(function () { fillInfo(window.TornFiAuth.getUser() || {}); });
            } else {
              nicknameErr.textContent = data.message || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
              nicknameErr.style.display = 'block';
            }
          })
          .catch(function () {
            nicknameErr.textContent = 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
            nicknameErr.style.display = 'block';
          });
      });

      function updatePasswordMatchHint() {
        var pwd = inputPassword.value;
        var confirm = inputPasswordConfirm.value;
        if (!pwd || !confirm) {
          if (passwordMatchHint) { passwordMatchHint.style.display = 'none'; passwordMatchHint.textContent = ''; passwordMatchHint.className = 'profile-password-match'; }
          return;
        }
        if (!passwordMatchHint) return;
        passwordMatchHint.style.display = 'block';
        if (pwd === confirm) {
          passwordMatchHint.textContent = 'ì¼ì¹˜í•©ë‹ˆë‹¤.';
          passwordMatchHint.className = 'profile-password-match is-ok';
        } else {
          passwordMatchHint.textContent = 'ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
          passwordMatchHint.className = 'profile-password-match is-err';
        }
      }
      if (inputPassword) inputPassword.addEventListener('input', updatePasswordMatchHint);
      if (inputPasswordConfirm) inputPasswordConfirm.addEventListener('input', updatePasswordMatchHint);

      if (profileToastOk && profileToastModal) {
        profileToastOk.addEventListener('click', function () {
          profileToastModal.classList.remove('is-open');
          profileToastModal.style.display = 'none';
        });
      }

      formPassword.addEventListener('submit', function (e) {
        e.preventDefault();
        passwordErr.style.display = 'none';
        var pwd = inputPassword.value;
        var confirm = inputPasswordConfirm.value;
        if (pwd.length < 8) {
          passwordErr.textContent = 'ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
          passwordErr.style.display = 'block';
          return;
        }
        if (!/[a-zA-Z]/.test(pwd) || !/\d/.test(pwd)) {
          passwordErr.textContent = 'ë¹„ë°€ë²ˆí˜¸ëŠ” ì˜ë¬¸ê³¼ ìˆ«ìë¥¼ ëª¨ë‘ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.';
          passwordErr.style.display = 'block';
          return;
        }
        if (pwd !== confirm) {
          passwordErr.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
          passwordErr.style.display = 'block';
          return;
        }
        fetch('/api/me', {
          method: 'PATCH',
          credentials: 'same-origin',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: pwd }),
        })
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (data.ok) {
              inputPassword.value = '';
              inputPasswordConfirm.value = '';
              if (passwordMatchHint) { passwordMatchHint.style.display = 'none'; passwordMatchHint.textContent = ''; passwordMatchHint.className = 'profile-password-match'; }
              if (profileToastText) profileToastText.textContent = 'ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.';
              if (profileToastModal) { profileToastModal.style.display = 'flex'; profileToastModal.classList.add('is-open'); }
            } else {
              passwordErr.textContent = data.message || 'ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
              passwordErr.style.display = 'block';
            }
          })
          .catch(function () {
            passwordErr.textContent = 'ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
            passwordErr.style.display = 'block';
          });
      });

      inputDisplayName.addEventListener('input', function () {
        this.value = this.value.replace(/[^a-zA-Z0-9]/g, '').slice(0, 12);
      });

      var PROFILE_AVATAR_MAX_SIZE = 1 * 1024 * 1024;
      var PROFILE_AVATAR_MAX_DIM = 400;
      var CROP_SIZE = 300;

      var profileCropModal = document.getElementById('profileCropModal');
      var profileCropViewport = document.getElementById('profileCropViewport');
      var profileCropImg = document.getElementById('profileCropImg');
      var profileCropCancel = document.getElementById('profileCropCancel');
      var profileCropApply = document.getElementById('profileCropApply');

      var cropObjectUrl = null;
      var cropImgDisplayW = 0;
      var cropImgDisplayH = 0;
      var cropDrag = { active: false, startX: 0, startY: 0, startLeft: 0, startTop: 0 };

      function setCropImagePosition(left, top) {
        var maxLeft = Math.min(0, CROP_SIZE - cropImgDisplayW);
        var maxTop = Math.min(0, CROP_SIZE - cropImgDisplayH);
        profileCropImg.style.left = Math.max(maxLeft, Math.min(0, left)) + 'px';
        profileCropImg.style.top = Math.max(maxTop, Math.min(0, top)) + 'px';
      }

      function openCropModal(file) {
        if (!file || !file.type.match(/^image\/(jpeg|png|gif|webp)$/)) return;
        if (cropObjectUrl) URL.revokeObjectURL(cropObjectUrl);
        cropObjectUrl = URL.createObjectURL(file);
        profileCropImg.onload = function () {
          var nw = profileCropImg.naturalWidth;
          var nh = profileCropImg.naturalHeight;
          var scale = Math.max(CROP_SIZE / nw, CROP_SIZE / nh);
          cropImgDisplayW = Math.round(nw * scale);
          cropImgDisplayH = Math.round(nh * scale);
          profileCropImg.style.width = cropImgDisplayW + 'px';
          profileCropImg.style.height = cropImgDisplayH + 'px';
          setCropImagePosition((CROP_SIZE - cropImgDisplayW) / 2, (CROP_SIZE - cropImgDisplayH) / 2);
          profileCropModal.style.display = 'flex';
        };
        profileCropImg.onerror = function () {
          URL.revokeObjectURL(cropObjectUrl);
          cropObjectUrl = null;
          alert('ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        };
        profileCropImg.src = cropObjectUrl;
      }

      function closeCropModal() {
        profileCropModal.style.display = 'none';
        profileCropImg.src = '';
        profileCropImg.onerror = null;
        if (cropObjectUrl) { URL.revokeObjectURL(cropObjectUrl); cropObjectUrl = null; }
      }

      function getCroppedBlob(cb) {
        var left = parseInt(profileCropImg.style.left, 10) || 0;
        var top = parseInt(profileCropImg.style.top, 10) || 0;
        var scaleX = profileCropImg.naturalWidth / cropImgDisplayW;
        var scaleY = profileCropImg.naturalHeight / cropImgDisplayH;
        var sx = (-left) * scaleX;
        var sy = (-top) * scaleY;
        var sw = CROP_SIZE * scaleX;
        var sh = CROP_SIZE * scaleY;
        var canvas = document.createElement('canvas');
        canvas.width = PROFILE_AVATAR_MAX_DIM;
        canvas.height = PROFILE_AVATAR_MAX_DIM;
        var ctx = canvas.getContext('2d');
        ctx.drawImage(profileCropImg, sx, sy, sw, sh, 0, 0, PROFILE_AVATAR_MAX_DIM, PROFILE_AVATAR_MAX_DIM);
        canvas.toBlob(function (blob) {
          if (!blob) cb(new Error('ì´ë¯¸ì§€ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
          else if (blob.size > PROFILE_AVATAR_MAX_SIZE) cb(new Error('í”„ë¡œí•„ ì‚¬ì§„ì€ 1MB ì´í•˜ë¡œ ì„ íƒí•´ ì£¼ì„¸ìš”.'));
          else cb(null, blob);
        }, 'image/jpeg', 0.85);
      }

      function onCropDragStart(e) {
        e.preventDefault();
        var x = (e.touches && e.touches[0] ? e.touches[0].clientX : e.clientX);
        var y = (e.touches && e.touches[0] ? e.touches[0].clientY : e.clientY);
        cropDrag.active = true;
        cropDrag.startX = x;
        cropDrag.startY = y;
        cropDrag.startLeft = parseInt(profileCropImg.style.left, 10) || 0;
        cropDrag.startTop = parseInt(profileCropImg.style.top, 10) || 0;
      }
      function onCropDragMove(e) {
        if (!cropDrag.active) return;
        e.preventDefault();
        var x = (e.touches && e.touches[0] ? e.touches[0].clientX : e.clientX);
        var y = (e.touches && e.touches[0] ? e.touches[0].clientY : e.clientY);
        setCropImagePosition(cropDrag.startLeft + (x - cropDrag.startX), cropDrag.startTop + (y - cropDrag.startY));
      }
      function onCropDragEnd() { cropDrag.active = false; }

      if (profileCropViewport) {
        profileCropViewport.addEventListener('mousedown', onCropDragStart);
        profileCropViewport.addEventListener('touchstart', onCropDragStart, { passive: false });
      }
      document.addEventListener('mousemove', function (e) {
        if (cropDrag.active) onCropDragMove(e);
      });
      document.addEventListener('touchmove', function (e) {
        if (cropDrag.active) { e.preventDefault(); onCropDragMove(e); }
      }, { passive: false });
      document.addEventListener('mouseup', onCropDragEnd);
      document.addEventListener('touchend', onCropDragEnd);

      if (profileCropCancel) profileCropCancel.addEventListener('click', closeCropModal);
      if (profileCropModal) profileCropModal.addEventListener('click', function (e) { if (e.target === profileCropModal) closeCropModal(); });
      if (profileCropApply) profileCropApply.addEventListener('click', function () {
        getCroppedBlob(function (err, blob) {
          if (err) { alert(err.message); return; }
          closeCropModal();
          profilePhotoInput.value = '';
          var fd = new FormData();
          fd.append('avatar', blob, 'avatar.jpg');
          fetch('/api/me/avatar', { method: 'POST', credentials: 'same-origin', body: fd })
            .then(function (r) { return r.json(); })
            .then(function (data) {
              if (data.ok && data.profileImageUrl) {
                if (profilePhoto) profilePhoto.src = data.profileImageUrl;
                window.TornFiAuth.init().then(function () { fillInfo(window.TornFiAuth.getUser() || {}); });
              } else if (data.message) alert(data.message);
            })
            .catch(function () {});
        });
      });

      function openPhotoInput() {
        if (profilePhotoInput) profilePhotoInput.click();
      }
      if (profileAvatarWrap && profilePhotoInput) {
        profileAvatarWrap.addEventListener('click', openPhotoInput);
        profileAvatarWrap.addEventListener('keydown', function (e) { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openPhotoInput(); } });
      }
      if (profilePhotoInput) {
        profilePhotoInput.addEventListener('change', function () {
          var file = profilePhotoInput.files && profilePhotoInput.files[0];
          if (!file) { profilePhotoInput.value = ''; return; }
          if (file.size > PROFILE_AVATAR_MAX_SIZE) { alert('í”„ë¡œí•„ ì‚¬ì§„ì€ 1MB ì´í•˜ë¡œ ì„ íƒí•´ ì£¼ì„¸ìš”.'); profilePhotoInput.value = ''; return; }
          openCropModal(file);
          profilePhotoInput.value = '';
        });
      }

      if (inputBio) inputBio.addEventListener('input', function () {
        if (bioCount) bioCount.textContent = '(' + this.value.length + '/100)';
      });
      var profileEditPanel = document.getElementById('profileEditPanel');
      var profileEditClose = document.getElementById('profileEditClose');
      function setEditPanelOpen(open) {
        if (profileEditPanel) {
          profileEditPanel.classList.toggle('is-open', open);
          profileEditPanel.setAttribute('aria-hidden', open ? 'false' : 'true');
        }
        if (profileEditBtn) {
          profileEditBtn.textContent = open ? 'ë‹«ê¸°' : 'íšŒì› ì •ë³´ ìˆ˜ì •';
          profileEditBtn.setAttribute('aria-expanded', open ? 'true' : 'false');
        }
      }
      if (profileEditBtn) profileEditBtn.addEventListener('click', function () {
        setEditPanelOpen(!profileEditPanel || !profileEditPanel.classList.contains('is-open'));
      });
      if (profileEditClose) profileEditClose.addEventListener('click', function () {
        setEditPanelOpen(false);
      });

      function setBioFeedback(message, isError) {
        if (!bioFeedback) return;
        bioFeedback.textContent = message || '';
        bioFeedback.className = 'profile-bio-feedback ' + (isError ? 'profile-error' : 'profile-success');
      }
      if (bioSave && inputBio) {
        bioSave.addEventListener('click', function () {
          setBioFeedback('');
          var text = inputBio.value.trim();
          fetch('/api/me', {
            method: 'PATCH',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ bio: text }),
          })
            .then(function (r) { return r.json(); })
            .then(function (data) {
              if (data.ok) {
                setBioFeedback(data.message || 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', false);
                if (data.user) fillInfo(data.user);
                if (bioCount) bioCount.textContent = '(' + (data.user && data.user.bio ? data.user.bio : text).length + '/100)';
                if (infoBio) {
                  var b = (data.user && data.user.bio != null) ? data.user.bio : text;
                  infoBio.textContent = b || 'ìê¸°ì†Œê°œê°€ ì—†ìŠµë‹ˆë‹¤.';
                  infoBio.classList.toggle('empty', !b);
                }
                if (infoHearts && data.user && typeof data.user.points === 'number') infoHearts.textContent = data.user.points;
              } else {
                setBioFeedback(data.message || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', true);
              }
            })
            .catch(function () {
              setBioFeedback('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', true);
            });
        });
      }

      var inputWallet = document.getElementById('inputWallet');
      var walletVerifyBtn = document.getElementById('walletVerifyBtn');
      var walletClearBtn = document.getElementById('walletClearBtn');
      var walletFeedback = document.getElementById('walletFeedback');
      function setWalletFeedback(message, isError) {
        if (!walletFeedback) return;
        walletFeedback.textContent = message || '';
        walletFeedback.className = 'profile-bio-feedback ' + (isError ? 'profile-error' : 'profile-success');
      }
      if (walletVerifyBtn && inputWallet) {
        walletVerifyBtn.addEventListener('click', function () {
          var raw = inputWallet.value.trim();
          if (!raw) {
            setWalletFeedback('ì§€ê°‘ ì£¼ì†Œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.', true);
            return;
          }
          walletVerifyBtn.disabled = true;
          setWalletFeedback('ì¸ì¦ ì¤‘â€¦');
          fetch('/api/me/verify-wallet', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ walletAddress: raw }),
          })
            .then(function (r) { return r.json(); })
            .then(function (data) {
              walletVerifyBtn.disabled = false;
              if (data.ok && data.user) {
                setWalletFeedback(data.message || 'ì§€ê°‘ì´ ì¸ì¦ë˜ì—ˆìŠµë‹ˆë‹¤.', false);
                fillInfo(data.user);
                inputWallet.value = '';
                if (infoWallet) infoWallet.textContent = data.user.walletAddress || 'ì—†ìŒ';
                if (infoLevel && data.user.level) infoLevel.textContent = (LEVEL_NAMES[data.user.level] || '') + (data.user.level ? ' (Lv.' + data.user.level + ')' : '');
                if (infoLevelIcon) infoLevelIcon.textContent = LEVEL_ICONS[data.user.level] || 'â€”';
              } else {
                setWalletFeedback(data.message || 'ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', true);
              }
            })
            .catch(function () {
              walletVerifyBtn.disabled = false;
              setWalletFeedback('ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', true);
            });
        });
      }
      if (walletClearBtn) {
        walletClearBtn.addEventListener('click', function () {
          walletClearBtn.disabled = true;
          setWalletFeedback('ì‚­ì œ ì¤‘â€¦');
          fetch('/api/me', {
            method: 'PATCH',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ walletAddress: null }),
          })
            .then(function (r) { return r.json(); })
            .then(function (data) {
              walletClearBtn.disabled = false;
              if (data.ok && data.user) {
                setWalletFeedback('ì§€ê°‘ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', false);
                fillInfo(data.user);
                if (inputWallet) inputWallet.value = '';
                if (infoWallet) infoWallet.textContent = 'ì—†ìŒ';
                if (infoLevel) infoLevel.textContent = LEVEL_NAMES[1] ? LEVEL_NAMES[1] + ' (Lv.1)' : 'â€”';
                if (infoLevelIcon) infoLevelIcon.textContent = LEVEL_ICONS[1] || 'â€”';
              } else {
                setWalletFeedback(data.message || 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', true);
              }
            })
            .catch(function () {
              walletClearBtn.disabled = false;
              setWalletFeedback('ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', true);
            });
        });
      }

      if (window.TornFiAuth.getUser()) {
        init();
      } else {
        window.TornFiAuth.init().then(init);
      }
    })();
  </script>
</body>
</html>
