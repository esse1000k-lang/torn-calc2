<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#0a0a0b">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>íšŒì› ì •ë³´ | TornFi</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="manifest" href="/manifest.json">
  <script src="js/pwa-env.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/site.css">
  <style>
    .profile-page { max-width: 480px; margin: 0 auto; padding: 2rem 1rem; }
    .profile-card { background: var(--bg-card); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; }
    .profile-card h2 { font-size: 1rem; color: var(--neon); margin-bottom: 1rem; }
    .profile-row { margin-bottom: 1rem; }
    .profile-row:last-child { margin-bottom: 0; }
    .profile-label { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.25rem; }
    .profile-value { font-size: 0.95rem; word-break: break-all; }
    .profile-value.wallet { font-family: monospace; font-size: 0.85rem; }
    .profile-denied { text-align: center; padding: 3rem 1rem; color: var(--text-muted); }
    .profile-denied a { color: var(--neon); }
    .profile-success { font-size: 0.85rem; color: var(--neon); margin-top: 0.5rem; }
    .profile-error { font-size: 0.85rem; color: var(--danger); margin-top: 0.5rem; }
    .profile-card button { width: 100%; padding: 0.6rem; background: var(--neon); color: var(--bg-dark); border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; }
    .profile-card button:hover { background: var(--neon-dim); color: var(--text); }
    .profile-photo-row { margin-bottom: 1rem; }
    .profile-photo-wrap { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
    .profile-photo { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border); background: var(--bg-dark); }
    .profile-photo-btn { width: auto; padding: 0.5rem 1rem; font-size: 0.85rem; }
    .profile-bio-count { color: var(--text-muted); font-weight: 400; margin-left: 0.25rem; }
    .profile-bio-input { width: 100%; padding: 0.6rem; margin-top: 0.25rem; margin-bottom: 0.5rem; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 4px; color: var(--text); font-family: inherit; font-size: 0.9rem; resize: vertical; min-height: 4rem; }
    .profile-bio-input:focus { outline: none; border-color: var(--neon); }
    .profile-bio-save { width: auto; padding: 0.5rem 1rem; font-size: 0.85rem; margin-top: 0.25rem; }
    .profile-crop-overlay { position: fixed; inset: 0; z-index: 1000; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; padding: 1rem; }
    .profile-crop-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; max-width: 100%; }
    .profile-crop-box h3 { font-size: 1rem; color: var(--neon); margin-bottom: 1rem; }
    .profile-crop-viewport { width: 300px; height: 300px; overflow: hidden; position: relative; margin: 0 auto 1rem; border-radius: 50%; border: 2px solid var(--border); background: var(--bg-dark); cursor: move; touch-action: none; }
    .profile-crop-viewport img { display: block; position: absolute; pointer-events: none; }
    .profile-crop-actions { display: flex; gap: 0.5rem; justify-content: flex-end; }
    .profile-crop-actions button { width: auto; padding: 0.5rem 1rem; }
    .profile-crop-actions .profile-crop-cancel { background: var(--bg-dark); color: var(--text); border: 1px solid var(--border); }
    .profile-crop-actions .profile-crop-cancel:hover { border-color: var(--text-muted); }
  </style>
</head>
<body>
  <nav class="site-nav">
    <div class="nav-brand">
      <a href="/" class="nav-logo">TornFi</a>
    </div>
    <a href="/admin.html" class="nav-admin-center" id="navAdminCenter" aria-label="ê´€ë¦¬ì" style="display:none;">ğŸ› ï¸</a>
    <div class="nav-menu-wrap">
      <button type="button" class="nav-menu-btn" id="navMenuBtn" aria-label="ë©”ë‰´" aria-expanded="false" aria-haspopup="true">â˜°</button>
      <div class="nav-menu-dropdown" id="navMenuDropdown" role="menu">
        <a href="/login.html" id="navLogin" role="menuitem" style="display:none;">ë¡œê·¸ì¸</a>
        <a href="/register.html" id="navRegister" role="menuitem" style="display:none;">íšŒì›ê°€ì…</a>
        <div class="nav-menu-user" id="navMenuUser" style="display:none;">
          <a href="/profile.html" id="navProfile" role="menuitem">ë‚´ ì •ë³´</a>
          <button type="button" id="navLogout" role="menuitem">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>
    </div>
  </nav>

  <div id="profileCropModal" class="profile-crop-overlay" style="display:none;" aria-modal="true" aria-labelledby="profileCropTitle">
    <div class="profile-crop-box">
      <h3 id="profileCropTitle">í”„ë¡œí•„ ì‚¬ì§„ ì¡°ì •</h3>
      <p class="profile-label" style="margin-bottom:0.5rem;">ì‚¬ì§„ì„ ë“œë˜ê·¸í•´ì„œ ì›í•˜ëŠ” ì˜ì—­ì„ ë§ì¶° ì£¼ì„¸ìš”.</p>
      <div id="profileCropViewport" class="profile-crop-viewport">
        <img id="profileCropImg" src="" alt="">
      </div>
      <div class="profile-crop-actions">
        <button type="button" id="profileCropCancel" class="profile-photo-btn profile-crop-cancel">ì·¨ì†Œ</button>
        <button type="button" id="profileCropApply" class="profile-photo-btn">ì ìš©</button>
      </div>
    </div>
  </div>

  <div id="profileDenied" class="profile-denied" style="display:none;">
    <p>ë¡œê·¸ì¸í•œ íšŒì›ë§Œ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    <a href="/login.html">ë¡œê·¸ì¸</a> Â· <a href="/">í™ˆìœ¼ë¡œ</a>
  </div>

  <div id="profilePage" class="profile-page" style="display:none;">
    <a href="/" class="back-link">â† í™ˆìœ¼ë¡œ</a>
    <h1 style="font-size:1.25rem; margin-bottom:1.5rem;">íšŒì› ì •ë³´</h1>

    <div class="profile-card">
      <h2>ë‚´ ì •ë³´</h2>
      <div class="profile-row profile-photo-row">
        <div class="profile-photo-wrap">
          <img id="profilePhoto" class="profile-photo" src="" alt="í”„ë¡œí•„ ì‚¬ì§„" width="80" height="80">
          <input type="file" id="profilePhotoInput" accept="image/jpeg,image/png,image/gif,image/webp" aria-label="í”„ë¡œí•„ ì‚¬ì§„ ì„ íƒ" style="display:none;">
          <div>
            <button type="button" id="profilePhotoBtn" class="profile-photo-btn">ì‚¬ì§„ ë³€ê²½</button>
            <p class="profile-label" style="margin-top:0.35rem;">1MB ì´í•˜ Â· 400Ã—400 ì •ì‚¬ê°í˜•ìœ¼ë¡œ ìë™ ì¡°ì •</p>
          </div>
        </div>
      </div>
      <div class="profile-row">
        <div class="profile-label">ë‹‰ë„¤ì„</div>
        <div id="infoDisplayName" class="profile-value">â€”</div>
      </div>
      <div class="profile-row">
        <div class="profile-label">ì§€ê°‘ ì£¼ì†Œ</div>
        <div id="infoWallet" class="profile-value wallet">â€”</div>
      </div>
      <div class="profile-row">
        <div class="profile-label">ê°„ë‹¨í•œ ìê¸°ì†Œê°œ <span id="bioCount" class="profile-bio-count">0/300</span></div>
        <textarea id="inputBio" class="profile-bio-input" placeholder="ìê¸°ì†Œê°œë¥¼ ì…ë ¥í•˜ì„¸ìš” (300ì ì´ë‚´)" maxlength="300" rows="3"></textarea>
        <p id="bioMsg" class="profile-success" style="display:none;"></p>
        <p id="bioErr" class="profile-error" style="display:none;"></p>
        <button type="button" id="bioSave" class="profile-bio-save">ìê¸°ì†Œê°œ ì €ì¥</button>
      </div>
    </div>

    <div class="profile-card">
      <h2>ë‹‰ë„¤ì„ ë³€ê²½</h2>
      <p class="profile-label">ì˜ë¬¸, ìˆ«ìë§Œ 5~12ì (í•œ ë‹¬ì— í•œ ë²ˆ ë¬´ë£Œ ë³€ê²½, ì¤‘ë³µ ë¶ˆê°€)</p>
      <p id="nicknameCooldown" class="profile-label" style="color:var(--neon); display:none;"></p>
      <form id="formNickname">
        <input type="text" id="inputDisplayName" minlength="5" maxlength="12" pattern="[a-zA-Z0-9]*" placeholder="ìƒˆ ë‹‰ë„¤ì„ (5~12ì)" autocomplete="username" style="width:100%; padding:0.6rem; margin-bottom:0.5rem; background:var(--bg-dark); border:1px solid var(--border); border-radius:4px; color:var(--text);">
        <p id="nicknameMsg" class="profile-success" style="display:none;"></p>
        <p id="nicknameErr" class="profile-error" style="display:none;"></p>
        <button type="submit" id="nicknameSubmit" style="margin-top:0.5rem;">ë‹‰ë„¤ì„ ì €ì¥</button>
      </form>
    </div>

    <div class="profile-card">
      <h2>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h2>
      <form id="formPassword">
        <label for="inputPassword" class="profile-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸ (8ì ì´ìƒ, ì˜ë¬¸Â·ìˆ«ì í¬í•¨)</label>
        <input type="password" id="inputPassword" minlength="8" placeholder="8ì ì´ìƒ, ì˜ë¬¸Â·ìˆ«ì í¬í•¨" autocomplete="new-password" style="width:100%; padding:0.6rem; margin-bottom:0.5rem; background:var(--bg-dark); border:1px solid var(--border); border-radius:4px; color:var(--text);">
        <label for="inputPasswordConfirm" class="profile-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
        <input type="password" id="inputPasswordConfirm" placeholder="ë™ì¼í•˜ê²Œ ì…ë ¥" style="width:100%; padding:0.6rem; margin-bottom:0.5rem; background:var(--bg-dark); border:1px solid var(--border); border-radius:4px; color:var(--text);">
        <p id="passwordMsg" class="profile-success" style="display:none;"></p>
        <p id="passwordErr" class="profile-error" style="display:none;"></p>
        <button type="submit" style="margin-top:0.5rem;">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
      </form>
    </div>

  </div>

  <script src="js/auth.js"></script>
  <script src="js/nav-logo.js"></script>
  <script>
    (function () {
      var profileDenied = document.getElementById('profileDenied');
      var profilePage = document.getElementById('profilePage');
      var infoDisplayName = document.getElementById('infoDisplayName');
      var infoWallet = document.getElementById('infoWallet');
      var formNickname = document.getElementById('formNickname');
      var inputDisplayName = document.getElementById('inputDisplayName');
      var nicknameMsg = document.getElementById('nicknameMsg');
      var nicknameErr = document.getElementById('nicknameErr');
      var nicknameCooldown = document.getElementById('nicknameCooldown');
      var nicknameSubmit = document.getElementById('nicknameSubmit');
      var formPassword = document.getElementById('formPassword');
      var inputPassword = document.getElementById('inputPassword');
      var inputPasswordConfirm = document.getElementById('inputPasswordConfirm');
      var passwordMsg = document.getElementById('passwordMsg');
      var passwordErr = document.getElementById('passwordErr');
      var navMenuUser = document.getElementById('navMenuUser');

      var nicknameRegex = /^[a-zA-Z0-9]{5,12}$/;
      var profilePhoto = document.getElementById('profilePhoto');
      var profilePhotoInput = document.getElementById('profilePhotoInput');
      var profilePhotoBtn = document.getElementById('profilePhotoBtn');
      var inputBio = document.getElementById('inputBio');
      var bioCount = document.getElementById('bioCount');
      var bioMsg = document.getElementById('bioMsg');
      var bioErr = document.getElementById('bioErr');
      var bioSave = document.getElementById('bioSave');

      var placeholderAvatar = 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 80 80"><circle fill="%231a1a1e" cx="40" cy="40" r="40"/><circle fill="%236b7280" cx="40" cy="32" r="12"/><path fill="%236b7280" d="M24 72c0-12 7.2-22 16-27 8.8 5 16 15 16 27H24z"/></svg>');

      function fillInfo(user) {
        infoDisplayName.textContent = user.displayName || 'â€”';
        infoWallet.textContent = user.walletAddress || 'â€”';
        inputDisplayName.placeholder = user.displayName || 'ìƒˆ ë‹‰ë„¤ì„';
        if (profilePhoto) profilePhoto.src = (user.profileImageUrl && user.profileImageUrl.trim()) ? user.profileImageUrl : placeholderAvatar;
        if (inputBio) inputBio.value = user.bio != null ? user.bio : '';
        if (bioCount) bioCount.textContent = (user.bio || '').length + '/300';
        if (user.nextDisplayNameChangeAt && new Date(user.nextDisplayNameChangeAt).getTime() > Date.now()) {
          var d = new Date(user.nextDisplayNameChangeAt);
          nicknameCooldown.textContent = 'ë‹¤ìŒ ë¬´ë£Œ ë³€ê²½ì¼: ' + d.toLocaleDateString('ko-KR');
          nicknameCooldown.style.display = 'block';
          nicknameSubmit.disabled = false;
        } else {
          nicknameCooldown.style.display = 'none';
        }
      }

      function init() {
        var user = window.TornFiAuth.getUser();
        if (!user) {
          profileDenied.style.display = 'block';
          profilePage.style.display = 'none';
          var navLogin = document.getElementById('navLogin');
          var navRegister = document.getElementById('navRegister');
          var nac = document.getElementById('navAdminCenter');
          if (navLogin) navLogin.style.display = 'inline';
          if (navRegister) navRegister.style.display = 'inline';
          if (navMenuUser) navMenuUser.style.display = 'none';
          if (nac) nac.style.display = 'none';
          return;
        }
        profileDenied.style.display = 'none';
        profilePage.style.display = 'block';
        fillInfo(user);
        fetch('/api/me', { credentials: 'same-origin' })
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (data.ok && data.user) fillInfo(data.user);
          })
          .catch(function () {});
        var navLogin = document.getElementById('navLogin');
        var navRegister = document.getElementById('navRegister');
        var nac = document.getElementById('navAdminCenter');
        if (navLogin) navLogin.style.display = 'none';
        if (navRegister) navRegister.style.display = 'none';
        var navProfile = document.getElementById('navProfile');
        if (navProfile) navProfile.style.display = 'block';
        if (navMenuUser) navMenuUser.style.display = 'block';
        if (nac) nac.style.display = user.isAdmin ? 'inline-flex' : 'none';
      }
      var navMenuBtn = document.getElementById('navMenuBtn');
      var navMenuDropdown = document.getElementById('navMenuDropdown');
      if (navMenuBtn && navMenuDropdown) {
        navMenuBtn.addEventListener('click', function (e) { e.stopPropagation(); navMenuDropdown.classList.toggle('is-open'); navMenuBtn.setAttribute('aria-expanded', navMenuDropdown.classList.contains('is-open')); });
        navMenuDropdown.addEventListener('click', function (e) { e.stopPropagation(); });
        document.addEventListener('click', function () { navMenuDropdown.classList.remove('is-open'); navMenuBtn.setAttribute('aria-expanded', 'false'); });
      }
      var navLogout = document.getElementById('navLogout');
      if (navLogout) navLogout.addEventListener('click', function (e) {
        e.preventDefault();
        if (!confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        window.TornFiAuth.logout().then(function () { window.location.href = '/'; });
      });

      formNickname.addEventListener('submit', function (e) {
        e.preventDefault();
        nicknameMsg.style.display = 'none';
        nicknameErr.style.display = 'none';
        var name = inputDisplayName.value.trim();
        if (!name) {
          nicknameErr.textContent = 'ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.';
          nicknameErr.style.display = 'block';
          return;
        }
        if (!nicknameRegex.test(name)) {
          nicknameErr.textContent = 'ë‹‰ë„¤ì„ì€ ì˜ë¬¸, ìˆ«ìë§Œ 5~12ìê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.';
          nicknameErr.style.display = 'block';
          return;
        }
        fetch('/api/me', {
          method: 'PATCH',
          credentials: 'same-origin',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ displayName: name }),
        })
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (data.ok) {
              nicknameMsg.textContent = data.message || 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
              nicknameMsg.style.display = 'block';
              nicknameErr.style.display = 'none';
              infoDisplayName.textContent = name;
              window.TornFiAuth.init().then(function () { fillInfo(window.TornFiAuth.getUser() || {}); });
            } else {
              nicknameErr.textContent = data.message || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
              nicknameErr.style.display = 'block';
            }
          })
          .catch(function () {
            nicknameErr.textContent = 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
            nicknameErr.style.display = 'block';
          });
      });

      formPassword.addEventListener('submit', function (e) {
        e.preventDefault();
        passwordMsg.style.display = 'none';
        passwordErr.style.display = 'none';
        var pwd = inputPassword.value;
        var confirm = inputPasswordConfirm.value;
        if (pwd.length < 8) {
          passwordErr.textContent = 'ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
          passwordErr.style.display = 'block';
          return;
        }
        if (!/[a-zA-Z]/.test(pwd) || !/\d/.test(pwd)) {
          passwordErr.textContent = 'ë¹„ë°€ë²ˆí˜¸ëŠ” ì˜ë¬¸ê³¼ ìˆ«ìë¥¼ ëª¨ë‘ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.';
          passwordErr.style.display = 'block';
          return;
        }
        if (pwd !== confirm) {
          passwordErr.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
          passwordErr.style.display = 'block';
          return;
        }
        fetch('/api/me', {
          method: 'PATCH',
          credentials: 'same-origin',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: pwd }),
        })
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (data.ok) {
              passwordMsg.textContent = data.message || 'ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.';
              passwordMsg.style.display = 'block';
              passwordErr.style.display = 'none';
              inputPassword.value = '';
              inputPasswordConfirm.value = '';
            } else {
              passwordErr.textContent = data.message || 'ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
              passwordErr.style.display = 'block';
            }
          })
          .catch(function () {
            passwordErr.textContent = 'ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
            passwordErr.style.display = 'block';
          });
      });

      inputDisplayName.addEventListener('input', function () {
        this.value = this.value.replace(/[^a-zA-Z0-9]/g, '').slice(0, 12);
      });

      var PROFILE_AVATAR_MAX_SIZE = 1 * 1024 * 1024;
      var PROFILE_AVATAR_MAX_DIM = 400;
      var CROP_SIZE = 300;

      var profileCropModal = document.getElementById('profileCropModal');
      var profileCropViewport = document.getElementById('profileCropViewport');
      var profileCropImg = document.getElementById('profileCropImg');
      var profileCropCancel = document.getElementById('profileCropCancel');
      var profileCropApply = document.getElementById('profileCropApply');

      var cropObjectUrl = null;
      var cropImgDisplayW = 0;
      var cropImgDisplayH = 0;
      var cropDrag = { active: false, startX: 0, startY: 0, startLeft: 0, startTop: 0 };

      function setCropImagePosition(left, top) {
        var maxLeft = Math.min(0, CROP_SIZE - cropImgDisplayW);
        var maxTop = Math.min(0, CROP_SIZE - cropImgDisplayH);
        profileCropImg.style.left = Math.max(maxLeft, Math.min(0, left)) + 'px';
        profileCropImg.style.top = Math.max(maxTop, Math.min(0, top)) + 'px';
      }

      function openCropModal(file) {
        if (!file || !file.type.match(/^image\/(jpeg|png|gif|webp)$/)) return;
        if (cropObjectUrl) URL.revokeObjectURL(cropObjectUrl);
        cropObjectUrl = URL.createObjectURL(file);
        profileCropImg.onload = function () {
          var nw = profileCropImg.naturalWidth;
          var nh = profileCropImg.naturalHeight;
          var scale = Math.max(CROP_SIZE / nw, CROP_SIZE / nh);
          cropImgDisplayW = Math.round(nw * scale);
          cropImgDisplayH = Math.round(nh * scale);
          profileCropImg.style.width = cropImgDisplayW + 'px';
          profileCropImg.style.height = cropImgDisplayH + 'px';
          setCropImagePosition((CROP_SIZE - cropImgDisplayW) / 2, (CROP_SIZE - cropImgDisplayH) / 2);
          profileCropModal.style.display = 'flex';
        };
        profileCropImg.onerror = function () {
          URL.revokeObjectURL(cropObjectUrl);
          cropObjectUrl = null;
          alert('ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        };
        profileCropImg.src = cropObjectUrl;
      }

      function closeCropModal() {
        profileCropModal.style.display = 'none';
        if (cropObjectUrl) { URL.revokeObjectURL(cropObjectUrl); cropObjectUrl = null; }
        profileCropImg.src = '';
      }

      function getCroppedBlob(cb) {
        var left = parseInt(profileCropImg.style.left, 10) || 0;
        var top = parseInt(profileCropImg.style.top, 10) || 0;
        var scaleX = profileCropImg.naturalWidth / cropImgDisplayW;
        var scaleY = profileCropImg.naturalHeight / cropImgDisplayH;
        var sx = (-left) * scaleX;
        var sy = (-top) * scaleY;
        var sw = CROP_SIZE * scaleX;
        var sh = CROP_SIZE * scaleY;
        var canvas = document.createElement('canvas');
        canvas.width = PROFILE_AVATAR_MAX_DIM;
        canvas.height = PROFILE_AVATAR_MAX_DIM;
        var ctx = canvas.getContext('2d');
        ctx.drawImage(profileCropImg, sx, sy, sw, sh, 0, 0, PROFILE_AVATAR_MAX_DIM, PROFILE_AVATAR_MAX_DIM);
        canvas.toBlob(function (blob) {
          if (!blob) cb(new Error('ì´ë¯¸ì§€ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
          else if (blob.size > PROFILE_AVATAR_MAX_SIZE) cb(new Error('í”„ë¡œí•„ ì‚¬ì§„ì€ 1MB ì´í•˜ë¡œ ì„ íƒí•´ ì£¼ì„¸ìš”.'));
          else cb(null, blob);
        }, 'image/jpeg', 0.85);
      }

      function onCropDragStart(e) {
        e.preventDefault();
        var x = (e.touches && e.touches[0] ? e.touches[0].clientX : e.clientX);
        var y = (e.touches && e.touches[0] ? e.touches[0].clientY : e.clientY);
        cropDrag.active = true;
        cropDrag.startX = x;
        cropDrag.startY = y;
        cropDrag.startLeft = parseInt(profileCropImg.style.left, 10) || 0;
        cropDrag.startTop = parseInt(profileCropImg.style.top, 10) || 0;
      }
      function onCropDragMove(e) {
        if (!cropDrag.active) return;
        e.preventDefault();
        var x = (e.touches && e.touches[0] ? e.touches[0].clientX : e.clientX);
        var y = (e.touches && e.touches[0] ? e.touches[0].clientY : e.clientY);
        setCropImagePosition(cropDrag.startLeft + (x - cropDrag.startX), cropDrag.startTop + (y - cropDrag.startY));
      }
      function onCropDragEnd() { cropDrag.active = false; }

      if (profileCropViewport) {
        profileCropViewport.addEventListener('mousedown', onCropDragStart);
        profileCropViewport.addEventListener('touchstart', onCropDragStart, { passive: false });
      }
      document.addEventListener('mousemove', function (e) {
        if (cropDrag.active) onCropDragMove(e);
      });
      document.addEventListener('touchmove', function (e) {
        if (cropDrag.active) { e.preventDefault(); onCropDragMove(e); }
      }, { passive: false });
      document.addEventListener('mouseup', onCropDragEnd);
      document.addEventListener('touchend', onCropDragEnd);

      if (profileCropCancel) profileCropCancel.addEventListener('click', closeCropModal);
      if (profileCropModal) profileCropModal.addEventListener('click', function (e) { if (e.target === profileCropModal) closeCropModal(); });
      if (profileCropApply) profileCropApply.addEventListener('click', function () {
        getCroppedBlob(function (err, blob) {
          if (err) { alert(err.message); return; }
          closeCropModal();
          profilePhotoInput.value = '';
          profilePhotoBtn.disabled = true;
          var fd = new FormData();
          fd.append('avatar', blob, 'avatar.jpg');
          fetch('/api/me/avatar', { method: 'POST', credentials: 'same-origin', body: fd })
            .then(function (r) { return r.json(); })
            .then(function (data) {
              profilePhotoBtn.disabled = false;
              if (data.ok && data.profileImageUrl) {
                if (profilePhoto) profilePhoto.src = data.profileImageUrl;
                window.TornFiAuth.init().then(function () { fillInfo(window.TornFiAuth.getUser() || {}); });
              } else if (data.message) alert(data.message);
            })
            .catch(function () { profilePhotoBtn.disabled = false; });
        });
      });

      if (profilePhotoBtn && profilePhotoInput) {
        profilePhotoBtn.addEventListener('click', function () { profilePhotoInput.click(); });
        profilePhotoInput.addEventListener('change', function () {
          var file = profilePhotoInput.files && profilePhotoInput.files[0];
          if (!file) { profilePhotoInput.value = ''; return; }
          if (file.size > PROFILE_AVATAR_MAX_SIZE) { alert('í”„ë¡œí•„ ì‚¬ì§„ì€ 1MB ì´í•˜ë¡œ ì„ íƒí•´ ì£¼ì„¸ìš”.'); profilePhotoInput.value = ''; return; }
          openCropModal(file);
          profilePhotoInput.value = '';
        });
      }

      if (inputBio) inputBio.addEventListener('input', function () {
        if (bioCount) bioCount.textContent = this.value.length + '/300';
      });

      if (bioSave && inputBio) {
        bioSave.addEventListener('click', function () {
          bioMsg.style.display = 'none';
          bioErr.style.display = 'none';
          var text = inputBio.value.trim();
          fetch('/api/me', {
            method: 'PATCH',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ bio: text }),
          })
            .then(function (r) { return r.json(); })
            .then(function (data) {
              if (data.ok) {
                bioMsg.textContent = data.message || 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
                bioMsg.style.display = 'block';
                bioErr.style.display = 'none';
                if (data.user) fillInfo(data.user);
                if (bioCount) bioCount.textContent = (data.user && data.user.bio ? data.user.bio : text).length + '/300';
              } else {
                bioErr.textContent = data.message || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                bioErr.style.display = 'block';
              }
            })
            .catch(function () {
              bioErr.textContent = 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
              bioErr.style.display = 'block';
            });
        });
      }

      if (window.TornFiAuth.getUser()) {
        init();
      } else {
        window.TornFiAuth.init().then(init);
      }
    })();
  </script>
</body>
</html>
