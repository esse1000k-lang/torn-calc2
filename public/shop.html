<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#0a0a0b">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>â¤ï¸ ìƒì  | TornFi</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="manifest" href="/manifest.json">
  <script src="js/pwa-env.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/site.css">
  <style>
    .shop-page { max-width: 900px; margin: 0 auto; padding: 1.25rem 1.5rem 4rem; position: relative; z-index: 1; }
    .shop-hero {
      text-align: center; margin-bottom: 1.5rem;
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.08) 0%, rgba(0, 255, 136, 0.06) 50%, transparent 100%);
      border: 1px solid rgba(255, 215, 0, 0.2);
      border-radius: 16px;
      padding: 1.75rem 1.5rem;
      position: relative;
      overflow: hidden;
    }
    .shop-hero::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.08), transparent);
      animation: shop-shine 4s ease-in-out infinite;
      pointer-events: none;
    }
    @keyframes shop-shine {
      0%, 100% { transform: translateX(0); opacity: 0; }
      50% { transform: translateX(200%); opacity: 1; }
    }
    .shop-hero h1 { font-size: 1.5rem; font-weight: 700; color: var(--text); margin: 0 0 0.5rem 0; }
    .shop-hero p { font-size: 0.9rem; color: var(--text-muted); margin: 0; }
    .shop-balance-row { display: flex; align-items: stretch; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 1.25rem; }
    .shop-balance-box, .shop-items-box {
      display: flex; align-items: center; flex-wrap: wrap; gap: 0.5rem 0.75rem;
      padding: 1rem 1.25rem;
      background: rgba(0, 0, 0, 0.25); border: 1px solid var(--border); border-radius: 12px;
      font-size: 1rem; font-weight: 600; color: var(--text);
      position: relative;
      overflow: hidden;
    }
    .shop-balance-box::before, .shop-items-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.04), transparent);
      animation: shop-shine 5s ease-in-out infinite;
      pointer-events: none;
    }
    .shop-items-box::before { animation-delay: 0.8s; }
    .shop-balance-box { border-left: 4px solid #e53935; }
    .shop-items-box { border-left: 4px solid var(--neon); }
    .shop-balance-box__label, .shop-items-box__label { color: var(--text-muted); font-weight: 500; margin-right: 0.25rem; }
    .shop-balance { display: inline-flex; align-items: center; gap: 0.35rem; margin: 0; }
    .shop-balance .heart { color: #ff6b9d; }
    .shop-category { margin-bottom: 0; }
    .shop-item-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 1rem;
    }
    .shop-item-card {
      background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px;
      padding: 1rem;
      min-height: 140px;
      display: flex; flex-direction: column; align-items: stretch; gap: 0.5rem;
      box-sizing: border-box;
    }
    .shop-item-name { font-size: 0.85rem; font-weight: 700; color: var(--neon); margin: 0; line-height: 1.25; }
    .shop-item-desc { font-size: 0.72rem; color: var(--text-muted); line-height: 1.35; margin: 0; min-height: 2.7em; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .shop-item-price { font-size: 0.75rem; color: var(--neon); font-weight: 600; margin: 0; margin-top: auto; }
    .shop-item-price .heart { color: #ff6b9d; }
    .shop-item-btn {
      padding: 0.3rem 0.5rem; border-radius: 5px; font-size: 0.75rem; font-weight: 500; cursor: pointer;
      background: var(--neon); color: var(--bg-dark); border: none; transition: background 0.2s, opacity 0.2s;
    }
    .shop-item-btn:hover:not(:disabled) { background: var(--neon-dim); }
    .shop-item-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .shop-login-msg { text-align: center; padding: 2rem; color: var(--text-muted); }
    .shop-login-msg a { color: var(--neon); text-decoration: none; }
    .shop-items-wrap { display: inline-flex; align-items: center; flex-wrap: wrap; gap: 0 0.75rem; margin: 0; padding: 0; font-size: inherit; }
    .shop-items-list { display: inline-flex; flex-wrap: wrap; gap: 0 0.75rem; color: var(--text); }
    .shop-items-list .shop-item-badge { display: inline-flex; align-items: center; gap: 0.2rem; flex-shrink: 0; }
    .shop-items-empty { color: var(--text-muted); font-size: 0.9rem; font-weight: 400; }
    /* ë³´ìœ  ì•„ì´í…œì´ ë§ì„ ë•Œ ê°€ë¡œ ìŠ¤ì™€ì´í”„/ìŠ¤í¬ë¡¤ (ë°ìŠ¤í¬í†±Â·ëª¨ë°”ì¼ ê³µí†µ) */
    .shop-items-box { overflow-x: auto; overflow-y: hidden; -webkit-overflow-scrolling: touch; scrollbar-width: thin; touch-action: pan-x; }
    .shop-items-box .shop-items-list { flex-wrap: nowrap; white-space: nowrap; }
    @media (max-width: 768px) {
      .shop-page { padding: 1rem 1rem 4rem; }
      .shop-hero { margin-bottom: 1.25rem; padding: 1.25rem 1rem; }
      .shop-balance-row { flex-wrap: nowrap; gap: 0.5rem; margin-bottom: 1.25rem; overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: thin; }
      .shop-item-grid { gap: 0.75rem; }
      .shop-item-card { padding: 0.85rem; gap: 0.4rem; }
      .shop-balance-box, .shop-items-box { flex-wrap: nowrap; padding: 0.65rem 0.85rem; font-size: 0.9rem; gap: 0.35rem 0.5rem; }
      .shop-balance-box__label, .shop-items-box__label { display: none; }
      .shop-balance-box { flex-shrink: 0; }
      .shop-items-box { flex: 1 1 0; min-width: 0; }
      .shop-items-list { gap: 0 0.5rem; }
    }
    .shop-buy-modal { position: fixed; inset: 0; z-index: 100; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.6); }
    .shop-buy-modal.is-open { display: flex; }
    .shop-buy-modal__box { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem 1.5rem; min-width: 280px; max-width: 90vw; }
    .shop-buy-modal__title { font-size: 1rem; font-weight: 600; color: var(--text); margin: 0 0 1rem 0; }
    .shop-buy-modal__row { margin-bottom: 1rem; }
    .shop-buy-modal__row label { display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.35rem; }
    .shop-buy-modal__input { width: 100%; box-sizing: border-box; padding: 0.5rem 0.75rem; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-dark); color: var(--text); font-size: 1rem; }
    .shop-buy-modal__input:focus { outline: none; border-color: var(--neon); }
    /* êµ¬ë§¤ ìˆ˜ëŸ‰ ì…ë ¥ë€ ìŠ¤í”¼ë„ˆ(ìš°ì¸¡ í™”ì‚´í‘œ) ì œê±° - ëª¨ë“  ì•„ì´í…œ êµ¬ë§¤ ëª¨ë‹¬ì— ì ìš© */
    .shop-buy-modal input[type="number"]::-webkit-inner-spin-button,
    .shop-buy-modal input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    .shop-buy-modal input[type="number"] { -moz-appearance: textfield; appearance: textfield; }
    .shop-buy-modal__actions { display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.25rem; }
    .shop-buy-modal__btn { padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.9rem; font-weight: 500; cursor: pointer; border: none; }
    .shop-buy-modal__btn--cancel { background: var(--border); color: var(--text); }
    .shop-buy-modal__btn--confirm { background: var(--neon); color: var(--bg-dark); }
    .shop-buy-modal__btn--confirm:hover:not(:disabled) { background: var(--neon-dim); }
    .shop-buy-modal__btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .shop-toast-modal { position: fixed; inset: 0; z-index: 110; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.6); }
    .shop-toast-modal.is-open { display: flex; }
    .shop-toast-modal__box { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem 1.5rem; min-width: 260px; max-width: 90vw; }
    .shop-toast-modal__text { font-size: 0.95rem; color: var(--text); margin: 0 0 1.25rem 0; line-height: 1.45; }
    .shop-toast-modal__actions { display: flex; justify-content: flex-end; }
    .shop-toast-modal__btn { padding: 0.5rem 1.25rem; border-radius: 8px; font-size: 0.9rem; font-weight: 500; cursor: pointer; border: none; background: var(--neon); color: var(--bg-dark); }
    .shop-toast-modal__btn:hover { background: var(--neon-dim); }

    /* ìƒì  â†’ ì±„íŒ…ë°© í”Œë¡œíŒ… ë²„íŠ¼ (ìµœí•˜ë‹¨ ì¤‘ì•™) â€” êµ¬ë¦„ì²˜ëŸ¼ ë‘¥ë‘¥ */
    @keyframes shop-float-bob {
      0%, 100% { transform: translate(-50%, 0); }
      50% { transform: translate(-50%, -10px); }
    }
    .shop-float-chat {
      position: fixed;
      left: 50%;
      bottom: max(1.25rem, env(safe-area-inset-bottom, 1.25rem));
      transform: translateX(-50%);
      z-index: 90;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.85rem 1.5rem;
      font-size: 0.95rem;
      font-weight: 600;
      font-family: inherit;
      color: var(--neon);
      text-decoration: none;
      background: rgba(10, 10, 11, 0.92);
      border: 2px solid var(--neon);
      border-radius: 999px;
      box-shadow: 0 0 0 0 var(--neon-glow), 0 4px 20px rgba(0, 0, 0, 0.4);
      transition: box-shadow 0.25s ease, border-color 0.2s ease, color 0.2s ease;
      backdrop-filter: blur(8px);
      -webkit-tap-highlight-color: transparent;
      animation: shop-float-bob 4s ease-in-out infinite;
    }
    .shop-float-chat:hover {
      animation-play-state: paused;
      transform: translate(-50%, 0) scale(1.06);
      transition: transform 0.2s ease, box-shadow 0.25s ease, border-color 0.2s ease, color 0.2s ease;
      box-shadow: 0 0 24px var(--neon-glow), 0 0 40px rgba(0, 255, 136, 0.15), 0 6px 24px rgba(0, 0, 0, 0.45);
      border-color: var(--neon);
      color: var(--text);
      background: rgba(0, 255, 136, 0.12);
    }
    .shop-float-chat:active {
      transform: translate(-50%, 0) scale(1.02);
    }
    .shop-float-chat__icon {
      font-size: 1.15em;
      line-height: 1;
      opacity: 0.95;
    }
  </style>
</head>
<body>
  <nav class="site-nav">
    <div class="nav-brand">
      <a href="/" class="nav-logo">TornFi</a>
    </div>
    <a href="/admin.html" class="nav-admin-center" id="navAdminCenter" aria-label="ê´€ë¦¬ì" style="display:none;">ğŸ› ï¸</a>
    <div class="nav-menu-wrap">
      <button type="button" class="nav-menu-btn" id="navMenuBtn" aria-label="ë©”ë‰´" aria-expanded="false" aria-haspopup="true">â˜°</button>
      <div class="nav-menu-dropdown" id="navMenuDropdown" role="menu"></div>
    </div>
  </nav>

  <div class="shop-page">
    <div class="shop-hero">
      <h1>ìƒì </h1>
      <p>ë‹¤ì–‘í•œ ì•„ì´í…œì„ êµ¬ë§¤í•˜ì„¸ìš”.</p>
    </div>

    <div id="shopBalanceWrap" class="shop-balance-row" style="display:none;">
      <div class="shop-balance-box">
        <span class="shop-balance-box__label">ë³´ìœ  í•˜íŠ¸ :</span>
        <div class="shop-balance">
          <span class="heart" aria-hidden="true">â¤ï¸</span>
          <span><strong id="shopMyHearts">0</strong></span>
        </div>
      </div>
      <div id="shopItemsWrap" class="shop-items-box" style="display:none;">
        <span class="shop-items-box__label">ë³´ìœ  ì•„ì´í…œ :</span>
        <span id="shopItemsList" class="shop-items-list"></span>
      </div>
    </div>
    <p id="shopLoginMsg" class="shop-login-msg" style="display:none;">
      ë¡œê·¸ì¸í•˜ë©´ ë³´ìœ  í•˜íŠ¸ë¥¼ í™•ì¸í•˜ê³  ì•„ì´í…œì„ êµ¬ë§¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. <a href="/login.html">ë¡œê·¸ì¸</a>
    </p>

    <section class="shop-category" aria-label="ì±„íŒ… ì•„ì´í…œ">
      <div id="shopItemList" class="shop-item-grid">
        <div class="shop-item-card" data-item-id="pinMessage" data-cost="15">
          <p class="shop-item-name">ê³ ì • ë©”ì‹œì§€</p>
          <p class="shop-item-desc">ì±„íŒ… ìƒë‹¨ì— 1ì‹œê°„ ë™ì•ˆ ê³ ì •</p>
          <p class="shop-item-price"><span class="heart">â¤ï¸</span> 15 â†’ ğŸ“Œ 1</p>
          <button type="button" class="shop-item-btn" data-exchange="pinMessage">êµ¬ë§¤</button>
        </div>
        <div class="shop-item-card" data-item-id="rewardParty" data-cost="1">
          <p class="shop-item-name">ë°°ë‹¹ íŒŒí‹°</p>
          <p class="shop-item-desc">ë°°ë‹¹ ì¶•í•˜ ì• ë‹ˆë©”ì´ì…˜</p>
          <p class="shop-item-price"><span class="heart">â¤ï¸</span> 1 â†’ ğŸš 1</p>
          <button type="button" class="shop-item-btn" data-exchange="rewardParty">êµ¬ë§¤</button>
        </div>
        <div class="shop-item-card" data-item-id="risePrayer" data-cost="1">
          <p class="shop-item-name">ë–¡ìƒ ê¸°ì›</p>
          <p class="shop-item-desc">TORN ìƒìŠ¹ ê¸°ì› ì• ë‹ˆ</p>
          <p class="shop-item-price"><span class="heart">â¤ï¸</span> 1 â†’ ğŸ™ 1</p>
          <button type="button" class="shop-item-btn" data-exchange="risePrayer">êµ¬ë§¤</button>
        </div>
        <div class="shop-item-card" data-item-id="broom" data-cost="10">
          <p class="shop-item-name">ë¹—ìë£¨</p>
          <p class="shop-item-desc">ì±„íŒ… ì „ì²´ ì‚­ì œ (ê³ ì • ì œì™¸)</p>
          <p class="shop-item-price"><span class="heart">â¤ï¸</span> 10 â†’ ğŸ§¹ 1</p>
          <button type="button" class="shop-item-btn" data-exchange="broom">êµ¬ë§¤</button>
        </div>
      </div>
    </section>
  </div>

  <div id="shopBuyModal" class="shop-buy-modal" role="dialog" aria-labelledby="shopBuyModalTitle" aria-modal="true">
    <div class="shop-buy-modal__box">
      <p id="shopBuyModalTitle" class="shop-buy-modal__title">ëª‡ ê°œ êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
      <div class="shop-buy-modal__row">
        <label for="shopBuyQuantity">ìˆ˜ëŸ‰ (1~5)</label>
        <input type="number" id="shopBuyQuantity" class="shop-buy-modal__input" min="1" max="5" value="1" step="1" aria-label="êµ¬ë§¤ ìˆ˜ëŸ‰">
      </div>
      <div class="shop-buy-modal__actions">
        <button type="button" id="shopBuyCancel" class="shop-buy-modal__btn shop-buy-modal__btn--cancel">ì·¨ì†Œ</button>
        <button type="button" id="shopBuyConfirm" class="shop-buy-modal__btn shop-buy-modal__btn--confirm">í™•ì¸</button>
      </div>
    </div>
  </div>

  <div id="shopToastModal" class="shop-toast-modal" role="alertdialog" aria-live="polite" aria-modal="true">
    <div class="shop-toast-modal__box">
      <p id="shopToastText" class="shop-toast-modal__text"></p>
      <div class="shop-toast-modal__actions">
        <button type="button" id="shopToastOk" class="shop-toast-modal__btn">í™•ì¸</button>
      </div>
    </div>
  </div>

  <a href="/chat.html" class="shop-float-chat" aria-label="ì±„íŒ…ë°©ìœ¼ë¡œ ì´ë™">
    <span class="shop-float-chat__icon" aria-hidden="true">ğŸ’¬</span>
    <span>GO</span>
  </a>

  <script src="js/auth.js"></script>
  <script src="js/nav-logo.js"></script>
  <script>
    (function () {
      var shopBalanceWrap = document.getElementById('shopBalanceWrap');
      var shopMyHearts = document.getElementById('shopMyHearts');
      var shopItemsWrap = document.getElementById('shopItemsWrap');
      var shopItemsList = document.getElementById('shopItemsList');
      // ì•„ì´í…œ ì •ë³´ëŠ” ì„œë²„(DB) ì „ìš© â€” localStorage ì‚¬ìš© ì•ˆ í•¨
      var shopLoginMsg = document.getElementById('shopLoginMsg');
      var user = window.TornFiAuth && window.TornFiAuth.getUser();

      var shopToastModal = document.getElementById('shopToastModal');
      var shopToastText = document.getElementById('shopToastText');
      var shopToastOk = document.getElementById('shopToastOk');
      function showShopToast(message) {
        if (shopToastText) shopToastText.textContent = message || '';
        if (shopToastModal) shopToastModal.classList.add('is-open');
      }
      function closeShopToast() {
        if (shopToastModal) shopToastModal.classList.remove('is-open');
      }
      if (shopToastOk) shopToastOk.addEventListener('click', closeShopToast);
      if (shopToastModal && shopToastModal.querySelector('.shop-toast-modal__box')) {
        shopToastModal.addEventListener('click', function (e) {
          if (e.target === shopToastModal) closeShopToast();
        });
      }

      var lastShopItems = {};
      function renderShopItems(shopItems) {
        if (!shopItemsList) return;
        lastShopItems = shopItems && typeof shopItems === 'object' ? shopItems : {};
        var items = [];
        var pinMessage = (lastShopItems.pinMessage != null && typeof lastShopItems.pinMessage === 'number') ? lastShopItems.pinMessage : 0;
        if (pinMessage > 0) items.push('<span class="shop-item-badge" title="ê³ ì • ë©”ì‹œì§€">ğŸ“Œ <strong>' + pinMessage + '</strong></span>');
        var rewardParty = (lastShopItems.rewardParty != null && typeof lastShopItems.rewardParty === 'number') ? lastShopItems.rewardParty : 0;
        if (rewardParty > 0) items.push('<span class="shop-item-badge" title="ë°°ë‹¹ íŒŒí‹°">ğŸš <strong>' + rewardParty + '</strong></span>');
        var risePrayer = (lastShopItems.risePrayer != null && typeof lastShopItems.risePrayer === 'number') ? lastShopItems.risePrayer : 0;
        if (risePrayer > 0) items.push('<span class="shop-item-badge" title="ë–¡ìƒ ê¸°ì›">ğŸ™ <strong>' + risePrayer + '</strong></span>');
        var broom = (lastShopItems.broom != null && typeof lastShopItems.broom === 'number') ? lastShopItems.broom : 0;
        if (broom > 0) items.push('<span class="shop-item-badge" title="ë¹—ìë£¨">ğŸ§¹ <strong>' + broom + '</strong></span>');
        shopItemsList.innerHTML = items.length ? items.join('') : '<span class="shop-items-empty">ë³´ìœ í•œ ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.</span>';
        if (shopItemsWrap) shopItemsWrap.style.display = 'inline-flex';
      }

      function loadBalance() {
        if (!user) {
          if (shopBalanceWrap) shopBalanceWrap.style.display = 'none';
          if (shopItemsWrap) shopItemsWrap.style.display = 'none';
          shopLoginMsg.style.display = 'block';
          return;
        }
        shopLoginMsg.style.display = 'none';
        fetch('/api/me', { credentials: 'same-origin' })
          .then(function (r) { return r.json(); })
          .then(function (data) {
            var hearts = (data.ok && data.user && typeof data.user.points === 'number') ? data.user.points : 0;
            shopMyHearts.textContent = hearts;
            if (shopBalanceWrap) shopBalanceWrap.style.display = 'flex';
            if (data.ok && data.user) renderShopItems(data.user.shopItems || {});
            updateExchangeButtons(hearts, lastShopItems);
          })
          .catch(function () {
            shopMyHearts.textContent = 'â€”';
            if (shopBalanceWrap) shopBalanceWrap.style.display = 'flex';
          });
      }

      function updateExchangeButtons(myHearts, shopItems) {
        shopItems = shopItems || lastShopItems || {};
        document.querySelectorAll('.shop-item-card[data-cost]').forEach(function (card) {
          var itemId = card.getAttribute('data-item-id');
          var cost = parseInt(card.getAttribute('data-cost'), 10);
          var owned = (shopItems[itemId] != null && typeof shopItems[itemId] === 'number') ? shopItems[itemId] : 0;
          var btn = card.querySelector('.shop-item-btn[data-exchange]');
          if (btn) btn.disabled = myHearts < cost || owned >= 5;
        });
      }

      var shopBuyModal = document.getElementById('shopBuyModal');
      var shopBuyQuantity = document.getElementById('shopBuyQuantity');
      var shopBuyCancel = document.getElementById('shopBuyCancel');
      var shopBuyConfirm = document.getElementById('shopBuyConfirm');
      var pendingBuy = { card: null, btn: null, itemId: null, cost: 0 };

      function openBuyModal(card, btn, itemId, cost) {
        var owned = (lastShopItems[itemId] != null && typeof lastShopItems[itemId] === 'number') ? lastShopItems[itemId] : 0;
        var maxBuy = Math.max(0, 5 - owned);
        if (maxBuy <= 0) {
          showShopToast('ì´ ì•„ì´í…œì€ ì¢…ë¥˜ë‹¹ ìµœëŒ€ 5ê°œê¹Œì§€ ë³´ìœ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
          return;
        }
        pendingBuy = { card: card, btn: btn, itemId: itemId, cost: cost };
        if (shopBuyQuantity) {
          shopBuyQuantity.value = '1';
          shopBuyQuantity.min = '1';
          shopBuyQuantity.max = String(maxBuy);
        }
        var label = document.querySelector('.shop-buy-modal__row label[for="shopBuyQuantity"]');
        if (label) label.textContent = maxBuy === 1 ? 'ìˆ˜ëŸ‰ (1ê°œ)' : 'ìˆ˜ëŸ‰ (1~' + maxBuy + 'ê°œ)';
        if (shopBuyModal) shopBuyModal.classList.add('is-open');
        if (shopBuyQuantity) shopBuyQuantity.focus();
      }
      function closeBuyModal() {
        pendingBuy = { card: null, btn: null, itemId: null, cost: 0 };
        if (shopBuyModal) shopBuyModal.classList.remove('is-open');
      }
      if (shopBuyQuantity) {
        shopBuyQuantity.addEventListener('input', function () {
          var max = parseInt(shopBuyQuantity.getAttribute('max'), 10) || 5;
          var n = parseInt(shopBuyQuantity.value, 10);
          if (isNaN(n) || n < 1) shopBuyQuantity.value = '1';
          else if (n > max) shopBuyQuantity.value = String(max);
        });
      }
      if (shopBuyCancel) shopBuyCancel.addEventListener('click', closeBuyModal);
      if (shopBuyModal && shopBuyModal.querySelector('.shop-buy-modal__box')) {
        shopBuyModal.addEventListener('click', function (e) {
          if (e.target === shopBuyModal) closeBuyModal();
        });
      }
      if (shopBuyConfirm) shopBuyConfirm.addEventListener('click', function () {
        var itemId = pendingBuy.itemId;
        var cost = pendingBuy.cost;
        var btn = pendingBuy.btn;
        if (!itemId || !cost) return;
        var maxQty = parseInt(shopBuyQuantity.getAttribute('max'), 10) || 5;
        var qty = parseInt(shopBuyQuantity.value, 10) || 1;
        qty = Math.min(maxQty, Math.max(1, qty));
        var myHearts = parseInt(shopMyHearts.textContent, 10) || 0;
        if (myHearts < cost * qty) {
          showShopToast('ë³´ìœ  í•˜íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.');
          return;
        }
        closeBuyModal();
        btn.disabled = true;
        shopBuyConfirm.disabled = true;
        fetch('/api/shop/exchange', {
          method: 'POST',
          credentials: 'same-origin',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ itemId: itemId, quantity: qty }),
        })
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (data.ok) {
              if (typeof data.myHearts === 'number') shopMyHearts.textContent = data.myHearts;
              if (data.myShopItems != null && typeof data.myShopItems === 'object') {
                renderShopItems(data.myShopItems);
                updateExchangeButtons(data.myHearts, data.myShopItems);
              } else {
                loadBalance();
              }
              showShopToast(data.message || 'êµ¬ë§¤ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else {
              showShopToast(data.message || 'êµ¬ë§¤ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
          })
          .catch(function () { showShopToast('êµ¬ë§¤ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); })
          .finally(function () { btn.disabled = false; shopBuyConfirm.disabled = false; });
      });

      document.getElementById('shopItemList').addEventListener('click', function (e) {
        var btn = e.target.closest('.shop-item-btn[data-exchange]');
        if (!btn) return;
        var card = btn.closest('.shop-item-card');
        var itemId = card && card.getAttribute('data-item-id');
        var cost = card ? parseInt(card.getAttribute('data-cost'), 10) : 0;
        var myHearts = parseInt(shopMyHearts.textContent, 10) || 0;
        if (myHearts < cost) {
          showShopToast('ë³´ìœ  í•˜íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.');
          return;
        }
        openBuyModal(card, btn, itemId, cost);
      });

      if (window.TornFiAuth && window.TornFiAuth.onUser) {
        window.TornFiAuth.onUser(function (u) { user = u; loadBalance(); });
      }
      loadBalance();

      var navAdminCenter = document.getElementById('navAdminCenter');
      var navMenuBtn = document.getElementById('navMenuBtn');
      function updateNav(u) {
        if (u) {
          if (navMenuBtn) navMenuBtn.style.display = 'none';
          if (navAdminCenter) navAdminCenter.style.display = u.isAdmin ? 'inline-flex' : 'none';
        } else {
          if (navMenuBtn) navMenuBtn.style.display = 'none';
          if (navAdminCenter) navAdminCenter.style.display = 'none';
        }
      }
      if (window.TornFiAuth && window.TornFiAuth.getUser()) updateNav(window.TornFiAuth.getUser());
      if (window.TornFiAuth && window.TornFiAuth.onUser) window.TornFiAuth.onUser(updateNav);
      var navMenuDropdown = document.getElementById('navMenuDropdown');
      if (navMenuBtn && navMenuDropdown) {
        navMenuBtn.addEventListener('click', function (e) { e.stopPropagation(); navMenuDropdown.classList.toggle('is-open'); navMenuBtn.setAttribute('aria-expanded', navMenuDropdown.classList.contains('is-open')); });
        navMenuDropdown.addEventListener('click', function (e) { e.stopPropagation(); });
        document.addEventListener('click', function () { navMenuDropdown.classList.remove('is-open'); navMenuBtn.setAttribute('aria-expanded', 'false'); });
      }
    })();
  </script>
</body>
</html>
