<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#0a0a0b">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="TornFi">
  <title>TornFi ì»¤ë®¤ë‹ˆí‹°</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" href="favicon.ico">
  <link rel="manifest" href="/manifest.json">
  <script src="js/pwa-env.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/site.css?v=3">
</head>
<body>
  <nav class="site-nav">
    <div class="nav-brand">
      <a href="/" class="nav-logo">TornFi</a>
    </div>
    <a href="/admin.html" class="nav-admin-center" id="navAdminCenter" aria-label="ê´€ë¦¬ì" style="display:none;">ğŸ› ï¸</a>
    <div class="nav-menu-wrap">
      <button type="button" class="nav-menu-btn" id="navMenuBtn" aria-label="ë©”ë‰´" aria-expanded="false" aria-haspopup="true">â˜°</button>
      <div class="nav-menu-dropdown" id="navMenuDropdown" role="menu"></div>
    </div>
  </nav>

  <main class="site-main">
    <div class="mobile-home-menu" id="mobileHomeMenu" aria-label="ëª¨ë°”ì¼ í™ˆ ë©”ë‰´">
      <div class="mobile-home-menu__header">
        <a href="/board.html" class="mobile-home-menu__search" aria-label="ê°€ì´ë“œ ê²€ìƒ‰">ê²€ìƒ‰</a>
      </div>
      <nav class="mobile-home-menu__grid" aria-label="ì„œë¹„ìŠ¤ ë©”ë‰´">
        <a href="/chat.html" class="mobile-home-menu__item">
          <span class="mobile-home-menu__icon" aria-hidden="true">ğŸ’¬</span>
          <span class="mobile-home-menu__label">í­í’ ìˆ˜ë‹¤</span>
        </a>
        <a href="/ranking.html" class="mobile-home-menu__item">
          <span class="mobile-home-menu__icon" aria-hidden="true">ğŸ†</span>
          <span class="mobile-home-menu__label">ë­í‚¹</span>
        </a>
        <a href="/attendance.html" class="mobile-home-menu__item">
          <span class="mobile-home-menu__icon" aria-hidden="true">ğŸ“…</span>
          <span class="mobile-home-menu__label">ì¶œì„ì²´í¬</span>
        </a>
        <a href="/board.html" class="mobile-home-menu__item">
          <span class="mobile-home-menu__icon" aria-hidden="true">âœ…</span>
          <span class="mobile-home-menu__label">ê°€ì´ë“œ</span>
        </a>
        <a href="/calculator.html" class="mobile-home-menu__item">
          <span class="mobile-home-menu__icon" aria-hidden="true">ğŸ”</span>
          <span class="mobile-home-menu__label">ë°°ë‹¹ ì¡°íšŒ</span>
        </a>
        <a href="/tornado-news.html" class="mobile-home-menu__item">
          <span class="mobile-home-menu__icon" aria-hidden="true">ğŸŒªï¸</span>
          <span class="mobile-home-menu__label">ë‰´ìŠ¤</span>
        </a>
        <a href="/member-grade.html" class="mobile-home-menu__item">
          <span class="mobile-home-menu__icon" aria-hidden="true">ğŸ–ï¸</span>
          <span class="mobile-home-menu__label">íšŒì› ë“±ê¸‰</span>
        </a>
      </nav>
      <div class="mobile-home-menu__actions">
        <a href="/login.html" class="mobile-home-menu__btn mobile-home-menu__btn--primary" id="mobileHomeLogin">ë¡œê·¸ì¸</a>
        <a href="/register.html" class="mobile-home-menu__btn mobile-home-menu__btn--secondary" id="mobileHomeRegister">íšŒì›ê°€ì…</a>
        <a href="/profile.html" class="mobile-home-menu__btn mobile-home-menu__btn--primary" id="mobileHomeProfile" style="display:none;">ë‚´ ì •ë³´</a>
        <button type="button" class="mobile-home-menu__btn mobile-home-menu__btn--secondary" id="mobileHomeLogout" style="display:none;">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>
    <section id="feedSection" class="section feed-section">
      <div id="feedCompose" class="feed-compose" style="display:none;" aria-label="ìƒˆ ê¸€ ì‘ì„±">
        <div class="feed-compose__inner">
          <div class="feed-compose__avatar-wrap" id="feedComposeAvatarWrap">
          <img class="feed-compose__avatar-img" id="feedComposeAvatarImg" src="" alt="" style="display:none;">
          <span class="feed-compose__avatar feed-compose__avatar--letter" id="feedComposeAvatar" aria-hidden="true">?</span>
        </div>
          <div class="feed-compose__body">
            <textarea id="feedComposeText" class="feed-compose__input" placeholder="ë¨¸ì„ 129...?" rows="3" maxlength="10000" aria-label="ê¸€ ë‚´ìš©"></textarea>
            <div class="feed-compose__actions">
              <div class="feed-compose__actions-left">
                <input type="file" id="feedComposeImage" accept="image/jpeg,image/png,image/gif,image/webp" multiple style="position:absolute;width:1px;height:1px;opacity:0;overflow:hidden;">
                <button type="button" class="feed-compose__action-btn" id="feedComposeImageBtn" aria-label="ì´ë¯¸ì§€ ì²¨ë¶€">ğŸ–¼ï¸</button>
              </div>
              <div class="feed-compose__preview" id="feedComposePreview"></div>
              <button type="button" class="feed-compose__submit" id="feedComposeSubmit" disabled>ê²Œì‹œí•˜ê¸°</button>
            </div>
          </div>
        </div>
      </div>
      <p class="text-muted feed-loading" id="feedLoading">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</p>
      <p class="text-muted feed-empty" id="feedEmpty" style="display:none;">ì•„ì§ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ê¸€ì„ ì˜¬ë ¤ ë³´ì„¸ìš”!</p>
      <div id="feedList" class="feed-list" aria-live="polite"></div>
      <div class="feed-more-wrap" id="feedMoreWrap" style="display:none;">
        <button type="button" id="feedMoreBtn" class="feed-more-btn">ë” ë³´ê¸°</button>
      </div>
    </section>

    <div id="feedSendHeartLayer" class="feed-send-heart-layer" style="display:none;">
      <div class="feed-send-heart-box">
        <h3 class="feed-send-heart-title">â¤ï¸ í•˜íŠ¸ ë³´ë‚´ê¸°</h3>
        <p id="feedSendHeartMessage" class="feed-send-heart-message"></p>
        <p id="feedSendHeartMyHearts" class="feed-send-heart-myhearts"></p>
        <div class="feed-send-heart-actions">
          <button type="button" id="feedSendHeartCancel" class="feed-send-heart-btn feed-send-heart-btn--cancel">ì·¨ì†Œ</button>
          <button type="button" id="feedSendHeartOk" class="feed-send-heart-btn feed-send-heart-btn--ok">ë³´ë‚´ê¸°</button>
        </div>
      </div>
    </div>

    <div id="feedAuthorPopover" class="feed-author-popover" role="tooltip" aria-hidden="true" style="display:none;">
      <div class="feed-author-popover__inner">
        <div class="feed-author-popover__avatar-wrap"></div>
        <div class="feed-author-popover__name"></div>
        <div class="feed-author-popover__level"></div>
        <div class="feed-author-popover__hearts"></div>
        <p class="feed-author-popover__bio"></p>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    Copyright 2025-2026 TornFi. All rights reserved.
    <div class="site-footer-withdraw" id="footerWithdrawWrap" style="display:none;">
      <button type="button" id="footerWithdrawBtn">íšŒì›íƒˆí‡´</button>
    </div>
  </footer>

  <div id="feedDeleteConfirmLayer" class="feed-delete-confirm-layer" style="display:none;" aria-modal="true" role="dialog" aria-labelledby="feedDeleteConfirmTitle">
    <div class="feed-delete-confirm-box">
      <h3 id="feedDeleteConfirmTitle" class="feed-delete-confirm-title">í”¼ë“œ ì‚­ì œ</h3>
      <p class="feed-delete-confirm-msg">ì´ í”¼ë“œ ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
      <div class="feed-delete-confirm-actions">
        <button type="button" id="feedDeleteConfirmCancel" class="feed-delete-confirm-btn feed-delete-confirm-btn--cancel">ì·¨ì†Œ</button>
        <button type="button" id="feedDeleteConfirmOk" class="feed-delete-confirm-btn feed-delete-confirm-btn--ok">ì‚­ì œ</button>
      </div>
    </div>
  </div>

  <div id="feedAdminPinLayer" class="feed-admin-pin-layer" style="display:none;" aria-modal="true" role="dialog" aria-labelledby="feedAdminPinTitle">
    <div class="feed-admin-pin-box">
      <h3 id="feedAdminPinTitle" class="feed-delete-confirm-title">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</h3>
      <p class="feed-admin-pin-desc">í”¼ë“œ ì‚­ì œë¥¼ ìœ„í•´ 6ìë¦¬ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
      <p id="feedAdminPinErr" class="feed-admin-pin-err" style="display:none;"></p>
      <input type="password" id="feedAdminPinInput" class="feed-admin-pin-input" inputmode="numeric" pattern="[0-9]*" maxlength="6" placeholder="******" autocomplete="off" aria-label="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸">
      <div class="feed-delete-confirm-actions">
        <button type="button" id="feedAdminPinCancel" class="feed-delete-confirm-btn feed-delete-confirm-btn--cancel">ì·¨ì†Œ</button>
        <button type="button" id="feedAdminPinOk" class="feed-delete-confirm-btn feed-delete-confirm-btn--ok">í™•ì¸</button>
      </div>
    </div>
  </div>

  <div id="withdrawConfirmLayer" class="withdraw-confirm-layer" style="display:none;">
    <div class="withdraw-confirm-box">
      <h3>íšŒì›íƒˆí‡´</h3>
      <p class="withdraw-confirm-warn">íƒˆí‡´í•œ ì§€ê°‘ìœ¼ë¡œëŠ” ì¬ê°€ì…í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì •ë§ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
      <label class="withdraw-confirm-pin-label" for="withdrawConfirmPassword">ë¡œê·¸ì¸ ë¹„ë°€ë²ˆí˜¸</label>
      <input type="password" id="withdrawConfirmPassword" placeholder="ë¡œê·¸ì¸ ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password" class="withdraw-confirm-pin-input" aria-label="ë¡œê·¸ì¸ ë¹„ë°€ë²ˆí˜¸" style="letter-spacing:normal;">
      <p id="withdrawConfirmPasswordErr" class="withdraw-confirm-pin-err" style="display:none;"></p>
      <div class="withdraw-confirm-actions">
        <button type="button" id="withdrawConfirmCancel" class="btn-cancel">ì·¨ì†Œ</button>
        <button type="button" id="withdrawConfirmOk" class="btn-confirm">íƒˆí‡´í•˜ê¸°</button>
      </div>
    </div>
  </div>

  <div id="withdrawnGoodbyeLayer" class="withdrawn-goodbye-layer" style="display:none;">
    <div class="withdrawn-goodbye-card">
      <div class="withdrawn-goodbye-icon" aria-hidden="true">ğŸ‘‹</div>
      <h2 class="withdrawn-goodbye-title">ê·¸ë™ì•ˆ ì´ìš©í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤</h2>
      <p class="withdrawn-goodbye-desc">TornFi ì»¤ë®¤ë‹ˆí‹°ì™€ í•¨ê»˜í•´ ì£¼ì…”ì„œ ê°ì‚¬í–ˆìŠµë‹ˆë‹¤.<br>ì•ìœ¼ë¡œë„ ì¢‹ì€ ì¼ë§Œ ê°€ë“í•˜ì‹œê¸¸ ë°”ëë‹ˆë‹¤.</p>
      <p class="withdrawn-goodbye-bye">ê³ ë§™ìŠµë‹ˆë‹¤.</p>
      <a href="/" id="withdrawnGoodbyeBtn" class="withdrawn-goodbye-btn">í™•ì¸</a>
    </div>
  </div>

  <script src="js/auth.js"></script>
  <script src="js/nav-logo.js"></script>
  <script>
    (function () {
      var navAdminCenter = document.getElementById('navAdminCenter');
      var navMenuBtn = document.getElementById('navMenuBtn');
      var mobileHomeLogin = document.getElementById('mobileHomeLogin');
      var mobileHomeRegister = document.getElementById('mobileHomeRegister');
      var mobileHomeProfile = document.getElementById('mobileHomeProfile');
      var mobileHomeLogout = document.getElementById('mobileHomeLogout');
      function updateNav(user) {
        if (user) {
          if (navMenuBtn) navMenuBtn.style.display = 'none';
          if (navAdminCenter) navAdminCenter.style.display = user.isAdmin ? 'inline-flex' : 'none';
          if (mobileHomeLogin) mobileHomeLogin.style.display = 'none';
          if (mobileHomeRegister) mobileHomeRegister.style.display = 'none';
          if (mobileHomeProfile) mobileHomeProfile.style.display = 'block';
          if (mobileHomeLogout) mobileHomeLogout.style.display = 'block';
        } else {
          if (navMenuBtn) navMenuBtn.style.display = 'none';
          if (navAdminCenter) navAdminCenter.style.display = 'none';
          if (mobileHomeLogin) mobileHomeLogin.style.display = 'block';
          if (mobileHomeRegister) mobileHomeRegister.style.display = 'block';
          if (mobileHomeProfile) mobileHomeProfile.style.display = 'none';
          if (mobileHomeLogout) mobileHomeLogout.style.display = 'none';
        }
      }
      window.TornFiAuth.onUser(function (user) {
        updateNav(user);
        var wrap = document.getElementById('footerWithdrawWrap');
        if (wrap) wrap.style.display = user ? 'block' : 'none';
      });

      var navMenuDropdown = document.getElementById('navMenuDropdown');
      if (navMenuBtn && navMenuDropdown) {
        navMenuBtn.addEventListener('click', function (e) {
          e.stopPropagation();
          var open = navMenuDropdown.classList.toggle('is-open');
          navMenuBtn.setAttribute('aria-expanded', open);
        });
        navMenuDropdown.addEventListener('click', function (e) { e.stopPropagation(); });
        document.addEventListener('click', function () {
          navMenuDropdown.classList.remove('is-open');
          navMenuBtn.setAttribute('aria-expanded', 'false');
        });
      }
      if (mobileHomeLogout) {
        mobileHomeLogout.addEventListener('click', function (e) {
          e.preventDefault();
          if (!confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
          window.TornFiAuth.logout().then(function () { updateNav(null); window.location.href = '/'; });
        });
      }

      (function setupWithdrawConfirm() {
        var layer = document.getElementById('withdrawConfirmLayer');
        var btn = document.getElementById('footerWithdrawBtn');
        var cancelBtn = document.getElementById('withdrawConfirmCancel');
        var okBtn = document.getElementById('withdrawConfirmOk');
        var passwordInput = document.getElementById('withdrawConfirmPassword');
        var passwordErr = document.getElementById('withdrawConfirmPasswordErr');
        if (!layer || !btn || !okBtn) return;
        btn.addEventListener('click', function () {
          if (passwordInput) passwordInput.value = '';
          if (passwordErr) { passwordErr.style.display = 'none'; passwordErr.textContent = ''; }
          layer.style.display = 'flex';
          if (passwordInput) passwordInput.focus();
        });
        cancelBtn.addEventListener('click', function () {
          layer.style.display = 'none';
        });
        okBtn.addEventListener('click', function () {
          var passwordVal = passwordInput ? passwordInput.value : '';
          if (!passwordVal.trim()) {
            if (passwordErr) { passwordErr.textContent = 'ë¡œê·¸ì¸ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.'; passwordErr.style.display = 'block'; }
            return;
          }
          if (passwordErr) { passwordErr.style.display = 'none'; passwordErr.textContent = ''; }
          okBtn.disabled = true;
          fetch('/api/withdraw', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password: passwordVal }),
          })
            .then(function (r) { return r.json(); })
            .then(function (data) {
              okBtn.disabled = false;
              if (data.ok) {
                layer.style.display = 'none';
                window.TornFiAuth.logout().then(function () {
                  window.location.href = '/?withdrawn=1';
                });
              } else {
                if (passwordErr) { passwordErr.textContent = data.message || 'íƒˆí‡´ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'; passwordErr.style.display = 'block'; }
              }
            })
            .catch(function () {
              layer.style.display = 'none';
              okBtn.disabled = false;
              alert('ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        });
      })();

      (function setupWithdrawnGoodbye() {
        var params = new URLSearchParams(window.location.search);
        if (params.get('withdrawn') !== '1') return;
        var layer = document.getElementById('withdrawnGoodbyeLayer');
        var btn = document.getElementById('withdrawnGoodbyeBtn');
        if (!layer) return;
        layer.style.display = 'flex';
        if (btn) {
          btn.addEventListener('click', function (e) {
            e.preventDefault();
            layer.style.display = 'none';
            history.replaceState(null, '', window.location.pathname || '/');
          });
        }
      })();

      (function initFeed() {
        var feedList = document.getElementById('feedList');
        var feedLoading = document.getElementById('feedLoading');
        var feedEmpty = document.getElementById('feedEmpty');
        var feedMoreWrap = document.getElementById('feedMoreWrap');
        var feedMoreBtn = document.getElementById('feedMoreBtn');
        var FEED_PAGE_SIZE = 20;
        var currentOffset = 0;
        var totalLoaded = 0;
        var totalPosts = 0;
        var feedPostsById = {};

        function escapeHtml(s) {
          if (!s) return '';
          var div = document.createElement('div');
          div.textContent = s;
          return div.innerHTML;
        }
        function excerpt(text, maxLen) {
          if (!text) return '';
          var plain = text.replace(/\s+/g, ' ').trim();
          if (plain.length <= maxLen) return escapeHtml(plain);
          return escapeHtml(plain.substring(0, maxLen)) + 'â€¦';
        }
        function formatDate(iso) {
          if (!iso) return '';
          var d = new Date(iso);
          var now = new Date();
          var diff = now - d;
          if (diff < 60000) return 'ë°©ê¸ˆ ì „';
          if (diff < 3600000) return Math.floor(diff / 60000) + 'ë¶„ ì „';
          if (diff < 86400000) return Math.floor(diff / 3600000) + 'ì‹œê°„ ì „';
          if (diff < 604800000) return Math.floor(diff / 86400000) + 'ì¼ ì „';
          return d.toLocaleDateString('ko-KR');
        }
        var LEVEL_EMOJI = { 1: 'ğŸš', 2: 'ğŸ¦', 3: 'ğŸ¡', 4: 'ğŸ¦­', 5: 'ğŸ¦ˆ', 6: 'ğŸ‹' };
        var LEVEL_NAMES = { 1: 'ì¡°ê°œ', 2: 'ìƒˆìš°', 3: 'ë¬¸ì–´', 4: 'ë¬¼ê°œ', 5: 'ìƒì–´', 6: 'ê³ ë˜' };
        function renderCard(p, myId, isAdmin) {
          var author = p.authorDisplayName || 'â€”';
          var isMine = !!(myId && p.authorId === myId);
          var heartsReceived = (p.heartsReceived || 0) > 0 ? (p.heartsReceived || 0) : 0;
          var comments = p.comments || [];
          var lv = (p.authorLevel >= 1 && p.authorLevel <= 6) ? p.authorLevel : 0;
          var levelEmoji = LEVEL_EMOJI[lv] || '';
          var avatarHtml = (p.authorProfileImageUrl && p.authorProfileImageUrl.trim())
            ? '<img class="feed-card__avatar feed-card__avatar--img" src="' + escapeHtml(p.authorProfileImageUrl) + '" alt="" loading="lazy">'
            : '<span class="feed-card__avatar" aria-hidden="true">' + (author.charAt(0) || '?') + '</span>';
          var bodyExcerpt = excerpt(p.body, 200);
          var dateStr = formatDate(p.createdAt);
          var img = (p.images && p.images[0]) ? '<img src="' + escapeHtml(p.images[0]) + '" alt="" class="feed-card__thumb" loading="lazy">' : '';
          var footer = '<div class="feed-card__footer">';
          if (heartsReceived > 0) footer += '<span class="feed-card__hearts">â¤ï¸ ' + heartsReceived + '</span>';
          footer += '</div>';
          var topActionsHtml = (!isMine && myId) ? '<div class="feed-card__top-actions"><button type="button" class="feed-card-heart-btn" data-post-id="' + escapeHtml(p.id) + '" data-author-name="' + escapeHtml(author) + '">â¤ï¸ ë³´ë‚´ê¸°</button></div>' : '';
          var adminDeleteBtn = isAdmin ? '<div class="feed-card-admin-outer"><button type="button" class="feed-card__admin-delete" data-post-id="' + escapeHtml(p.id) + '" aria-label="í”¼ë“œ ì‚­ì œ">ğŸ—‘ ì‚­ì œ</button></div>' : '';
          var commentsHtml = '<div class="feed-card__comments">ëŒ“ê¸€ ' + comments.length + 'ê°œ</div>';
          var cardInner =
            '<article class="feed-card" data-post-id="' + escapeHtml(p.id) + '" data-author-id="' + escapeHtml(p.authorId || '') + '">' +
              '<a href="feed-post.html?id=' + encodeURIComponent(p.id) + '" class="feed-card__link">' +
                '<div class="feed-card__top">' +
                  avatarHtml +
                  '<div class="feed-card__content">' +
                    '<div class="feed-card__meta-row">' +
                      '<div class="feed-card__meta">' +
                        '<span class="feed-card__meta-name">' +
                          '<span class="feed-card__author">' + escapeHtml(author) + '</span>' +
                          (levelEmoji ? '<span class="feed-card__level" aria-hidden="true">' + levelEmoji + '</span>' : '') +
                        '</span>' +
                        '<span class="feed-card__meta-sep" aria-hidden="true">Â·</span>' +
                        '<time class="feed-card__date" datetime="' + (p.createdAt || '') + '">' + dateStr + '</time>' +
                      '</div>' +
                      (topActionsHtml || '') +
                    '</div>' +
                    (bodyExcerpt ? '<div class="feed-card__body"><p class="feed-card__excerpt">' + bodyExcerpt + '</p></div>' : '') +
                    (img ? '<div class="feed-card__thumb-wrap">' + img + '</div>' : '') +
                    '<div class="feed-card__actions">' + footer + commentsHtml + '</div>' +
                  '</div>' +
                '</div>' +
              '</a>' +
            '</article>';
          return isAdmin ? '<div class="feed-card-wrap">' + cardInner + adminDeleteBtn + '</div>' : cardInner;
        }
        function loadFeed(append) {
          if (!append) { currentOffset = 0; totalLoaded = 0; }
          if (!append && feedLoading) feedLoading.style.display = 'block';
          if (!append && feedEmpty) feedEmpty.style.display = 'none';
          fetch('/api/feed?limit=' + FEED_PAGE_SIZE + '&offset=' + currentOffset, { credentials: 'same-origin' })
            .then(function (r) { return r.json(); })
            .then(function (data) {
              if (feedLoading) feedLoading.style.display = 'none';
              if (!data.ok) { if (feedEmpty) feedEmpty.style.display = 'block'; return; }
              var posts = data.posts || [];
              totalPosts = data.total != null ? data.total : totalLoaded + posts.length;
              if (posts.length === 0 && !append) {
                if (feedEmpty) feedEmpty.style.display = 'block';
                return;
              }
              if (feedEmpty) feedEmpty.style.display = 'none';
              posts.forEach(function (p) { if (p && p.id) feedPostsById[p.id] = p; });
              var me = (window.TornFiAuth && window.TornFiAuth.getUser()) || null;
              var myId = me ? (me.id || null) : null;
              var isAdmin = !!(me && me.isAdmin);
              var html = posts.map(function (p) { return renderCard(p, myId, isAdmin); }).join('');
              if (append && feedList) {
                var wrap = document.createElement('div');
                wrap.className = 'feed-list__page';
                wrap.innerHTML = html;
                feedList.appendChild(wrap);
              } else if (feedList) {
                feedList.innerHTML = '<div class="feed-list__page">' + html + '</div>';
              }
              totalLoaded += posts.length;
              currentOffset += posts.length;
              if (feedMoreWrap) {
                feedMoreWrap.style.display = (currentOffset < totalPosts) ? 'block' : 'none';
              }
            })
            .catch(function () {
              if (feedLoading) feedLoading.style.display = 'none';
              if (feedEmpty) { feedEmpty.textContent = 'ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'; feedEmpty.style.display = 'block'; }
            });
        }
        loadFeed(false);

        if (feedList) {
          var feedDeleteLayer = document.getElementById('feedDeleteConfirmLayer');
          var feedDeleteCancel = document.getElementById('feedDeleteConfirmCancel');
          var feedDeleteOk = document.getElementById('feedDeleteConfirmOk');
          var pendingDeletePostId = null;
          var pendingDeleteBtn = null;
          function closeFeedDeleteModal() {
            pendingDeletePostId = null;
            pendingDeleteBtn = null;
            if (feedDeleteLayer) feedDeleteLayer.style.display = 'none';
          }
          var feedAdminPinLayer = document.getElementById('feedAdminPinLayer');
          var feedAdminPinInput = document.getElementById('feedAdminPinInput');
          var feedAdminPinErr = document.getElementById('feedAdminPinErr');
          var feedAdminPinCancel = document.getElementById('feedAdminPinCancel');
          var feedAdminPinOk = document.getElementById('feedAdminPinOk');

          function closeFeedAdminPinModal() {
            if (feedAdminPinLayer) feedAdminPinLayer.style.display = 'none';
            if (feedAdminPinErr) { feedAdminPinErr.style.display = 'none'; feedAdminPinErr.textContent = ''; }
            if (feedAdminPinInput) feedAdminPinInput.value = '';
            if (pendingDeleteBtn) pendingDeleteBtn.disabled = false;
            pendingDeletePostId = null;
            pendingDeleteBtn = null;
          }

          function doFeedDelete() {
            if (!pendingDeletePostId || !pendingDeleteBtn) return;
            var postId = pendingDeletePostId;
            var btn = pendingDeleteBtn;
            if (feedDeleteLayer) feedDeleteLayer.style.display = 'none';
            btn.disabled = true;
            fetch('/api/feed/' + encodeURIComponent(postId), { method: 'DELETE', credentials: 'same-origin' })
              .then(function (r) { return r.json(); })
              .then(function (data) {
                if (data.ok) {
                  var wrap = btn.closest && btn.closest('.feed-card-wrap');
                  var art = wrap || (btn.closest && btn.closest('.feed-card'));
                  if (art && art.parentNode) art.parentNode.removeChild(art);
                  pendingDeletePostId = null;
                  pendingDeleteBtn = null;
                } else if (data.needPin && feedAdminPinLayer) {
                  if (feedDeleteLayer) feedDeleteLayer.style.display = 'none';
                  feedAdminPinLayer.style.display = 'flex';
                  if (feedAdminPinInput) { feedAdminPinInput.value = ''; feedAdminPinInput.focus(); }
                  if (feedAdminPinErr) { feedAdminPinErr.style.display = 'none'; feedAdminPinErr.textContent = ''; }
                } else {
                  alert(data.message || 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                  btn.disabled = false;
                  pendingDeletePostId = null;
                  pendingDeleteBtn = null;
                }
              })
              .catch(function () {
                alert('ì‚­ì œ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                btn.disabled = false;
                pendingDeletePostId = null;
                pendingDeleteBtn = null;
              });
          }

          function submitFeedAdminPin() {
            var pin = (feedAdminPinInput && feedAdminPinInput.value) ? feedAdminPinInput.value.trim() : '';
            if (pin.length !== 6 || !/^[0-9]+$/.test(pin)) {
              if (feedAdminPinErr) { feedAdminPinErr.textContent = 'ìˆ«ì 6ìë¦¬ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.'; feedAdminPinErr.style.display = 'block'; }
              return;
            }
            if (feedAdminPinErr) feedAdminPinErr.style.display = 'none';
            fetch('/api/admin/verify-pin', { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'same-origin', body: JSON.stringify({ pin: pin }) })
              .then(function (r) { return r.json(); })
              .then(function (data) {
                if (data.ok) {
                  closeFeedAdminPinModal();
                  doFeedDelete();
                } else {
                  if (feedAdminPinErr) { feedAdminPinErr.textContent = data.message || 'ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'; feedAdminPinErr.style.display = 'block'; }
                }
              })
              .catch(function () {
                if (feedAdminPinErr) { feedAdminPinErr.textContent = 'ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'; feedAdminPinErr.style.display = 'block'; }
              });
          }

          if (feedDeleteCancel) feedDeleteCancel.addEventListener('click', closeFeedDeleteModal);
          if (feedDeleteOk) feedDeleteOk.addEventListener('click', doFeedDelete);
          if (feedDeleteLayer) {
            feedDeleteLayer.addEventListener('click', function (e) { if (e.target === feedDeleteLayer) closeFeedDeleteModal(); });
          }
          if (feedAdminPinCancel) feedAdminPinCancel.addEventListener('click', closeFeedAdminPinModal);
          if (feedAdminPinOk) feedAdminPinOk.addEventListener('click', submitFeedAdminPin);
          if (feedAdminPinLayer) {
            feedAdminPinLayer.addEventListener('click', function (e) { if (e.target === feedAdminPinLayer) closeFeedAdminPinModal(); });
          }
          if (feedAdminPinInput) {
            feedAdminPinInput.addEventListener('keydown', function (e) { if (e.key === 'Enter') { e.preventDefault(); submitFeedAdminPin(); } });
          }
          feedList.addEventListener('click', function (e) {
            var btn = e.target && e.target.closest && e.target.closest('.feed-card__admin-delete');
            if (!btn) return;
            var postId = btn.getAttribute('data-post-id');
            if (!postId) return;
            e.preventDefault();
            e.stopPropagation();
            pendingDeletePostId = postId;
            pendingDeleteBtn = btn;
            if (feedDeleteLayer) feedDeleteLayer.style.display = 'flex';
          });
        }

        var feedAuthorPopover = document.getElementById('feedAuthorPopover');
        var popoverHideTimeout = null;
        var popoverOpenedByClick = false;
        function clearPopoverHideTimeout() {
          if (popoverHideTimeout) { clearTimeout(popoverHideTimeout); popoverHideTimeout = null; }
        }
        function showAuthorPopover(post, triggerEl) {
          if (!feedAuthorPopover || !post) return;
          var name = post.authorDisplayName || 'â€”';
          var lv = (post.authorLevel >= 1 && post.authorLevel <= 6) ? post.authorLevel : 0;
          var levelEmoji = LEVEL_EMOJI[lv] || '';
          var levelName = LEVEL_NAMES[lv] ? LEVEL_NAMES[lv] + ' (Lv.' + lv + ')' : '';
          var avatarWrap = feedAuthorPopover.querySelector('.feed-author-popover__avatar-wrap');
          var nameEl = feedAuthorPopover.querySelector('.feed-author-popover__name');
          var levelEl = feedAuthorPopover.querySelector('.feed-author-popover__level');
          var bioEl = feedAuthorPopover.querySelector('.feed-author-popover__bio');
          if (avatarWrap) {
            avatarWrap.innerHTML = '';
            if (post.authorProfileImageUrl && post.authorProfileImageUrl.trim()) {
              var img = document.createElement('img');
              img.src = post.authorProfileImageUrl;
              img.alt = '';
              avatarWrap.appendChild(img);
            } else {
              avatarWrap.textContent = name.charAt(0) || '?';
            }
          }
          if (nameEl) nameEl.textContent = name;
          if (levelEl) levelEl.textContent = levelEmoji ? levelEmoji + ' ' + levelName : '';
          if (levelEl) levelEl.style.display = levelEmoji ? '' : 'none';
          var heartsEl = feedAuthorPopover.querySelector('.feed-author-popover__hearts');
          if (heartsEl) {
            var pts = typeof post.authorPoints === 'number' ? post.authorPoints : 0;
            heartsEl.textContent = 'â¤ï¸ ' + pts + 'ê°œ';
            heartsEl.style.display = 'block';
          }
          if (bioEl) {
            var bio = (post.authorBio && post.authorBio.trim()) ? post.authorBio.trim() : '';
            bioEl.textContent = bio || 'ìê¸°ì†Œê°œê°€ ì—†ìŠµë‹ˆë‹¤.';
            bioEl.style.display = 'block';
          }
          var rect = triggerEl ? triggerEl.getBoundingClientRect() : null;
          if (rect) {
            feedAuthorPopover.style.left = Math.max(8, Math.min(rect.left, window.innerWidth - 280)) + 'px';
            var top = rect.bottom + 8;
            if (top + 120 > window.innerHeight - 8) top = rect.top - 120;
            feedAuthorPopover.style.top = Math.max(8, top) + 'px';
          }
          feedAuthorPopover.style.display = 'block';
          feedAuthorPopover.classList.add('is-open');
          feedAuthorPopover.setAttribute('aria-hidden', 'false');
        }
        function hideAuthorPopover() {
          if (!feedAuthorPopover) return;
          feedAuthorPopover.classList.remove('is-open');
          feedAuthorPopover.style.display = 'none';
          feedAuthorPopover.setAttribute('aria-hidden', 'true');
          popoverOpenedByClick = false;
        }
        if (feedList) {
          feedList.addEventListener('mouseover', function (e) {
            var trigger = e.target && e.target.closest && e.target.closest('.feed-card__avatar, .feed-card__author');
            if (!trigger) return;
            clearPopoverHideTimeout();
            var card = trigger.closest('.feed-card');
            var id = card && card.getAttribute('data-post-id');
            var post = id ? feedPostsById[id] : null;
            if (post) { popoverOpenedByClick = false; showAuthorPopover(post, trigger); }
          });
          feedList.addEventListener('mouseout', function (e) {
            var trigger = e.target && e.target.closest && e.target.closest('.feed-card__avatar, .feed-card__author');
            if (!trigger) return;
            var related = e.relatedTarget;
            if (related && feedAuthorPopover && (trigger.contains(related) || feedAuthorPopover.contains(related))) return;
            popoverHideTimeout = setTimeout(hideAuthorPopover, 200);
          });
        }
        if (feedAuthorPopover) {
          feedAuthorPopover.addEventListener('mouseenter', clearPopoverHideTimeout);
          feedAuthorPopover.addEventListener('mouseleave', function () {
            popoverHideTimeout = setTimeout(hideAuthorPopover, 200);
          });
        }
        document.addEventListener('click', function (e) {
          if (!popoverOpenedByClick || !feedAuthorPopover || !feedAuthorPopover.classList.contains('is-open')) return;
          if (feedAuthorPopover.contains(e.target)) return;
          var trigger = e.target.closest && e.target.closest('.feed-card__avatar, .feed-card__author');
          if (trigger && feedList && feedList.contains(trigger)) return;
          hideAuthorPopover();
        });

        if (feedList) feedList.addEventListener('click', function (e) {
          var authorTrigger = e.target && e.target.closest && e.target.closest('.feed-card__avatar, .feed-card__author');
          if (authorTrigger) {
            e.preventDefault();
            e.stopPropagation();
            var card = authorTrigger.closest('.feed-card');
            var id = card && card.getAttribute('data-post-id');
            var post = id ? feedPostsById[id] : null;
            if (post) {
              popoverOpenedByClick = true;
              if (feedAuthorPopover && feedAuthorPopover.classList.contains('is-open')) {
                hideAuthorPopover();
              } else {
                showAuthorPopover(post, authorTrigger);
              }
            }
            return;
          }
          var link = e.target && e.target.closest && e.target.closest('a.feed-card__link');
          if (!link) return;
          if (e.target.closest('.feed-card-heart-btn')) return;
          var card = link.closest('.feed-card');
          var id = card && card.getAttribute('data-post-id');
          if (!id) return;
          var post = feedPostsById[id];
          if (post) {
            try { sessionStorage.setItem('feedPost_' + id, JSON.stringify(post)); } catch (err) {}
          }
          e.preventDefault();
          window.location.href = link.getAttribute('href') || ('feed-post.html?id=' + encodeURIComponent(id));
        }, true);
        if (feedMoreBtn) feedMoreBtn.addEventListener('click', function () { loadFeed(true); });

        var feedSendHeartLayer = document.getElementById('feedSendHeartLayer');
        var feedSendHeartMessage = document.getElementById('feedSendHeartMessage');
        var feedSendHeartMyHearts = document.getElementById('feedSendHeartMyHearts');
        var feedSendHeartCancel = document.getElementById('feedSendHeartCancel');
        var feedSendHeartOk = document.getElementById('feedSendHeartOk');
        var pendingFeedHeartPostId = null;
        function openFeedSendHeartModal(postId, authorName) {
          pendingFeedHeartPostId = postId;
          if (feedSendHeartMessage) feedSendHeartMessage.textContent = (authorName || 'ì´ ì‚¬ìš©ì') + 'ë‹˜ì—ê²Œ í•˜íŠ¸ 1ê°œë¥¼ ë³´ë‚´ì‹œê² ìŠµë‹ˆê¹Œ?';
          fetch('/api/me', { credentials: 'same-origin' })
            .then(function (r) { return r.json(); })
            .then(function (data) {
              if (feedSendHeartMyHearts) feedSendHeartMyHearts.textContent = 'ë³´ìœ  í•˜íŠ¸: ' + (data.ok && data.user && typeof data.user.points === 'number' ? data.user.points : 0) + 'ê°œ';
            });
          if (feedSendHeartLayer) feedSendHeartLayer.style.display = 'flex';
        }
        function closeFeedSendHeartModal() {
          pendingFeedHeartPostId = null;
          if (feedSendHeartLayer) feedSendHeartLayer.style.display = 'none';
        }
        if (feedSendHeartCancel) feedSendHeartCancel.addEventListener('click', closeFeedSendHeartModal);
        if (feedSendHeartOk) feedSendHeartOk.addEventListener('click', function () {
          if (!pendingFeedHeartPostId) return;
          var postId = pendingFeedHeartPostId;
          feedSendHeartOk.disabled = true;
          var url = '/api/feed/' + encodeURIComponent(postId) + '/send-heart';
          fetch(url, {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
          })
            .then(function (r) { return r.json(); })
            .then(function (data) {
              feedSendHeartOk.disabled = false;
              closeFeedSendHeartModal();
              if (data.ok) {
                var card = feedList && feedList.querySelector('.feed-card[data-post-id="' + postId + '"]');
                if (card) {
                  var btn = card.querySelector('.feed-card-heart-btn');
                  if (btn) btn.remove();
                  var footer = card.querySelector('.feed-card__footer');
                  if (footer) {
                    var heartsEl = footer.querySelector('.feed-card__hearts');
                    var nextCount = data.heartsReceived || 0;
                    if (heartsEl) heartsEl.textContent = 'â¤ï¸ ' + nextCount;
                    else if (nextCount > 0) {
                      var span = document.createElement('span');
                      span.className = 'feed-card__hearts';
                      span.textContent = 'â¤ï¸ ' + nextCount;
                      footer.insertBefore(span, footer.firstChild);
                    }
                  }
                }
                if (data.message) alert(data.message);
              } else if (data.message) alert(data.message);
            })
            .catch(function () { feedSendHeartOk.disabled = false; alert('í•˜íŠ¸ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); });
        });
        if (feedSendHeartLayer && feedSendHeartLayer.querySelector('.feed-send-heart-box')) {
          feedSendHeartLayer.addEventListener('click', function (e) {
            if (e.target === feedSendHeartLayer) closeFeedSendHeartModal();
          });
        }
        document.addEventListener('click', function (e) {
          var heartBtn = e.target.closest && e.target.closest('.feed-card-heart-btn');
          if (heartBtn) {
            e.preventDefault();
            e.stopPropagation();
            var postId = heartBtn.getAttribute('data-post-id');
            var authorName = heartBtn.getAttribute('data-author-name') || 'ì´ ì‚¬ìš©ì';
            if (!postId) return;
            var me = (window.TornFiAuth && window.TornFiAuth.getUser()) || {};
            if (!me.id) { alert('ë¡œê·¸ì¸ í›„ í•˜íŠ¸ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.'); return; }
            openFeedSendHeartModal(postId, authorName);
            return;
          }
        });

        /* íŠ¸ìœ„í„° ì‹ ì‘ì„±ë€: í”¼ë“œì—ì„œ ë°”ë¡œ ê²Œì‹œ */
        var feedCompose = document.getElementById('feedCompose');
        var feedComposeAvatar = document.getElementById('feedComposeAvatar');
        var feedComposeText = document.getElementById('feedComposeText');
        var feedComposeImage = document.getElementById('feedComposeImage');
        var feedComposeImageBtn = document.getElementById('feedComposeImageBtn');
        var feedComposePreview = document.getElementById('feedComposePreview');
        var feedComposeSubmit = document.getElementById('feedComposeSubmit');
        var composeFiles = [];
        var composeObjectUrls = [];
        function updateComposePreview() {
          composeObjectUrls.forEach(function (u) { URL.revokeObjectURL(u); });
          composeObjectUrls = [];
          if (!feedComposePreview) return;
          feedComposePreview.innerHTML = '';
          composeFiles.forEach(function (file, i) {
            var url = URL.createObjectURL(file);
            composeObjectUrls.push(url);
            var item = document.createElement('div');
            item.className = 'feed-compose__preview-item';
            item.innerHTML = '<img src="' + url + '" alt=""><button type="button" class="feed-compose__remove-img" data-index="' + i + '" aria-label="ì œê±°">Ã—</button>';
            feedComposePreview.appendChild(item);
            item.querySelector('button').addEventListener('click', function () {
              composeFiles.splice(parseInt(this.getAttribute('data-index'), 10), 1);
              updateComposePreview();
            });
          });
        }
        if (feedCompose) {
          var feedComposeAvatarImg = document.getElementById('feedComposeAvatarImg');
          var feedComposeAvatarLetter = document.getElementById('feedComposeAvatar');
          window.TornFiAuth.onUser(function (user) {
            feedCompose.style.display = user ? 'block' : 'none';
            if (user && user.profileImageUrl && user.profileImageUrl.trim()) {
              if (feedComposeAvatarImg) { feedComposeAvatarImg.src = user.profileImageUrl; feedComposeAvatarImg.style.display = ''; }
              if (feedComposeAvatarLetter) feedComposeAvatarLetter.style.display = 'none';
            } else {
              if (feedComposeAvatarImg) feedComposeAvatarImg.style.display = 'none';
              if (feedComposeAvatarLetter) { feedComposeAvatarLetter.textContent = (user && user.displayName) ? user.displayName.charAt(0).toUpperCase() : '?'; feedComposeAvatarLetter.style.display = ''; }
            }
          });
        }
        if (feedComposeText && feedComposeSubmit) {
          feedComposeText.addEventListener('input', function () {
            feedComposeSubmit.disabled = !feedComposeText.value.trim();
          });
        }
        if (feedComposeImageBtn && feedComposeImage) {
          feedComposeImageBtn.addEventListener('click', function () { feedComposeImage.click(); });
        }
        if (feedComposeImage) {
          feedComposeImage.addEventListener('change', function () {
            composeFiles = Array.from(feedComposeImage.files || []).slice(0, 5);
            updateComposePreview();
          });
        }
        if (feedComposeSubmit && feedComposeText) {
          feedComposeSubmit.addEventListener('click', function () {
            var body = feedComposeText.value.trim();
            if (!body) return;
            var fd = new FormData();
            fd.append('body', body);
            composeFiles.forEach(function (f) { fd.append('images', f); });
            feedComposeSubmit.disabled = true;
            fetch('/api/feed', {
              method: 'POST',
              credentials: 'same-origin',
              body: fd,
            })
              .then(function (r) { return r.json().then(function (data) { return { ok: r.ok, status: r.status, data: data }; }); })
              .then(function (res) {
                feedComposeSubmit.disabled = false;
                if (res.ok && res.data.ok) {
                  feedComposeText.value = '';
                  composeFiles = [];
                  if (feedComposeImage) feedComposeImage.value = '';
                  updateComposePreview();
                  loadFeed(false);
                } else {
                  alert(res.data.message || 'ê²Œì‹œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
              })
              .catch(function () {
                feedComposeSubmit.disabled = false;
                alert('ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
              });
          });
        }
      })();
    })();
  </script>
</body>
</html>
