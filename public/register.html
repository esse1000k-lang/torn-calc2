<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#0a0a0b">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>íšŒì›ê°€ì… | TornFi</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="manifest" href="/manifest.json">
  <script src="js/pwa-env.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/site.css">
</head>
<body>
  <nav class="site-nav">
    <div class="nav-brand">
      <a href="/" class="nav-logo">TornFi</a>
    </div>
    <a href="/admin.html" class="nav-admin-center" id="navAdminCenter" aria-label="ê´€ë¦¬ì" style="display:none;">ğŸ› ï¸</a>
    <div class="nav-menu-wrap">
      <button type="button" class="nav-menu-btn" id="navMenuBtn" aria-label="ë©”ë‰´" aria-expanded="false" aria-haspopup="true">â˜°</button>
      <div class="nav-menu-dropdown" id="navMenuDropdown" role="menu"></div>
    </div>
  </nav>

  <div class="auth-page auth-page--register">
    <a href="/" class="back-link">â† í™ˆìœ¼ë¡œ</a>
    <div class="auth-card auth-card--register">
      <div class="auth-card-head">
        <h1>íšŒì›ê°€ì…</h1>
        <p class="auth-desc">ë‹‰ë„¤ì„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¡œ ê°„í¸íˆ ê°€ì…í•˜ì„¸ìš”</p>
      </div>
      <p class="auth-error" id="authError"></p>
      <form id="registerForm">
        <section class="auth-form-section auth-form-section--card">
          <h3 class="auth-form-section-title"><span class="auth-section-icon" aria-hidden="true">1</span>ê³„ì • ì •ë³´</h3>
          <div class="auth-form-section-inner">
            <div class="auth-form-block">
              <label for="displayName">ë‹‰ë„¤ì„ (ì˜ë¬¸, ìˆ«ìë§Œ 5~12ì)</label>
              <input type="text" id="displayName" name="displayName" required autocomplete="username" placeholder="ì˜ë¬¸Â·ìˆ«ì 5~12ì" minlength="5" maxlength="12" pattern="[a-zA-Z0-9]*" title="ì˜ë¬¸, ìˆ«ìë§Œ 5~12ì">
              <p class="nickname-validation" id="nicknameValidation" aria-live="polite" role="status"></p>
            </div>
            <div class="auth-form-block auth-form-block--password">
              <span class="auth-form-block-title">ë¹„ë°€ë²ˆí˜¸</span>
              <label for="password">ë¡œê·¸ì¸ ë¹„ë°€ë²ˆí˜¸</label>
              <input type="password" id="password" name="password" required autocomplete="new-password" placeholder="8ì ì´ìƒ, ì˜ë¬¸Â·ìˆ«ì í¬í•¨ (íŠ¹ìˆ˜ë¬¸ì ê¶Œì¥)" minlength="8">
              <p class="capslock-warning" id="passwordCapsWarning" aria-live="polite" role="status" style="display:none;">Caps Lockì´ ì¼œì ¸ ìˆìŠµë‹ˆë‹¤.</p>
              <label for="passwordConfirm">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
              <input type="password" id="passwordConfirm" name="passwordConfirm" required placeholder="ë™ì¼í•˜ê²Œ ì…ë ¥">
              <p class="capslock-warning" id="passwordConfirmCapsWarning" aria-live="polite" role="status" style="display:none;">Caps Lockì´ ì¼œì ¸ ìˆìŠµë‹ˆë‹¤.</p>
              <p class="password-confirm-validation" id="passwordConfirmValidation" aria-live="polite" role="status"></p>
            </div>
          </div>
        </section>
        <section class="auth-form-section auth-form-section--card">
          <h3 class="auth-form-section-title"><span class="auth-section-icon" aria-hidden="true">2</span>ì§€ê°‘ ì£¼ì†Œ</h3>
          <div class="auth-form-section-inner">
            <label for="walletAddress">ì´ë”ë¦¬ì›€ ì§€ê°‘ ì£¼ì†Œ <span class="required">(í•„ìˆ˜)</span></label>
            <input type="text" id="walletAddress" name="walletAddress" required autocomplete="off" placeholder="0x..." spellcheck="false">
            <p class="wallet-validation" id="walletValidation" aria-live="polite" role="status"></p>
            <p class="wallet-staking-info" id="walletStakingInfo" aria-live="polite" role="status"></p>
          </div>
        </section>
        <section class="auth-form-section auth-form-section--card">
          <h3 class="auth-form-section-title"><span class="auth-section-icon" aria-hidden="true">3</span>ì¶”ì²œì¸</h3>
          <div class="auth-form-section-inner">
            <label for="referrer">ì¶”ì²œì¸ (ì„ íƒì‚¬í•­)</label>
            <input type="text" id="referrer" name="referrer" autocomplete="off" placeholder="ì„ íƒ ì…ë ¥">
          </div>
        </section>
        <div class="auth-submit-wrap">
          <button type="submit" class="auth-submit-btn">ê°€ì…í•˜ê¸°</button>
        </div>
      </form>
      <p class="auth-link">ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <a href="/login.html">ë¡œê·¸ì¸</a></p>
    </div>
  </div>

  <div id="registerWelcomeLayer" class="register-welcome-layer" style="display:none;">
    <div class="register-welcome-card">
      <div class="register-welcome-icon" aria-hidden="true">âœ¨</div>
      <h2 class="register-welcome-title">ê°€ì…ì„ í™˜ì˜í•©ë‹ˆë‹¤</h2>
      <p class="register-welcome-desc">ê°€ì… ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.<br>ê´€ë¦¬ì ìŠ¹ì¸ í›„ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br><span class="register-welcome-time">(ìµœì†Œ 1ì‹œê°„ ~ ìµœëŒ€ 24ì‹œê°„)</span></p>
      <p class="register-welcome-login"><span class="register-welcome-torn">Torn</span>Fi.com</p>
      <a href="/" id="registerWelcomeBtn" class="register-welcome-btn">í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>
  </div>

  <script src="js/auth.js"></script>
  <script src="js/nav-logo.js"></script>
  <script>
    (function () {
      var form = document.getElementById('registerForm');
      var errorEl = document.getElementById('authError');
      var nicknameValidationEl = document.getElementById('nicknameValidation');

      var nicknameRegex = /^[a-zA-Z0-9]{5,12}$/;
      var nicknameCheckTimer = null;
      var displayNameInput = document.getElementById('displayName');
      if (displayNameInput) {
        displayNameInput.addEventListener('input', function () {
          var v = this.value.replace(/[^a-zA-Z0-9]/g, '').slice(0, 12);
          if (v !== this.value) this.value = v;
          nicknameValidationEl.textContent = '';
          nicknameValidationEl.classList.remove('wallet-validation--err', 'wallet-validation--ok');
          if (v.length > 0 && v.length < 5) nicknameValidationEl.textContent = 'ë‹‰ë„¤ì„ì€ 5~12ìì…ë‹ˆë‹¤.';
          else if (v.length > 0 && !nicknameRegex.test(v)) nicknameValidationEl.textContent = 'ì˜ë¬¸, ìˆ«ìë§Œ 5~12ì ê°€ëŠ¥í•©ë‹ˆë‹¤.';
          else if (v.length >= 5 && !/[a-zA-Z]/.test(v)) nicknameValidationEl.textContent = 'ì˜ë¬¸, ìˆ«ìë§Œ 5~12ì ê°€ëŠ¥í•©ë‹ˆë‹¤.';
          else if (v.length >= 5) {
            if (nicknameCheckTimer) clearTimeout(nicknameCheckTimer);
            nicknameCheckTimer = setTimeout(function () {
              nicknameCheckTimer = null;
              fetch('/api/public/check-nickname?displayName=' + encodeURIComponent(v))
                .then(function (r) { return r.json(); })
                .then(function (data) {
                  if (displayNameInput.value.trim() !== v) return;
                  if (data.available) {
                    nicknameValidationEl.textContent = 'ì‚¬ìš© ê°€ëŠ¥í•œ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.';
                    nicknameValidationEl.classList.remove('wallet-validation--err');
                    nicknameValidationEl.classList.add('wallet-validation--ok');
                  } else {
                    nicknameValidationEl.textContent = data.message || 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.';
                    nicknameValidationEl.classList.remove('wallet-validation--ok');
                    nicknameValidationEl.classList.add('wallet-validation--err');
                  }
                })
                .catch(function () {
                  if (displayNameInput.value.trim() === v) nicknameValidationEl.textContent = '';
                });
            }, 400);
          } else nicknameValidationEl.textContent = '';
        });
        displayNameInput.addEventListener('blur', function () {
          var v = this.value.trim();
          if (!v) { nicknameValidationEl.textContent = ''; nicknameValidationEl.classList.remove('wallet-validation--err', 'wallet-validation--ok'); return; }
          if (!nicknameRegex.test(v) || !/[a-zA-Z]/.test(v)) {
            nicknameValidationEl.textContent = v.length < 5 ? 'ë‹‰ë„¤ì„ì€ 5~12ìì…ë‹ˆë‹¤.' : 'ë‹‰ë„¤ì„ì€ ì˜ë¬¸, ìˆ«ìë§Œ 5~12ìê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.';
            nicknameValidationEl.classList.add('wallet-validation--err');
            nicknameValidationEl.classList.remove('wallet-validation--ok');
          } else {
            fetch('/api/public/check-nickname?displayName=' + encodeURIComponent(v))
              .then(function (r) { return r.json(); })
              .then(function (data) {
                if (displayNameInput.value.trim() !== v) return;
                if (data.available) {
                  nicknameValidationEl.textContent = 'ì‚¬ìš© ê°€ëŠ¥í•œ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.';
                  nicknameValidationEl.classList.remove('wallet-validation--err');
                  nicknameValidationEl.classList.add('wallet-validation--ok');
                } else {
                  nicknameValidationEl.textContent = data.message || 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.';
                  nicknameValidationEl.classList.remove('wallet-validation--ok');
                  nicknameValidationEl.classList.add('wallet-validation--err');
                }
              })
              .catch(function () {});
          }
        });
      }

      var walletInput = document.getElementById('walletAddress');
      var walletValidationEl = document.getElementById('walletValidation');
      var walletStakingEl = document.getElementById('walletStakingInfo');
      var walletCheckTimer = null;
      function checkWalletFormat(v) {
        if (!v || v.length < 2) return false;
        if (v.length !== 42 || v.slice(0, 2).toLowerCase() !== '0x') return false;
        return /^0x[0-9a-fA-F]{40}$/.test(v);
      }
      function formatStakingNum(s) {
        var n = parseFloat(s, 10);
        if (isNaN(n)) return '0';
        if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
        if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
        return n < 1 ? n.toFixed(2) : Math.floor(n).toLocaleString();
      }
      function updateWalletStaking(wallet, stakingEl, validationEl) {
        if (!stakingEl) return;
        stakingEl.textContent = 'ì¡°íšŒ ì¤‘â€¦';
        if (validationEl) { validationEl.textContent = ''; validationEl.classList.remove('wallet-validation--err', 'wallet-validation--ok'); }
        fetch('/api/check-staking?walletAddress=' + encodeURIComponent(wallet))
          .then(function (r) { return r.json(); })
          .then(function (data) {
            if (walletInput && walletInput.value.trim() !== wallet) return;
            if (data.ok && data.lockedBalance != null) {
              var bal = parseFloat(data.lockedBalance, 10);
              if (data.staking && bal > 0) {
                stakingEl.textContent = 'ê°€ì… ê°€ëŠ¥í•©ë‹ˆë‹¤.';
                stakingEl.classList.remove('wallet-staking--nok');
                stakingEl.classList.add('wallet-staking--ok');
                if (validationEl) { validationEl.textContent = ''; validationEl.classList.remove('wallet-validation--ok'); }
              } else {
                stakingEl.textContent = 'ìŠ¤í…Œì´í‚¹ì´ í•„ìš”í•©ë‹ˆë‹¤.';
                stakingEl.classList.remove('wallet-staking--ok');
                stakingEl.classList.add('wallet-staking--nok');
                if (validationEl) { validationEl.textContent = ''; validationEl.classList.remove('wallet-validation--ok'); }
              }
            } else {
              stakingEl.textContent = 'ì¡°íšŒ ì‹¤íŒ¨';
              stakingEl.classList.remove('wallet-staking--ok', 'wallet-staking--nok');
              if (validationEl) { validationEl.textContent = ''; validationEl.classList.remove('wallet-validation--ok'); }
            }
          })
          .catch(function () {
            if (walletInput && walletInput.value.trim() === wallet) {
              stakingEl.textContent = 'ì¡°íšŒ ì‹¤íŒ¨';
              stakingEl.classList.remove('wallet-staking--ok', 'wallet-staking--nok');
              if (validationEl) { validationEl.textContent = ''; validationEl.classList.remove('wallet-validation--ok'); }
            }
          });
      }
      if (walletInput && walletValidationEl) {
        walletInput.addEventListener('input', function () {
          var v = this.value.trim();
          walletValidationEl.textContent = '';
          walletValidationEl.classList.remove('wallet-validation--err', 'wallet-validation--ok');
          if (walletStakingEl) { walletStakingEl.textContent = ''; walletStakingEl.classList.remove('wallet-staking--ok', 'wallet-staking--nok'); }
          if (!v) return;
          if (!checkWalletFormat(v)) {
            walletValidationEl.textContent = 'ì˜¬ë°”ë¥¸ ì§€ê°‘ ì£¼ì†Œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.';
            walletValidationEl.classList.add('wallet-validation--err');
            return;
          }
          if (walletCheckTimer) clearTimeout(walletCheckTimer);
          walletCheckTimer = setTimeout(function () {
            walletCheckTimer = null;
            fetch('/api/public/check-wallet?walletAddress=' + encodeURIComponent(v))
              .then(function (r) { return r.json(); })
              .then(function (data) {
                if (walletInput.value.trim() !== v) return;
                if (data.registered) {
                  if (walletStakingEl) { walletStakingEl.textContent = ''; walletStakingEl.classList.remove('wallet-staking--ok', 'wallet-staking--nok'); }
                  if (data.forceWithdrawn || data.withdrawn) {
                    walletValidationEl.textContent = 'ì¬ê°€ì…í•  ìˆ˜ ì—†ëŠ” ì§€ê°‘ì…ë‹ˆë‹¤.';
                  } else {
                    walletValidationEl.textContent = 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì§€ê°‘ì…ë‹ˆë‹¤.';
                  }
                  walletValidationEl.classList.remove('wallet-validation--ok');
                  walletValidationEl.classList.add('wallet-validation--err');
                } else {
                  updateWalletStaking(v, walletStakingEl, walletValidationEl);
                }
              })
              .catch(function () {
                if (walletInput.value.trim() === v) { walletValidationEl.textContent = ''; if (walletStakingEl) { walletStakingEl.textContent = ''; walletStakingEl.classList.remove('wallet-staking--ok', 'wallet-staking--nok'); } }
              });
          }, 400);
        });
        walletInput.addEventListener('blur', function () {
          var v = this.value.trim();
          if (!v) {
            walletValidationEl.textContent = '';
            walletValidationEl.classList.remove('wallet-validation--err', 'wallet-validation--ok');
            if (walletStakingEl) { walletStakingEl.textContent = ''; walletStakingEl.classList.remove('wallet-staking--ok', 'wallet-staking--nok'); }
            return;
          }
          if (!checkWalletFormat(v)) {
            walletValidationEl.textContent = 'ì˜¬ë°”ë¥¸ ì§€ê°‘ ì£¼ì†Œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.';
            walletValidationEl.classList.add('wallet-validation--err');
          }
        });
      }

      var passwordInput = document.getElementById('password');
      var passwordConfirmInput = document.getElementById('passwordConfirm');
      var passwordConfirmValidationEl = document.getElementById('passwordConfirmValidation');
      function attachCapsLockWarning(inputEl, warningEl) {
        if (!inputEl || !warningEl) return;
        function updateCaps(e) {
          var capsOn = e && typeof e.getModifierState === 'function' && e.getModifierState('CapsLock');
          warningEl.style.display = capsOn ? 'block' : 'none';
        }
        inputEl.addEventListener('keydown', updateCaps);
        inputEl.addEventListener('keyup', updateCaps);
        inputEl.addEventListener('blur', function () { warningEl.style.display = 'none'; });
      }
      attachCapsLockWarning(passwordInput, document.getElementById('passwordCapsWarning'));
      attachCapsLockWarning(passwordConfirmInput, document.getElementById('passwordConfirmCapsWarning'));
      function checkPasswordMatch() {
        if (!passwordConfirmValidationEl) return;
        var p = passwordInput ? passwordInput.value : '';
        var c = passwordConfirmInput ? passwordConfirmInput.value : '';
        if (c.length === 0) {
          passwordConfirmValidationEl.textContent = '';
          passwordConfirmValidationEl.classList.remove('wallet-validation--err', 'wallet-validation--ok');
          return;
        }
        if (p !== c) {
          passwordConfirmValidationEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
          passwordConfirmValidationEl.classList.remove('wallet-validation--ok');
          passwordConfirmValidationEl.classList.add('wallet-validation--err');
        } else {
          passwordConfirmValidationEl.textContent = 'ì¼ì¹˜í•©ë‹ˆë‹¤.';
          passwordConfirmValidationEl.classList.remove('wallet-validation--err');
          passwordConfirmValidationEl.classList.add('wallet-validation--ok');
        }
      }
      function clearTopError() {
        if (errorEl) errorEl.textContent = '';
      }
      form.addEventListener('input', clearTopError);
      form.addEventListener('change', clearTopError);

      form.addEventListener('submit', function (e) {
        e.preventDefault();
        clearTopError();
        var displayName = (document.getElementById('displayName').value || '').trim();
        var password = (document.getElementById('password').value || '').trim();
        var passwordConfirm = (document.getElementById('passwordConfirm').value || '').trim();
        var walletAddress = (document.getElementById('walletAddress').value || '').trim() || undefined;
        var referrer = (document.getElementById('referrer').value || '').trim() || undefined;
        if (!walletAddress) {
          errorEl.textContent = 'ì§€ê°‘ ì£¼ì†Œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.';
          return;
        }
        if (!checkWalletFormat(walletAddress)) {
          errorEl.textContent = 'ì˜¬ë°”ë¥¸ ì§€ê°‘ ì£¼ì†Œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.';
          return;
        }
        if (!displayName) {
          errorEl.textContent = 'ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.';
          return;
        }
        if (!nicknameRegex.test(displayName) || !/[a-zA-Z]/.test(displayName)) {
          errorEl.textContent = 'ë‹‰ë„¤ì„ì€ ì˜ë¬¸, ìˆ«ìë§Œ 5~12ìê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.';
          return;
        }
        if (password !== passwordConfirm) {
          errorEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
          return;
        }
        if (password.length < 8) {
          errorEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
          return;
        }
        if (!/[a-zA-Z]/.test(password) || !/\d/.test(password)) {
          errorEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ëŠ” ì˜ë¬¸ê³¼ ìˆ«ìë¥¼ ëª¨ë‘ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.';
          return;
        }
        window.TornFiAuth.register(displayName, password, referrer, walletAddress)
          .then(function (data) {
            clearTopError();
            var welcomeLayer = document.getElementById('registerWelcomeLayer');
            if (welcomeLayer) welcomeLayer.style.display = 'flex';
          })
          .catch(function (err) {
            var msg = (err && err.message) ? String(err.message) : 'ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
            var isServerError = msg.indexOf('JSON') !== -1 || msg.indexOf('fetch') !== -1 || msg === 'ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
            errorEl.textContent = isServerError ? 'ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.' : msg;
          });
      });
      window.TornFiAuth.onUser(function (u) {
        var nbtn = document.getElementById('navMenuBtn');
        var nac = document.getElementById('navAdminCenter');
        if (u) {
          if (nbtn) nbtn.style.display = 'none';
          if (nac) nac.style.display = u.isAdmin ? 'inline-flex' : 'none';
        } else {
          if (nbtn) nbtn.style.display = 'none';
          if (nac) nac.style.display = 'none';
        }
      });
      var navMenuBtn = document.getElementById('navMenuBtn');
      var navMenuDropdown = document.getElementById('navMenuDropdown');
      if (navMenuBtn && navMenuDropdown) {
        navMenuBtn.addEventListener('click', function (e) { e.stopPropagation(); navMenuDropdown.classList.toggle('is-open'); navMenuBtn.setAttribute('aria-expanded', navMenuDropdown.classList.contains('is-open')); });
        navMenuDropdown.addEventListener('click', function (e) { e.stopPropagation(); });
        document.addEventListener('click', function () { navMenuDropdown.classList.remove('is-open'); navMenuBtn.setAttribute('aria-expanded', 'false'); });
      }
    })();
  </script>
</body>
</html>
