<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#0a0a0b">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>íšŒì›ê°€ì… | TornFi</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="manifest" href="/manifest.json">
  <script src="js/pwa-env.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/site.css">
</head>
<body>
  <nav class="site-nav">
    <div class="nav-brand">
      <a href="/" class="nav-logo">TornFi</a>
    </div>
    <a href="/admin.html" class="nav-admin-center" id="navAdminCenter" aria-label="ê´€ë¦¬ì" style="display:none;">ğŸ› ï¸</a>
    <div class="nav-menu-wrap">
      <button type="button" class="nav-menu-btn" id="navMenuBtn" aria-label="ë©”ë‰´" aria-expanded="false" aria-haspopup="true">â˜°</button>
      <div class="nav-menu-dropdown" id="navMenuDropdown" role="menu">
        <a href="/login.html" id="navLogin" role="menuitem" style="display:none;">ë¡œê·¸ì¸</a>
        <a href="/register.html" id="navRegister" role="menuitem" style="display:none;">íšŒì›ê°€ì…</a>
        <div class="nav-menu-user" id="navMenuUser" style="display:none;">
          <a href="/profile.html" id="navProfile" role="menuitem">ë‚´ ì •ë³´</a>
          <button type="button" id="navLogout" role="menuitem">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>
    </div>
  </nav>

  <div class="auth-page auth-page--register">
    <a href="/" class="back-link">â† í™ˆìœ¼ë¡œ</a>
    <div class="auth-card auth-card--register">
      <div class="auth-card-head">
        <h1>íšŒì›ê°€ì…</h1>
        <p class="auth-desc">ë‹‰ë„¤ì„ê³¼ ì§€ê°‘ ì£¼ì†Œë¡œ í™œë™í•˜ëŠ” ìµëª… ì»¤ë®¤ë‹ˆí‹°</p>
      </div>
      <p class="auth-error" id="authError"></p>
      <form id="registerForm">
        <section class="auth-form-section auth-form-section--card">
          <h3 class="auth-form-section-title"><span class="auth-section-icon" aria-hidden="true">1</span>ê³„ì • ì •ë³´</h3>
          <div class="auth-form-section-inner">
            <div class="auth-form-block">
              <label for="displayName">ë‹‰ë„¤ì„ (ì˜ë¬¸, ìˆ«ìë§Œ 5~12ì)</label>
              <input type="text" id="displayName" name="displayName" autocomplete="username" placeholder="ì˜ë¬¸Â·ìˆ«ì 5~12ì" minlength="5" maxlength="12" pattern="[a-zA-Z0-9]*" title="ì˜ë¬¸, ìˆ«ìë§Œ 5~12ì">
              <p class="nickname-validation" id="nicknameValidation" aria-live="polite" role="status"></p>
            </div>
            <div class="auth-form-block auth-form-block--password">
              <span class="auth-form-block-title">ë¹„ë°€ë²ˆí˜¸</span>
              <label for="password">ë¡œê·¸ì¸ ë¹„ë°€ë²ˆí˜¸</label>
              <input type="password" id="password" name="password" required autocomplete="new-password" placeholder="8ì ì´ìƒ, ì˜ë¬¸Â·ìˆ«ì í¬í•¨ (íŠ¹ìˆ˜ë¬¸ì ê¶Œì¥)" minlength="8">
              <label for="passwordConfirm">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
              <input type="password" id="passwordConfirm" name="passwordConfirm" required placeholder="ë™ì¼í•˜ê²Œ ì…ë ¥">
              <p class="password-confirm-validation" id="passwordConfirmValidation" aria-live="polite" role="status"></p>
            </div>
          </div>
        </section>
        <section class="auth-form-section auth-form-section--card">
          <h3 class="auth-form-section-title"><span class="auth-section-icon" aria-hidden="true">2</span>ì§€ê°‘ ì£¼ì†Œ</h3>
          <div class="auth-form-section-inner">
            <label for="walletAddress">ë‚´ ìŠ¤í…Œì´í‚¹ ì§€ê°‘ ì£¼ì†Œ (íƒ€ì¸ ì£¼ì†Œ ì‘ì„± ê¸ˆì§€)</label>
            <input type="text" id="walletAddress" name="walletAddress" required autocomplete="off" placeholder="0x... (42ì)" spellcheck="false">
            <p class="wallet-validation" id="walletValidation" aria-live="polite" role="status"></p>
          </div>
        </section>
        <section class="auth-form-section auth-form-section--card">
          <h3 class="auth-form-section-title"><span class="auth-section-icon" aria-hidden="true">3</span>ì¶”ì²œì¸</h3>
          <div class="auth-form-section-inner">
            <label for="referrer">ì¶”ì²œì¸ (ì„ íƒì‚¬í•­)</label>
            <input type="text" id="referrer" name="referrer" autocomplete="off" placeholder="ì„ íƒ ì…ë ¥">
          </div>
        </section>
        <div class="auth-submit-wrap">
          <button type="submit" class="auth-submit-btn">ê°€ì…í•˜ê¸°</button>
        </div>
      </form>
      <p class="auth-link">ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <a href="/login.html">ë¡œê·¸ì¸</a></p>
    </div>
  </div>

  <div id="registerWelcomeLayer" class="register-welcome-layer" style="display:none;">
    <div class="register-welcome-card">
      <div class="register-welcome-icon" aria-hidden="true">âœ¨</div>
      <h2 class="register-welcome-title">ê°€ì…ì„ í™˜ì˜í•©ë‹ˆë‹¤</h2>
      <p class="register-welcome-desc">ê°€ì… ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.<br>ê´€ë¦¬ì ìŠ¹ì¸ í›„ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br><span class="register-welcome-time">(ìµœì†Œ 1ì‹œê°„ ~ ìµœëŒ€ 24ì‹œê°„)</span></p>
      <p class="register-welcome-login"><span class="register-welcome-torn">Torn</span>Fi.com</p>
      <a href="/" id="registerWelcomeBtn" class="register-welcome-btn">í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.0/dist/ethers.umd.min.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/nav-logo.js"></script>
  <script>
    (function () {
      var form = document.getElementById('registerForm');
      var errorEl = document.getElementById('authError');
      var walletInput = document.getElementById('walletAddress');
      var walletValidationEl = document.getElementById('walletValidation');
      var nicknameValidationEl = document.getElementById('nicknameValidation');
      var walletValid = false;
      var walletStakingOk = false;
      var walletStakingPending = false;
      var walletCheckTimer = null;

      var nicknameRegex = /^[a-zA-Z0-9]{5,12}$/;
      var nicknameCheckTimer = null;
      var displayNameInput = document.getElementById('displayName');
      if (displayNameInput) {
        displayNameInput.addEventListener('input', function () {
          var v = this.value.replace(/[^a-zA-Z0-9]/g, '').slice(0, 12);
          if (v !== this.value) this.value = v;
          nicknameValidationEl.textContent = '';
          nicknameValidationEl.classList.remove('wallet-validation--err', 'wallet-validation--ok');
          if (v.length > 0 && v.length < 5) nicknameValidationEl.textContent = 'ë‹‰ë„¤ì„ì€ 5~12ìì…ë‹ˆë‹¤.';
          else if (v.length > 0 && !nicknameRegex.test(v)) nicknameValidationEl.textContent = 'ì˜ë¬¸, ìˆ«ìë§Œ 5~12ì ê°€ëŠ¥í•©ë‹ˆë‹¤.';
          else if (v.length >= 5) {
            if (nicknameCheckTimer) clearTimeout(nicknameCheckTimer);
            nicknameCheckTimer = setTimeout(function () {
              nicknameCheckTimer = null;
              fetch('/api/public/check-nickname?displayName=' + encodeURIComponent(v))
                .then(function (r) { return r.json(); })
                .then(function (data) {
                  if (displayNameInput.value.trim() !== v) return;
                  if (data.available) {
                    nicknameValidationEl.textContent = 'ì‚¬ìš© ê°€ëŠ¥í•œ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.';
                    nicknameValidationEl.classList.remove('wallet-validation--err');
                    nicknameValidationEl.classList.add('wallet-validation--ok');
                  } else {
                    nicknameValidationEl.textContent = data.message || 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.';
                    nicknameValidationEl.classList.remove('wallet-validation--ok');
                    nicknameValidationEl.classList.add('wallet-validation--err');
                  }
                })
                .catch(function () {
                  if (displayNameInput.value.trim() === v) nicknameValidationEl.textContent = '';
                });
            }, 400);
          } else nicknameValidationEl.textContent = '';
        });
        displayNameInput.addEventListener('blur', function () {
          var v = this.value.trim();
          if (!v) { nicknameValidationEl.textContent = ''; nicknameValidationEl.classList.remove('wallet-validation--err', 'wallet-validation--ok'); return; }
          if (!nicknameRegex.test(v)) {
            nicknameValidationEl.textContent = v.length < 5 ? 'ë‹‰ë„¤ì„ì€ 5~12ìì…ë‹ˆë‹¤.' : 'ë‹‰ë„¤ì„ì€ ì˜ë¬¸, ìˆ«ìë§Œ 5~12ìê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.';
            nicknameValidationEl.classList.add('wallet-validation--err');
            nicknameValidationEl.classList.remove('wallet-validation--ok');
          } else {
            fetch('/api/public/check-nickname?displayName=' + encodeURIComponent(v))
              .then(function (r) { return r.json(); })
              .then(function (data) {
                if (displayNameInput.value.trim() !== v) return;
                if (data.available) {
                  nicknameValidationEl.textContent = 'ì‚¬ìš© ê°€ëŠ¥í•œ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.';
                  nicknameValidationEl.classList.remove('wallet-validation--err');
                  nicknameValidationEl.classList.add('wallet-validation--ok');
                } else {
                  nicknameValidationEl.textContent = data.message || 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.';
                  nicknameValidationEl.classList.remove('wallet-validation--ok');
                  nicknameValidationEl.classList.add('wallet-validation--err');
                }
              })
              .catch(function () {});
          }
        });
      }

      var passwordInput = document.getElementById('password');
      var passwordConfirmInput = document.getElementById('passwordConfirm');
      var passwordConfirmValidationEl = document.getElementById('passwordConfirmValidation');
      function checkPasswordMatch() {
        if (!passwordConfirmValidationEl) return;
        var p = passwordInput ? passwordInput.value : '';
        var c = passwordConfirmInput ? passwordConfirmInput.value : '';
        if (c.length === 0) {
          passwordConfirmValidationEl.textContent = '';
          passwordConfirmValidationEl.classList.remove('wallet-validation--err', 'wallet-validation--ok');
          return;
        }
        if (p !== c) {
          passwordConfirmValidationEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
          passwordConfirmValidationEl.classList.remove('wallet-validation--ok');
          passwordConfirmValidationEl.classList.add('wallet-validation--err');
        } else {
          passwordConfirmValidationEl.textContent = 'ì¼ì¹˜í•©ë‹ˆë‹¤.';
          passwordConfirmValidationEl.classList.remove('wallet-validation--err');
          passwordConfirmValidationEl.classList.add('wallet-validation--ok');
        }
      }
      if (passwordInput) passwordInput.addEventListener('input', checkPasswordMatch);
      if (passwordConfirmInput) passwordConfirmInput.addEventListener('input', checkPasswordMatch);

      function sameWalletAddress(a, b) {
        if (!a || !b) return false;
        var na = a.trim().toLowerCase();
        var nb = b.trim().toLowerCase();
        if (na === nb) return true;
        try {
          if (typeof ethers !== 'undefined' && ethers.getAddress) {
            return ethers.getAddress(a) === ethers.getAddress(b);
          }
        } catch (e) {}
        return false;
      }

      function checkStakingAndUpdate(addressForApi) {
        walletStakingOk = false;
        walletValid = false;
        walletStakingPending = true;
        walletValidationEl.classList.remove('wallet-validation--ok', 'wallet-validation--err');
        walletValidationEl.textContent = 'TORN ìŠ¤í…Œì´í‚¹ í™•ì¸ ì¤‘â€¦';
        var timeoutId = setTimeout(function () {
          timeoutId = null;
          if (!walletStakingPending) return;
          var current = walletInput.value.trim();
          if (!sameWalletAddress(current, addressForApi)) return;
          walletStakingPending = false;
          walletValidationEl.textContent = 'í™•ì¸ì´ ì§€ì—°ë˜ê³  ìˆìŠµë‹ˆë‹¤. ì…ë ¥ì°½ ë°–ì„ í´ë¦­í•´ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
          walletValidationEl.classList.add('wallet-validation--err');
        }, 15000);
        fetch('/api/check-staking?walletAddress=' + encodeURIComponent(addressForApi))
          .then(function (r) {
            return r.json().then(function (data) {
              return { ok: r.ok, status: r.status, data: data };
            });
          })
          .then(function (result) {
            if (timeoutId) clearTimeout(timeoutId);
            timeoutId = null;
            walletStakingPending = false;
            var currentAddress = walletInput.value.trim();
            if (!sameWalletAddress(currentAddress, addressForApi)) {
              walletValidationEl.textContent = 'ì£¼ì†Œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ì…ë ¥ì°½ ë°–ì„ í´ë¦­í•˜ë©´ ë‹¤ì‹œ í™•ì¸ë©ë‹ˆë‹¤.';
              walletValidationEl.classList.remove('wallet-validation--ok');
              walletValidationEl.classList.add('wallet-validation--err');
              return;
            }
            var data = result.data;
            if (result.ok && data && data.staking) {
              fetch('/api/public/check-wallet?walletAddress=' + encodeURIComponent(addressForApi))
                .then(function (r) { return r.json(); })
                .then(function (walletData) {
                  var cur = walletInput.value.trim();
                  if (!sameWalletAddress(cur, addressForApi)) return;
                  if (walletData.registered) {
                    walletStakingOk = true;
                    walletValid = false;
                    var msg = walletData.forceWithdrawn ? 'ê°•ì œ íƒˆí‡´ëœ ì§€ê°‘ì€ ì¬ê°€ì…í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìê°€ ì´ë ¥ì—ì„œ ì‚­ì œí•˜ë©´ ì¬ê°€ì…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' : (walletData.withdrawn ? 'íƒˆí‡´í•œ ì§€ê°‘ì€ ì¬ê°€ì…í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' : 'ì´ë¯¸ ê°€ì…ëœ ì§€ê°‘ ì£¼ì†Œì…ë‹ˆë‹¤.');
                    walletValidationEl.textContent = msg;
                    walletValidationEl.classList.remove('wallet-validation--ok');
                    walletValidationEl.classList.add('wallet-validation--err');
                  } else {
                    walletStakingOk = true;
                    walletValid = true;
                    walletValidationEl.textContent = 'ìŠ¤í…Œì´í‚¹ í™•ì¸ ì™„ë£Œ. (ê°€ì… ê°€ëŠ¥)';
                    walletValidationEl.classList.remove('wallet-validation--err');
                    walletValidationEl.classList.add('wallet-validation--ok');
                  }
                })
                .catch(function () {
                  var cur = walletInput.value.trim();
                  if (!sameWalletAddress(cur, addressForApi)) return;
                  walletStakingOk = true;
                  walletValid = true;
                  walletValidationEl.textContent = 'ìŠ¤í…Œì´í‚¹ í™•ì¸ ì™„ë£Œ. (ê°€ì… ê°€ëŠ¥)';
                  walletValidationEl.classList.remove('wallet-validation--err');
                  walletValidationEl.classList.add('wallet-validation--ok');
                });
              return;
            } else if (!result.ok && data && data.message) {
              walletStakingOk = false;
              walletValid = false;
              walletValidationEl.textContent = data.message;
              walletValidationEl.classList.remove('wallet-validation--ok');
              walletValidationEl.classList.add('wallet-validation--err');
            } else {
              walletStakingOk = false;
              walletValid = false;
              walletValidationEl.textContent = 'ì´ ì§€ê°‘ì€ TORN í† í°ì„ ìŠ¤í…Œì´í‚¹í•˜ê³  ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.';
              walletValidationEl.classList.remove('wallet-validation--ok');
              walletValidationEl.classList.add('wallet-validation--err');
            }
          })
          .catch(function (err) {
            if (timeoutId) clearTimeout(timeoutId);
            timeoutId = null;
            walletStakingPending = false;
            var currentAddress = walletInput.value.trim();
            if (!sameWalletAddress(currentAddress, addressForApi)) {
              walletValidationEl.textContent = 'ì£¼ì†Œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ì…ë ¥ì°½ ë°–ì„ í´ë¦­í•˜ë©´ ë‹¤ì‹œ í™•ì¸ë©ë‹ˆë‹¤.';
              walletValidationEl.classList.remove('wallet-validation--ok');
              walletValidationEl.classList.add('wallet-validation--err');
              return;
            }
            walletStakingOk = false;
            walletValid = false;
            walletValidationEl.textContent = 'ìŠ¤í…Œì´í‚¹ í™•ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„œë²„ê°€ ì¼œì ¸ ìˆëŠ”ì§€ í™•ì¸í•˜ê³ , ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
            walletValidationEl.classList.remove('wallet-validation--ok');
            walletValidationEl.classList.add('wallet-validation--err');
          });
      }

      function validateWalletAddress(value) {
        walletValidationEl.classList.remove('wallet-validation--ok', 'wallet-validation--err');
        walletValidationEl.textContent = '';
        walletStakingOk = false;
        walletValid = false;
        if (!value || !value.trim()) {
          return;
        }
        var trimmed = value.trim();
        var normalizedForApi = trimmed;
        try {
          if (typeof ethers !== 'undefined' && ethers.getAddress) {
            normalizedForApi = ethers.getAddress(trimmed);
          }
        } catch (e) { normalizedForApi = trimmed; }
        try {
          if (typeof ethers !== 'undefined' && ethers.getAddress) {
            ethers.getAddress(trimmed);
            checkStakingAndUpdate(normalizedForApi);
            return;
          }
          if (/^0x[a-fA-F0-9]{40}$/.test(trimmed)) {
            checkStakingAndUpdate(normalizedForApi);
            return;
          }
          walletValidationEl.textContent = 'ìœ íš¨í•œ ì´ë”ë¦¬ì›€ ì£¼ì†Œê°€ ì•„ë‹™ë‹ˆë‹¤. (0x + 40ì 16ì§„ìˆ˜)';
          walletValidationEl.classList.add('wallet-validation--err');
        } catch (err) {
          walletValidationEl.textContent = 'ìœ íš¨í•œ ì´ë”ë¦¬ì›€ ì£¼ì†Œê°€ ì•„ë‹™ë‹ˆë‹¤.';
          walletValidationEl.classList.add('wallet-validation--err');
        }
      }

      walletInput.addEventListener('blur', function () {
        if (walletCheckTimer) clearTimeout(walletCheckTimer);
        walletCheckTimer = null;
        validateWalletAddress(walletInput.value);
      });
      walletInput.addEventListener('input', function () {
        var v = walletInput.value.trim();
        if (!v) {
          if (walletCheckTimer) clearTimeout(walletCheckTimer);
          walletCheckTimer = null;
          walletValidationEl.textContent = '';
          walletValidationEl.classList.remove('wallet-validation--ok', 'wallet-validation--err');
          walletValid = false;
          walletStakingOk = false;
          walletStakingPending = false;
          return;
        }
        if (walletCheckTimer) clearTimeout(walletCheckTimer);
        walletValidationEl.textContent = '';
        walletValidationEl.classList.remove('wallet-validation--ok', 'wallet-validation--err');
        if (v.length >= 42) {
          walletCheckTimer = setTimeout(function () {
            walletCheckTimer = null;
            validateWalletAddress(walletInput.value.trim());
          }, 500);
        } else if (v.length > 2 && !/^0x[a-fA-F0-9]{40}$/.test(v)) {
          walletValidationEl.textContent = 'ìœ íš¨í•œ ì´ë”ë¦¬ì›€ ì£¼ì†Œê°€ ì•„ë‹™ë‹ˆë‹¤. (0x + 40ì 16ì§„ìˆ˜)';
          walletValidationEl.classList.add('wallet-validation--err');
        }
      });

      function clearTopError() {
        if (errorEl) errorEl.textContent = '';
      }
      form.addEventListener('input', clearTopError);
      form.addEventListener('change', clearTopError);

      form.addEventListener('submit', function (e) {
        e.preventDefault();
        clearTopError();
        var password = (document.getElementById('password').value || '').trim();
        var passwordConfirm = (document.getElementById('passwordConfirm').value || '').trim();
        if (password !== passwordConfirm) {
          errorEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
          return;
        }
        if (password.length < 8) {
          errorEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
          return;
        }
        if (!/[a-zA-Z]/.test(password) || !/\d/.test(password)) {
          errorEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ëŠ” ì˜ë¬¸ê³¼ ìˆ«ìë¥¼ ëª¨ë‘ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.';
          return;
        }
        var referrer = document.getElementById('referrer').value.trim() || undefined;
        var displayName = document.getElementById('displayName').value.trim() || undefined;
        var walletAddress = document.getElementById('walletAddress').value.trim();
        if (displayName && !nicknameRegex.test(displayName)) {
          errorEl.textContent = 'ë‹‰ë„¤ì„ì€ ì˜ë¬¸, ìˆ«ìë§Œ 5~12ìê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.';
          return;
        }
        if (!walletAddress) {
          errorEl.textContent = 'ì´ë”ë¦¬ì›€ ë©”ì¸ë„· ì§€ê°‘ ì£¼ì†Œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.';
          return;
        }
        var addressToSend = walletAddress;
        try {
          if (typeof ethers !== 'undefined' && ethers.getAddress) {
            addressToSend = ethers.getAddress(walletAddress);
          }
        } catch (err) {}
        window.TornFiAuth.register(addressToSend, password, displayName, referrer)
          .then(function (data) {
            clearTopError();
            if (walletValidationEl) {
              walletValidationEl.classList.remove('wallet-validation--err');
              walletValidationEl.textContent = '';
            }
            var welcomeLayer = document.getElementById('registerWelcomeLayer');
            if (welcomeLayer) welcomeLayer.style.display = 'flex';
          })
          .catch(function (err) {
            var msg = (err && err.message) ? String(err.message) : 'ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
            var isDuplicateWallet = msg.indexOf('ì´ë¯¸ ê°€ì…ëœ ì§€ê°‘') !== -1 || msg.indexOf('íƒˆí‡´í•œ ì§€ê°‘') !== -1 || msg.indexOf('ê°•ì œ íƒˆí‡´ëœ ì§€ê°‘') !== -1;
            var isServerError = msg.indexOf('JSON') !== -1 || msg.indexOf('fetch') !== -1 || msg === 'ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
            if (isDuplicateWallet && walletValidationEl) {
              walletValid = false;
              walletValidationEl.textContent = msg;
              walletValidationEl.classList.remove('wallet-validation--ok');
              walletValidationEl.classList.add('wallet-validation--err');
              errorEl.textContent = '';
            } else {
              errorEl.textContent = isServerError ? 'ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.' : msg;
            }
          });
      });
      window.TornFiAuth.onUser(function (u) {
        var nl = document.getElementById('navLogin');
        var nr = document.getElementById('navRegister');
        var nmu = document.getElementById('navMenuUser');
        var np = document.getElementById('navProfile');
        var nac = document.getElementById('navAdminCenter');
        if (u) {
          if (nl) nl.style.display = 'none'; if (nr) nr.style.display = 'none';
          if (nmu) nmu.style.display = 'block';
          if (np) np.style.display = 'block';
          if (nac) nac.style.display = u.isAdmin ? 'inline-flex' : 'none';
        } else {
          if (nl) nl.style.display = 'block'; if (nr) nr.style.display = 'block';
          if (nmu) nmu.style.display = 'none';
          if (np) np.style.display = 'none';
          if (nac) nac.style.display = 'none';
        }
      });
      var navMenuBtn = document.getElementById('navMenuBtn');
      var navMenuDropdown = document.getElementById('navMenuDropdown');
      if (navMenuBtn && navMenuDropdown) {
        navMenuBtn.addEventListener('click', function (e) { e.stopPropagation(); navMenuDropdown.classList.toggle('is-open'); navMenuBtn.setAttribute('aria-expanded', navMenuDropdown.classList.contains('is-open')); });
        navMenuDropdown.addEventListener('click', function (e) { e.stopPropagation(); });
        document.addEventListener('click', function () { navMenuDropdown.classList.remove('is-open'); navMenuBtn.setAttribute('aria-expanded', 'false'); });
      }
      var navLogout = document.getElementById('navLogout');
      if (navLogout) navLogout.addEventListener('click', function (e) {
        e.preventDefault();
        if (!confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        if (window.TornFiAuth && window.TornFiAuth.logout) window.TornFiAuth.logout().then(function () { window.location.href = '/'; });
      });
    })();
  </script>
</body>
</html>
