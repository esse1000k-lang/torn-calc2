# 토네이도 뉴스 수집 과정 (전체 흐름)

## 개요

관리자가 **「지금 수집」**을 누르면, 등록된 **뉴스 소스(URL)**에서 기사를 가져와 **키워드 필터**를 거친 뒤, **중복·날짜**를 걸러 저장하고, 필요하면 **한글 번역**까지 붙이는 과정입니다.

---

## 1. 소스 준비

- **뉴스 소스**는 `data/tornado-news-sources.json`에 저장됩니다.
- 관리자 **뉴스 소스 · 수집**에서 **소스 추가**(이름 + URL) / **삭제** 가능.
- 기본값: Cointelegraph, Cointelegraph 규제·DeFi, Decrypt, CoinDesk **RSS URL** 5개.
- 수집 시 **enabled: true**인 소스만 사용합니다.

---

## 2. 수집 트리거

- 관리자 페이지에서 **「지금 수집」** 클릭 → `POST /api/tornado-news/fetch` 호출.
- 서버는 **등록된 소스 URL**을 하나씩 순서대로 처리합니다.

---

## 3. 소스별로 본문 가져오기

- 각 소스 URL에 **HTTP GET** 요청 (User-Agent 등 헤더 포함).
- 응답 **Content-Type** 또는 본문 내용으로 **RSS/Atom** 여부 판단:
  - **RSS/Atom**이면 → XML 파싱 (RSS 2.0 `<channel><item>`, Atom `<feed><entry>`).
  - 그 외면 → HTML로 간주하고, **URL 패턴**(예: 코인니스·블루밍비트용 선택자) 또는 **범용 파서**로 링크·제목·요약 추출.

즉, **RSS면 XML에서**, **일반 웹페이지면 HTML에서** 기사 목록을 뽑습니다.

---

## 4. 기사 후보 정리

- 파서가 반환한 항목마다:
  - **제목(title)**, **요약(summary/description)**, **링크(url)**, **출처명**, **기사 날짜(pubDate/updated)** 등을 묶습니다.
- RSS인 경우 **날짜**는 `<pubDate>` / `<updated>` 등에서 파싱해, 나중에 **날짜 필터**에 사용합니다.

---

## 5. 키워드 필터

- **수집 키워드**는 `data/tornado-news-keywords.json`에 저장되며, 관리자 화면에서 **수정·저장** 가능.
- 각 후보 기사에 대해 **제목 + 요약** 합친 텍스트에, 설정된 키워드 중 **하나라도 포함**되면 수집 대상으로 남깁니다.
- 키워드에 하나도 안 걸리면 **그 기사는 버려집니다** (저장 안 함).

→ “프라이버시, 토네이도 캐시, TORN, 해킹, 세탁, mixer, privacy …” 등에 걸리는 기사만 다음 단계로 넘어갑니다.

---

## 6. URL 중복 제거

- 이미 저장된 기사 목록(`data/tornado-news.json`)에 있는 **URL**과 비교합니다.
- **정규화한 URL**(소문자, # 이후 제거)이 이미 있으면 **같은 기사**로 보고, 이번 후보는 **추가하지 않습니다**.

---

## 7. 날짜 필터 (선택)

- 기사에 **날짜가 있고**, 그 날짜가 **2026-02-20 이전**이면 **제외**합니다.
- 날짜가 없거나 2026-02-20 이후면 통과.

---

## 8. 제목(맥락) 중복 제거

- **같은 스토리**인데 **URL은 다른** 경우(여러 소스에서 같은 기사)를 줄이기 위해 **제목 유사도**로 판단합니다.
- **정규화**: 제목을 소문자·영숫자·한글·공백만 남기고, 연속 공백을 하나로, 앞 120자만 사용.
- 두 제목이 아래 중 하나면 **중복**으로 봅니다.
  - 정규화 문자열이 **완전 일치**
  - 한쪽이 다른 쪽에 **포함** (최소 10자 이상)
  - 단어를 나눈 뒤 **Jaccard 유사도 ≥ 0.6**
- **기존 목록**에 이미 “이 제목과 유사한 기사”가 있으면 **이번 후보는 추가하지 않습니다**.

→ 수집 단계에서부터 **URL 중복 + 제목(맥락) 중복**을 함께 막습니다.

---

## 9. 한글 번역 (선택, 새 기사만)

- **새로 추가하는 기사**에 한해서만 번역을 시도합니다.
- **제목이 이미 한글**로 보이면(한글 비율이 일정 이상) 번역하지 않습니다.
- 번역 건수 제한:
  - **DeepL** 사용 시(`DEEPL_AUTH_KEY` 설정): 수집 1회당 최대 **10건**.
  - **MyMemory** 사용 시(키 없음, 가입 없음): 수집 1회당 최대 **5건**.
- **제목** → `titleKo`, **요약** → 앞 2문장만 잘라 `summaryKo`로 저장.
- 요약에 **HTML 태그**가 있으면 번역·저장 전에 **태그 제거** 후 넘깁니다.

---

## 10. 저장

- 통과한 기사는 **제목, 요약, URL, 출처명, 출처 URL, 생성일시, 수동 여부**와, 번역했으면 **titleKo, summaryKo**까지 넣어서 `data/tornado-news.json`의 **목록 앞쪽**에 추가합니다.
- 목록은 **최대 500건**만 유지하고, 넘으면 오래된 것부터 잘라냅니다.

---

## 11. 기존 기사 보강 (관리자 선택)

- **기존 기사 한글 번역**: 이미 저장된 기사 중 `titleKo`가 없는 것만 골라 **한 번에 최대 20건** 번역해 저장.
- **중복 기사 제거**: 전체 목록을 **제목(및 한글 제목) 유사도**로 그룹 짓고, **그룹당 1건**(가장 오래된 것)만 남기고 나머지 삭제.

둘 다 관리자 **뉴스 소스 · 수집** 화면에서 버튼으로 실행합니다.

---

## 12. 화면에 보여주기

- **토네이도 뉴스** 페이지(`/tornado-news.html`)에서 `GET /api/tornado-news`로 목록을 가져옵니다.
- 각 기사는 **한글이 있으면 한글 우선** 표시:
  - 제목: `titleKo` 없으면 `title`
  - 요약: `summaryKo` 없으면 `summary`
- 요약 텍스트에서 **HTML 태그**는 제거한 뒤 보여줍니다.

---

## 자동 수집 (스케줄)

- **서버 기동 2분 후** 첫 수집 1회 실행, 이후 **6시간마다** 자동 실행 (환경 변수 `TORNADO_NEWS_FETCH_INTERVAL_MS`로 변경 가능).
- 한 번 실행될 때마다: **수집** → (추가 있으면) **자동 중복 제거** → **번역 없는 기사 최대 20건 한글 번역**.
- 관리자는 「지금 수집」「중복 기사 제거」「기존 기사 한글 번역」 버튼으로 수동 실행도 가능.

## 관리자: 기사 삭제

- **뉴스 소스 · 수집** 패널의 **뉴스 기사 관리** 테이블에서 저장된 기사 목록(최근 50건)을 보고, **삭제** 버튼으로 개별 삭제 가능.
- `DELETE /api/tornado-news/:id` (관리자)로 삭제되며, 삭제 후 목록은 자동 새로고침.

---

## 요약 흐름도

```
[소스 URL 목록] 
    → 소스마다 HTTP GET 
    → RSS면 XML 파싱 / 아니면 HTML 파싱 
    → (제목, 요약, URL, 날짜, 출처) 후보 목록
    → 키워드 필터 (키워드에 하나라도 걸려야 함)
    → URL 중복 제거 (이미 있는 URL이면 스킵)
    → 날짜 필터 (2026-02-20 이전이면 스킵)
    → 제목 유사도 중복 제거 (같은 기사로 보이면 스킵)
    → 새 기사만 일부(5~10건) 한글 번역 (titleKo, summaryKo)
    → tornado-news.json 앞에 추가 (최대 500건 유지)
    → 화면에서는 한글 있으면 한글 제목·요약 표시
```

이게 지금까지 만든 **뉴스 긁어오는 과정** 전체입니다.
