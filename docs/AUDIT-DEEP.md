# TornFi 커뮤니티 — 심층 점검 결과

점검일: 2025년 기준 코드베이스  
범위: 보안, 성능, 에러 처리, 검증 일관성, 의존성, 접근성

---

## 1. 보안

### 1.1 잘 되어 있는 부분
- **세션 쿠키**: `httpOnly`, `signed`, `sameSite: 'lax'`, production에서 `secure` 사용.
- **보안 헤더**: `X-Content-Type-Options: nosniff`, `X-Frame-Options: SAMEORIGIN`, `X-XSS-Protection`, production에서 `Strict-Transport-Security`.
- **관리자 PIN**: 5회 실패 시 15분 잠금(IP 기준).
- **비밀번호**: bcrypt 해시, 8자 이상·영문·숫자 필수.
- **이더리움 주소**: `getAddress()`(ethers)로 정규화·검증.

### 1.2 개선 권장
| 항목 | 내용 | 권장 조치 |
|------|------|------------|
| **관리자 PIN 기본값** | `admin-pin.json` 없을 때 `000000`으로 초기화됨 (`lib/db.js`). | 최초 설정 시 강제 변경 유도 또는 환경변수로 초기 PIN 설정. |
| **로그인/회원가입 Rate Limit** | 전역 또는 로그인/가입 경로에 rate limit 없음. | `express-rate-limit` 등으로 로그인·가입·비밀번호 재시도 제한. |
| **CSRF** | API가 JSON + 쿠키 기반 세션. 동일 사이트 요청 전제면 위험은 낮으나, 명시적 CSRF 토큰은 없음. | 필요 시 중요 변경 작업에 CSRF 토큰 또는 SameSite 강화 검토. |
| **세션 저장소** | 메모리(`sessions` Map). 재시작 시 전부 무효화. | 다중 인스턴스·재시작 대비 시 Redis 등 외부 세션 저장소 검토. |

### 1.3 XSS
- **대부분 이스케이프 적용**: 채팅(`chat.js`), 피드(`index.html`, `feed-post.js`), 가이드(`board.html`), 랭킹·출석·관리자 등에서 `escapeHtml` 또는 `textContent` 사용.
- **피드 본문** (`feed-post.js`): `p.body`에 대해 `<`, `>`만 `&lt;`, `&gt;`로 치환. `"`, `'`, `&`는 미처리. 일반 텍스트 노드에서는 위험 낮으나, 전체 이스케이프와 통일하면 더 안전함.

---

## 2. 성능

### 2.1 DB/파일 읽기
- **`db.readUsers()`** 호출이 매우 많음(인증·회원 조회·관리자·채팅·피드 등 거의 매 요청).
- **파일 모드** (`lib/db.js`): `readFileSync`/`writeFileSync` 사용 → 동기 I/O로 이벤트 루프 블로킹 가능.
- **권장**:  
  - 파일 모드에서도 `fs.promises` 등 비동기 읽기/쓰기로 전환 검토.  
  - 자주 바뀌지 않는 데이터(예: 설정)는 짧은 TTL 메모리 캐시 고려.

### 2.2 RPC/외부 호출
- **스테이킹 랭킹** (`/api/ranking/staking`): 2분 캐시 있음. 캐시 미스 시 회원 수만큼 `checkTornStaking` RPC 호출(5명 단위 배치). 회원 많을수록 첫 로딩 지연.
- **회원가입 시** Etherscan·RPC 호출: 지갑 만 3일·스테이킹·연쇄 송금 검사로 다수 호출. 필요 로직이지만 타임아웃·재시도 정책 있음.

### 2.3 기타
- **MongoDB** 사용 시 `mongoose`만 로드되고, 파일 모드에서는 로드 안 됨. `package.json`에는 항상 의존성으로 있음 → 파일 전용 배포 시 optional로 두거나 그대로 두고 무시 가능.

---

## 3. 에러 처리·검증

### 3.1 글로벌 에러 핸들러
- **Express 4-인자 미들웨어 없음**: `app.use((err, req, res, next) => { ... })` 같은 글로벌 에러 핸들러가 없음.
- **영향**: 라우트/미들웨어에서 `next(e)` 호출 시, 기본 Express 동작에 의존. 프로덕션에서 스택 노출·일관된 JSON 응답 부재 가능.
- **권장**: 최상단에 `app.use((err, req, res, next) => { res.status(500).json({ ok: false, message: '서버 오류가 발생했습니다.' }); })` 형태로 통일 응답 처리.

### 3.2 입력 검증
- **회원가입/로그인/채팅/피드** 등: `String().trim()`, `slice(0, N)`, 정규식 등으로 길이·형식 제한 대부분 적용.
- **일관성**: 일부 라우트는 `req.body?.field`만 검사. 필수 필드는 명시적으로 존재·타입 검사 후 400 반환하면 유지보수에 유리.

---

## 4. 의존성

- **package.json**: `mongoose`, `cheerio`, `bcryptjs`, `cookie-parser`, `ethers`, `express`, `multer` 등.
- **mongoose**: `MONGODB_URI` 없으면 사용하지 않음. 파일 전용 배포 시에도 설치됨.
- **권장**: `npm audit` 정기 실행, 보안 경고 해결. 필요 시 mongoose를 optional dependency로 표시하거나 문서에 “파일 모드에서는 사용 안 함” 명시.

---

## 5. 접근성·기타

- **접근성**: 네비게이션에 `aria-label`, `aria-expanded` 등 일부 사용. 폼 라벨·에러 메시지 `aria-live` 등은 register 등에서 사용.
- **중복 코드**: `chat.js`와 `chat-page.js`가 비슷한 구조. 장기적으로 공통 모듈로 묶으면 유지보수에 유리.
- **TODO/FIXME**: 코드 내 “제거됨”, “비활성화” 등 주석 있음. 정리된 부분은 그대로 두고, 추가 제거 예정이 있으면 이슈로 관리 권장.

---

## 6. 요약 체크리스트

| 구분 | 상태 | 비고 |
|------|------|------|
| 세션·쿠키 보안 | ✅ | httpOnly, signed, sameSite, secure(prod) |
| 관리자 PIN 기본값 | ⚠️ | 000000 초기값 변경 권장 |
| 로그인/가입 Rate Limit | ❌ | 미적용, 도입 권장 |
| XSS 대응 | ✅ 대부분 | 피드 본문은 부분 이스케이프 |
| 글로벌 에러 핸들러 | ❌ | 500 통일 응답 권장 |
| DB 동기 I/O(파일) | ⚠️ | 비동기 전환·캐시 검토 |
| 스테이킹 랭킹 | ✅ | 2분 캐시 있음 |
| 입력 검증 | ✅ | 전반적으로 적용 |

---

이 문서는 점검 시점의 코드 기준이며, 배포 환경·운영 정책에 따라 우선순위를 조정해 적용하면 됩니다.

---

## 7. 종합 평가

### 7.1 총평

| 항목 | 점수 | 요약 |
|------|------|------|
| **보안** | 7.5/10 | 세션·헤더·비밀번호·주소 검증은 잘 갖춰짐. Rate Limit·PIN 기본값·세션 저장소 보완 시 9점대 가능. |
| **성능** | 6.5/10 | 랭킹 캐시·RPC 배치 등 일부 최적화 있음. 파일 동기 I/O·readUsers 다수 호출은 트래픽 증가 시 병목 가능. |
| **안정성·에러 처리** | 7/10 | 입력 검증·길이 제한은 전반 적용. 글로벌 에러 핸들러 추가로 500 응답은 정리됨. 비동기 예외 누락 가능성은 여전히 있음. |
| **유지보수성** | 6/10 | 서버 단일 파일·DB 레이어 분리·라우트 구조는 파악 가능. 주석·일관된 패턴·테스트 부재로 신규 인수인계 시 부담. |
| **기능 완성도** | 8/10 | 가입·로그인·가이드·피드·채팅·출석·랭킹·상점·관리자·스테이킹 검증 등 요구 기능이 구현되어 있음. |
| **일관성** | 7/10 | API 응답 형식(ok, message), 클라이언트 escapeHtml 사용은 어느 정도 통일. 예외·문구는 라우트마다 다소 차이. |

**종합: B+ (약 7/10)**  
소규모 커뮤니티·MVP 수준으로는 **실서비스 가능한 수준**이다. 트래픽·회원이 크게 늘거나 규제·컴플라이언스를 요구하기 전까지는, 문서에 적힌 개선 항목을 단계적으로 적용해 가면 충분히 유지·확장 가능하다.

---

### 7.2 강점

- **역할이 분리됨**: DB(`lib/db.js`)는 파일/Mongo 전환 가능한 인터페이스로 분리되어 있어, 저장소만 바꿔도 서버 로직 대부분 재사용 가능.
- **도메인 로직이 명확함**: 지갑 검증·스테이킹·이중 가입 방지(3일·연쇄 송금) 등 비즈니스 규칙이 코드에 드러나 있어, 요구사항 추적이 수월함.
- **프론트 보안 의식**: 사용자 입력을 DOM에 넣는 구간 대부분에서 이스케이프·`textContent` 사용으로 XSS 위험이 낮음.
- **운영 고려**: 관리자 PIN 잠금, production 시 `secure` 쿠키·HSTS 등 환경별 보안 설정이 반영되어 있음.

---

### 7.3 약점·리스크

- **단일 서버 파일**: `server.js` 한 파일에 라우트·미들웨어·스케줄·비즈니스 로직이 함께 있어, 기능이 더 늘어나면 분할(라우터·서비스 레이어)이 필요해짐.
- **테스트 부재**: 단위·통합 테스트가 없어 리팩터링·의존성 업그레이드 시 회귀 위험을 코드만으로는 검증하기 어렵다.
- **동기 파일 I/O**: JSON 파일 모드에서 `readFileSync`/`writeFileSync` 사용으로, 대량 요청 시 지연·블로킹 가능성이 있음.
- **세션 메모리 저장**: 재시작 시 전부 로그아웃, 다중 인스턴스 시 세션 공유 불가. 규모 확장 시 Redis 등 외부 저장소가 필요해짐.

---

### 7.4 적합한 용도

- ✅ 소규모 커뮤니티(동시 접속·회원 수 수백 단위)
- ✅ 토네이도 캐시/스테이킹 관련 정보·가이드·소통 플랫폼
- ✅ MVP 또는 1차 오픈 후 피드백 반영 단계
- ⚠️ 대규모 트래픽·다중 서버·엄격한 규제 대응이 필요해지면, 캐시·세션·DB·테스트·모니터링 보강 후 재평가하는 것이 좋음.
