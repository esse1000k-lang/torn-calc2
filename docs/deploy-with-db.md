# DB 사용 시 웹 배포 가이드

이제 DB가 있으므로 **데이터가 서버/클라우드에 영구 저장**됩니다. 아래 순서와 보안 사항을 반드시 지킨 뒤 배포하세요.

---

## 1. 배포 전 반드시 확인할 것

### 1.1 Git에 올리면 안 되는 것 (이미 .gitignore에 있음)

| 대상 | 설명 |
|------|------|
| `.env` | 세션 비밀키, DB 비밀번호 등 **절대 커밋 금지** |
| `data/` | 회원, 게시글, 채팅, 설정, 관리자 PIN 등 **전체 폴더 제외** |
| `public/uploads/` | 프로필·채팅·피드 이미지 **제외** |

- 배포 시 **코드만** Git으로 올리고, `.env`와 `data/`는 서버에서 따로 설정/생성합니다.
- **한 번이라도 `.env`나 `data/`를 커밋했다면** 비밀번호·DB 주소를 모두 바꾸고, 레포에서 해당 파일 이력 제거를 검토하세요.

### 1.2 프로덕션 필수 환경 변수

서버(또는 호스팅)의 **환경 변수**에 아래를 설정합니다. (로컬 `.env`는 Git에 올리지 않음.)

| 변수 | 필수 | 설명 |
|------|------|------|
| `NODE_ENV` | ✅ | `production` 으로 설정 |
| `SESSION_SECRET` | ✅ | **32자 이상** 랜덤 문자열 (미설정 시 프로덕션에서 서버가 종료됨) |
| `MONGODB_URI` | ✅ (DB 사용 시) | MongoDB 연결 문자열 (Atlas 등). **비밀번호에 특수문자 있으면 URL 인코딩** |

- `SESSION_SECRET` 예: `openssl rand -hex 32` 로 생성한 값 사용 권장.
- `MONGODB_URI` 설정 시 **파일이 아닌 MongoDB**에 저장됩니다. 미설정 시 `data/*.json` 사용(서버 재배포 시 데이터 덮어쓰기 주의).

### 1.3 보안 관련

- **HTTPS** 사용 (실제 도메인 배포 시 Let's Encrypt 등).
- **관리자 계정**: 배포 후 서버에서 `node scripts/create-admin-account.js` 로 **admin109** 계정 생성 (한 번만).
- **관리자 PIN**: 관리자 페이지에서 6자리 PIN 설정 후, 주기적으로 변경 권장.
- **관리자 비밀번호**: admin109 계정은 배포 후 **프로필에서 비밀번호 변경**(영문+숫자 조합) 권장.

---

## 2. DB 선택: 파일 vs MongoDB

| 방식 | 설정 | 주의점 |
|------|------|--------|
| **파일 (data/*.json)** | `MONGODB_URI` **미설정** | 서버 재배포·폴더 덮어쓰기 시 **데이터 유실** 가능. `data/` 백업 필수. |
| **MongoDB** | `MONGODB_URI` **설정** | 재배포해도 데이터 유지. **권장.** |

- **MongoDB 사용 시**: [docs/mongodb-setup.md](./mongodb-setup.md) 참고해 Atlas에서 클러스터 생성 후 연결 문자열을 `.env`에 넣습니다.
- **파일 사용 시**: 서버에 `data/` 폴더를 만들고, 앱이 쓸 수 있도록 쓰기 권한을 줍니다. 배포 스크립트가 `data/`를 지우거나 덮어쓰지 않도록 주의하세요.

---

## 3. 배포 절차 (요약)

1. **코드 배포**  
   - Git push 등으로 **소스만** 서버/호스팅에 반영. `.env`, `data/`, `public/uploads/`는 포함하지 않음.

2. **서버에서 환경 변수 설정**  
   - `NODE_ENV=production`  
   - `SESSION_SECRET=...(32자 이상)`  
   - `MONGODB_URI=...(MongoDB 쓸 때만)`  
   - 호스팅에 따라 “Environment variables” 또는 서버의 `.env` 파일에 설정.

3. **의존성 설치**  
   - `npm install --production` (프로덕션만 필요 시).

4. **DB/데이터 준비**  
   - **MongoDB**: 위에서 설정한 `MONGODB_URI`만 있으면 앱이 자동으로 컬렉션 생성·사용.  
   - **파일**: 서버에 `data/` 디렉터리 생성, 앱 실행 사용자에게 읽기/쓰기 권한 부여.

5. **관리자 계정 생성 (최초 1회)**  
   - 서버 프로젝트 루트에서:  
     `node scripts/create-admin-account.js`  
   - admin109 / 111111 로 로그인 가능. 로그인 후 **비밀번호 변경** 권장.

6. **업로드 디렉터리**  
   - `public/uploads/` (및 하위 `profile/`, `chat/` 등) 가 없으면 생성, 앱이 쓰기 가능하도록 권한 설정.

7. **서버 실행**  
   - `npm start` (또는 호스팅에서 지정한 start 명령).  
   - 포트는 `PORT` 환경 변수 또는 호스팅 기본값 사용.

8. **HTTPS**  
   - 실제 도메인 사용 시 역방향 프록시(Nginx 등)에서 HTTPS 처리하거나, 호스팅의 HTTPS 옵션 사용.

---

## 4. 배포 후 확인

- [ ] `https://도메인` 으로 접속 가능한지.
- [ ] **admin109** 로 로그인 후 관리자 메뉴(🛠️) 노출·동작 여부.
- [ ] **TornFi** 등 일반 계정으로 로그인 시 관리자 메뉴가 안 보이는지.
- [ ] 회원가입·로그인·피드·채팅 등 주요 기능 동작 여부.
- [ ] 프로필 사진·채팅 이미지 업로드 시 `public/uploads/` 에 파일이 쌓이는지.

---

## 5. 백업·복구

- **MongoDB**: Atlas 백업 기능 또는 `mongodump` 로 정기 백업. 백업 파일은 **암호화**해서 보관 권장.
- **파일(data/)** 사용 시: `data/` 폴더 전체를 정기적으로 백업하고, 같은 방식으로 암호화 보관.
- **업로드 파일**: `public/uploads/` 도 정기 백업 시 함께 두면 복구 시 편합니다.

---

## 6. 문제 발생 시

- **로그인 안 됨**: `SESSION_SECRET` 이 배포 환경에 제대로 설정되었는지, 쿠키 도메인/경로가 맞는지 확인.
- **데이터가 안 남음**: `MONGODB_URI` 가 설정되었는지, MongoDB 연결 오류 로그가 없는지 확인. (파일 모드면 `data/` 권한·경로 확인.)
- **관리자 메뉴 안 보임**: admin109 로 로그인했는지, 해당 계정에 `boardAdmin: true` 가 DB/파일에 들어가 있는지 확인. 필요 시 스크립트 다시 실행.

자세한 보안 항목은 [docs/security.md](./security.md) 를 참고하세요.
